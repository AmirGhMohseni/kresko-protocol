<!doctype html>
<html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Mochawesome Report</title><link rel="stylesheet" href="assets/app.css"/></head><body data-raw="{&quot;stats&quot;:{&quot;suites&quot;:80,&quot;tests&quot;:244,&quot;passes&quot;:241,&quot;pending&quot;:3,&quot;failures&quot;:0,&quot;start&quot;:&quot;2022-11-30T14:11:01.134Z&quot;,&quot;end&quot;:&quot;2022-11-30T14:14:52.031Z&quot;,&quot;duration&quot;:230897,&quot;testsRegistered&quot;:244,&quot;passPercent&quot;:100,&quot;pendingPercent&quot;:1.2295081967213115,&quot;other&quot;:0,&quot;hasOther&quot;:false,&quot;skipped&quot;:0,&quot;hasSkipped&quot;:false},&quot;results&quot;:[{&quot;uuid&quot;:&quot;29e33289-dadf-4c95-ba6e-123ac4a73907&quot;,&quot;title&quot;:&quot;&quot;,&quot;fullFile&quot;:&quot;&quot;,&quot;file&quot;:&quot;&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;ee0c764e-0461-4754-b5aa-5b982d5e4dbe&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/diamond/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before all\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1593,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;users = await hardhat_1.default.getUsers();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3df36a7c-db04-4480-82ac-bd3549a2b4c0&quot;,&quot;parentUUID&quot;:&quot;ee0c764e-0461-4754-b5aa-5b982d5e4dbe&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before all\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;45ef87fb-993e-4375-96b7-d4d40b28f222&quot;,&quot;parentUUID&quot;:&quot;ee0c764e-0461-4754-b5aa-5b982d5e4dbe&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:27,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;29ac2847-5463-4973-9b35-0b91667e9c06&quot;,&quot;parentUUID&quot;:&quot;ee0c764e-0461-4754-b5aa-5b982d5e4dbe&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;fe02ece4-56eb-4003-ada7-f0763689898c&quot;,&quot;title&quot;:&quot;#initialization&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/diamond/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await hardhat_1.default.Diamond.owner()).to.equal(users.deployer.address);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.initialized()).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0abc355a-f983-4f98-a030-54bebe605458&quot;,&quot;parentUUID&quot;:&quot;fe02ece4-56eb-4003-ada7-f0763689898c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets standard facet addresses&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets standard facet addresses&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:19,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetAddressesOnChain = (await hardhat_1.default.Diamond.facets()).map(f =&gt; f.facetAddress);\nconst facetAddressesArtifact = this.facets.map(f =&gt; f.facetAddress);\n(0, chai_1.expect)(facetAddressesOnChain.length).to.equal(facetAddressesArtifact.length);\n(0, chai_1.expect)(facetAddressesOnChain).to.have.members(facetAddressesArtifact);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7e37e97d-9d6a-4a75-bc0c-9151444a744f&quot;,&quot;parentUUID&quot;:&quot;fe02ece4-56eb-4003-ada7-f0763689898c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets selectors of standard facets&quot;,&quot;fullTitle&quot;:&quot;Diamond #initialization sets selectors of standard facets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetsSelectorsOnChain = (await hardhat_1.default.Diamond.facets()).flatMap(f =&gt; f.functionSelectors);\nconst facetSelectorsOnArtifact = this.facets.flatMap(f =&gt; f.functionSelectors);\n(0, chai_1.expect)(facetsSelectorsOnChain.length).to.equal(facetSelectorsOnArtifact.length);\n(0, chai_1.expect)(facetsSelectorsOnChain).to.have.members(facetSelectorsOnArtifact);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;af87a477-f209-4671-b73f-7a3c6fa1853f&quot;,&quot;parentUUID&quot;:&quot;fe02ece4-56eb-4003-ada7-f0763689898c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;0abc355a-f983-4f98-a030-54bebe605458&quot;,&quot;7e37e97d-9d6a-4a75-bc0c-9151444a744f&quot;,&quot;af87a477-f209-4671-b73f-7a3c6fa1853f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:45,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;5756a633-e2d5-4fab-9d34-a63b688afe30&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/diamond/01-ownership.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/01-ownership.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before all\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;addr = await hardhat_1.default.getAddresses();\nusers = await hardhat_1.default.getUsers();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;71b3538d-8b52-4bd7-91d5-c7b91edad7d2&quot;,&quot;parentUUID&quot;:&quot;5756a633-e2d5-4fab-9d34-a63b688afe30&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before all\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ca82a664-64e3-4640-9381-ad63947e10f5&quot;,&quot;parentUUID&quot;:&quot;5756a633-e2d5-4fab-9d34-a63b688afe30&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;171bdadc-a016-4402-b669-af5d353b6068&quot;,&quot;parentUUID&quot;:&quot;5756a633-e2d5-4fab-9d34-a63b688afe30&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;501334d3-c18c-4472-bf3d-ca5179aa6fd2&quot;,&quot;title&quot;:&quot;#ownership&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/diamond/01-ownership.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/01-ownership.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets correct owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await hardhat_1.default.Diamond.owner()).to.equal(addr.deployer);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;371923c4-3dda-4e3e-96eb-3a8588cd9ace&quot;,&quot;parentUUID&quot;:&quot;501334d3-c18c-4472-bf3d-ca5179aa6fd2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct default admin role&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets correct default admin role&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await hardhat_1.default.Diamond.hasRole(test_1.Role.ADMIN, addr.deployer)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;85e385a8-d3f2-4629-b67c-bbbeb7e016a0&quot;,&quot;parentUUID&quot;:&quot;501334d3-c18c-4472-bf3d-ca5179aa6fd2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets a new pending owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets a new pending owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:10,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const pendingOwner = users.userOne;\nawait hardhat_1.default.Diamond.transferOwnership(pendingOwner.address);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.pendingOwner()).to.equal(pendingOwner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;95a07d56-3d20-4f31-8172-0201eda637f9&quot;,&quot;parentUUID&quot;:&quot;501334d3-c18c-4472-bf3d-ca5179aa6fd2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets the pending owner as new owner&quot;,&quot;fullTitle&quot;:&quot;Diamond #ownership sets the pending owner as new owner&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const pendingOwner = users.userOne;\nawait hardhat_1.default.Diamond.transferOwnership(pendingOwner.address);\nawait hardhat_1.default.Diamond.connect(pendingOwner).acceptOwnership();\n(0, chai_1.expect)(await hardhat_1.default.Diamond.owner()).to.equal(pendingOwner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;aaf0be1a-d663-49b9-99b1-17f03058da2b&quot;,&quot;parentUUID&quot;:&quot;501334d3-c18c-4472-bf3d-ca5179aa6fd2&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;371923c4-3dda-4e3e-96eb-3a8588cd9ace&quot;,&quot;85e385a8-d3f2-4629-b67c-bbbeb7e016a0&quot;,&quot;95a07d56-3d20-4f31-8172-0201eda637f9&quot;,&quot;aaf0be1a-d663-49b9-99b1-17f03058da2b&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:37,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;59ba9f07-2504-4bae-92a1-f98cff292888&quot;,&quot;title&quot;:&quot;Diamond&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/diamond/02-upgrades.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/02-upgrades.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before all\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;addr = await hardhat_1.default.getAddresses();\nusers = await hardhat_1.default.getUsers();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;16185e35-ee10-4d1e-b37a-8d7ad79a5541&quot;,&quot;parentUUID&quot;:&quot;59ba9f07-2504-4bae-92a1-f98cff292888&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before all\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;53e57604-fc34-4ebb-90b6-57eb8d98517e&quot;,&quot;parentUUID&quot;:&quot;59ba9f07-2504-4bae-92a1-f98cff292888&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;fullTitle&quot;:&quot;Diamond \&quot;before each\&quot; hook in \&quot;Diamond\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:27,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;48c940c5-6520-48ea-93e2-a605ae81d986&quot;,&quot;parentUUID&quot;:&quot;59ba9f07-2504-4bae-92a1-f98cff292888&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;662e6bca-f92c-45d8-b7e5-17e68bd3099f&quot;,&quot;title&quot;:&quot;#upgrades&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/diamond/02-upgrades.ts&quot;,&quot;file&quot;:&quot;/src/test/diamond/02-upgrades.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can add a new facet&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can add a new facet&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:978,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Factory = await smock_1.smock.mock(\&quot;SmockFacet\&quot;);\nconst SmockFacet = await Factory.deploy();\nconst [SmockInitializer] = await hardhat_1.default.deploy(\&quot;SmockInit\&quot;);\nconst signatures = hardhat_1.default.getSignatures(types_2.SmockFacet__factory.abi);\nconst Cut = {\n    facetAddress: SmockFacet.address,\n    functionSelectors: signatures,\n    action: types_1.FacetCutAction.Add,\n};\nconst initData = await SmockInitializer.populateTransaction.initialize(addr.userOne);\nawait hardhat_1.default.Diamond.diamondCut([Cut], initData.to, initData.data);\nconst TEST_OPERATOR_ROLE = hardhat_1.default.ethers.utils.id(\&quot;kresko.test.operator\&quot;);\nconst isTestOperator = await hardhat_1.default.Diamond.hasRole(TEST_OPERATOR_ROLE, addr.userOne);\n// Succesfully added the new operator through the initialization contract\n(0, chai_1.expect)(isTestOperator).to.equal(true);\nconst Facet = await hardhat_1.default.ethers.getContractAt(types_2.SmockFacet__factory.abi, hardhat_1.default.Diamond.address);\n// Ensure facet has it&#x27;s own storage\nconst operatorFromNewStorage = await Facet.operator(); // Retrieved from SmockStorage\n(0, chai_1.expect)(operatorFromNewStorage).to.equal(addr.userOne);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c5072c14-2d97-43f1-bd1c-07de95557a11&quot;,&quot;parentUUID&quot;:&quot;662e6bca-f92c-45d8-b7e5-17e68bd3099f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can remove a facet&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can remove a facet&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:337,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const NewFacet = await (0, add_facet_1.addFacet)({\n    name: \&quot;SmockFacet\&quot;,\n    initializerName: \&quot;SmockInit\&quot;,\n    initializerArgs: addr.userOne,\n});\nconst facetsBefore = await hardhat_1.default.Diamond.facets();\n(0, chai_1.expect)(facetsBefore.filter(f =&gt; f.facetAddress === NewFacet.address).length).to.equal(1);\nawait (0, remove_facet_1.removeFacet)({ name: \&quot;SmockFacet\&quot; });\nconst facetsAfter = await hardhat_1.default.Diamond.facets();\n(0, chai_1.expect)(facetsBefore.length - facetsAfter.length).to.equal(1);\n(0, chai_1.expect)(facetsAfter).to.not.deep.contain(NewFacet.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c0bb1e37-3adf-49ce-8df9-76cec2c888d9&quot;,&quot;parentUUID&quot;:&quot;662e6bca-f92c-45d8-b7e5-17e68bd3099f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can remove a function&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can remove a function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:52,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Delete acceptOwnership from DiamondOwnershipFacet\n// Check there is no pending owner\nlet pendingOwner = await hardhat_1.default.Diamond.pendingOwner();\n(0, chai_1.expect)(pendingOwner).to.equal(addr.ZERO);\n// Transfer to eg. wrong address\nconst wrongOwner = addr.nonadmin;\nawait hardhat_1.default.Diamond.transferOwnership(wrongOwner);\n// Ensure\npendingOwner = await hardhat_1.default.Diamond.pendingOwner();\n(0, chai_1.expect)(pendingOwner).to.equal(wrongOwner);\n// Fragment and signature for acceptOwnersip\nconst functionFragment = hardhat_1.default.Diamond.interface.functions[\&quot;acceptOwnership()\&quot;];\nconst signature = hardhat_1.default.ethers.utils.Interface.getSighash(functionFragment);\nconst facetAddress = await hardhat_1.default.Diamond.facetAddress(signature);\nconst functions = await hardhat_1.default.Diamond.facetFunctionSelectors(facetAddress);\nconst Cut = {\n    facetAddress: addr.ZERO,\n    action: types_1.FacetCutAction.Remove,\n    functionSelectors: [signature],\n};\n// We will set a correct owner with delegatecall into the Diamond itself with the cut transaction\nconst correctOwner = addr.userOne;\nconst initData = await hardhat_1.default.Diamond.populateTransaction.transferOwnership(correctOwner);\nconst tx = await hardhat_1.default.Diamond.diamondCut([Cut], initData.to, initData.data);\nawait tx.wait();\n// Ensure rest of the functions remain\nconst functionsAfterCut = await hardhat_1.default.Diamond.facetFunctionSelectors(facetAddress);\n(0, chai_1.expect)(functionsAfterCut.length).to.equal(functions.length - 1);\n// Ensure delegatecall did set the correct pending owner with the cut\nconst filter = hardhat_1.default.Diamond.filters[\&quot;PendingOwnershipTransfer(address,address)\&quot;](addr.deployer, correctOwner);\nconst [event] = await hardhat_1.default.Diamond.queryFilter(filter);\nconst { previousOwner, newOwner } = event.args;\n(0, chai_1.expect)(previousOwner).to.equal(addr.deployer);\n(0, chai_1.expect)(newOwner).to.equal(correctOwner);\n// Ensure there is no function to accept the ownership\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.nonadmin).acceptOwnership()).to.be.revertedWith(test_1.Error.DIAMOND_INVALID_FUNCTION_SIGNATURE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;34040b63-64d2-4782-a4ef-24f2dd5147b6&quot;,&quot;parentUUID&quot;:&quot;662e6bca-f92c-45d8-b7e5-17e68bd3099f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can replace a function&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can replace a function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:109,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Same as above but instead replace the function\n// Check there is no pending owner\nlet pendingOwner = await hardhat_1.default.Diamond.pendingOwner();\n(0, chai_1.expect)(pendingOwner).to.equal(addr.ZERO);\n// Transfer to eg. wrong address\nconst wrongOwner = addr.nonadmin;\nawait hardhat_1.default.Diamond.transferOwnership(wrongOwner);\n// Ensure\npendingOwner = await hardhat_1.default.Diamond.pendingOwner();\n(0, chai_1.expect)(pendingOwner).to.equal(wrongOwner);\n// Fragment and signature for acceptOwnersip\nconst functionFragment = hardhat_1.default.Diamond.interface.functions[\&quot;acceptOwnership()\&quot;];\nconst signature = hardhat_1.default.ethers.utils.Interface.getSighash(functionFragment);\nconst OldOwnershipFacet = await hardhat_1.default.Diamond.facetAddress(signature);\nconst [NewOwnershipFacet, allOwnershipFacetSignatures] = await hardhat_1.default.deploy(\&quot;DiamondOwnershipFacet2\&quot;, {\n    contract: \&quot;DiamondOwnershipFacet\&quot;,\n    from: addr.deployer,\n});\n// Only replace a single function, we could replace all of them\nconst Cut = {\n    facetAddress: NewOwnershipFacet.address,\n    action: types_1.FacetCutAction.Replace,\n    functionSelectors: [signature],\n};\n// We will set a correct owner with delegatecall into the Diamond itself with the cut transaction\nconst correctOwner = addr.userOne;\nconst initData = await hardhat_1.default.Diamond.populateTransaction.transferOwnership(correctOwner);\nconst tx = await hardhat_1.default.Diamond.diamondCut([Cut], initData.to, initData.data);\nawait tx.wait();\n// Ensure function exists and revert is for invalid address instead of missing function\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.nonadmin).acceptOwnership()).to.be.revertedWith(test_1.Error.DIAMOND_INVALID_PENDING_OWNER);\n// Ensure one function is contained in the new facet\nconst functionsNewFacet = await hardhat_1.default.Diamond.facetFunctionSelectors(NewOwnershipFacet.address);\n(0, chai_1.expect)(functionsNewFacet.length).to.equal(1);\n(0, chai_1.expect)(functionsNewFacet).to.have.members([signature]);\n// Ensure rest are in the previous one\nconst functionsOldFacet = await hardhat_1.default.Diamond.facetFunctionSelectors(OldOwnershipFacet);\n(0, chai_1.expect)(functionsOldFacet).to.not.have.members([signature]);\n(0, chai_1.expect)(functionsOldFacet.length).to.equal(allOwnershipFacetSignatures.length - 1);\n// Ensure correct owner can now accept the ownership\n(0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).acceptOwnership());\nconst currentOwner = await hardhat_1.default.Diamond.owner();\n(0, chai_1.expect)(currentOwner).to.equal(correctOwner);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8ee156ed-4406-41c2-8523-1252163b75f7&quot;,&quot;parentUUID&quot;:&quot;662e6bca-f92c-45d8-b7e5-17e68bd3099f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can upgrade state&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can upgrade state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:756,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await hardhat_1.default.Diamond.initialized()).to.equal(true);\nconst Factory = await smock_1.smock.mock(\&quot;SmockInit\&quot;);\nconst SmockInit = await Factory.deploy();\nconst tx = await SmockInit.populateTransaction.upgradeState();\nawait hardhat_1.default.Diamond.upgradeState(tx.to, tx.data);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.initialized()).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d6b4bec9-b351-4911-89b7-00fbd9f071e2&quot;,&quot;parentUUID&quot;:&quot;662e6bca-f92c-45d8-b7e5-17e68bd3099f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can preserve old state when extending storage layout&quot;,&quot;fullTitle&quot;:&quot;Diamond #upgrades can preserve old state when extending storage layout&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1424,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await hardhat_1.default.Diamond.initialized()).to.equal(true);\n// Add the first facet\nconst Factory = await smock_1.smock.mock(\&quot;SmockFacet\&quot;);\nconst SmockFacet = await Factory.deploy();\nconst [SmockInitializer] = await hardhat_1.default.deploy(\&quot;SmockInit\&quot;);\nconst signatures = hardhat_1.default.getSignatures(types_2.SmockFacet__factory.abi);\nconst Cut = {\n    facetAddress: SmockFacet.address,\n    functionSelectors: signatures,\n    action: types_1.FacetCutAction.Add,\n};\nconst initData = await SmockInitializer.populateTransaction.initialize(addr.userOne);\nawait hardhat_1.default.Diamond.diamondCut([Cut], initData.to, initData.data);\nconst Diamond = await hardhat_1.default.ethers.getContractAt(\&quot;SmockFacet\&quot;, hardhat_1.default.Diamond.address);\nconst isInitialized = await Diamond.smockInitialized();\n(0, chai_1.expect)(isInitialized).to.equal(true);\n// Add facet with extended state\n// Add the first facet\nconst Factory2 = await smock_1.smock.mock(\&quot;SmockFacet2\&quot;);\nconst SmockFacet2 = await Factory2.deploy();\nconst signatures2 = hardhat_1.default.getSignatures(types_2.SmockFacet2__factory.abi);\nconst Cut2 = {\n    facetAddress: SmockFacet2.address,\n    functionSelectors: signatures2,\n    action: types_1.FacetCutAction.Add,\n};\n// Initializer only sets the new extended value, does not touch old storage\nconst initData2 = await SmockFacet2.populateTransaction.initialize();\nawait hardhat_1.default.Diamond.diamondCut([Cut2], initData2.to, initData2.data);\n// Here we have appended the storage layout with the `extended` bool property.\nconst DiamondExtended = await hardhat_1.default.ethers.getContractAt(\&quot;SmockFacet2\&quot;, hardhat_1.default.Diamond.address);\nconst initializedAfterExtend = await DiamondExtended.getOldStructValueFromExtended();\nconst extendedValue = await DiamondExtended.getNewStructValueFromExtended();\n// Old values remain\n(0, chai_1.expect)(initializedAfterExtend).to.equal(true);\n// And we get new ones\n(0, chai_1.expect)(extendedValue).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;57d4535c-6522-44f5-a3fb-fb527bafba65&quot;,&quot;parentUUID&quot;:&quot;662e6bca-f92c-45d8-b7e5-17e68bd3099f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;c5072c14-2d97-43f1-bd1c-07de95557a11&quot;,&quot;c0bb1e37-3adf-49ce-8df9-76cec2c888d9&quot;,&quot;34040b63-64d2-4782-a4ef-24f2dd5147b6&quot;,&quot;8ee156ed-4406-41c2-8523-1252163b75f7&quot;,&quot;d6b4bec9-b351-4911-89b7-00fbd9f071e2&quot;,&quot;57d4535c-6522-44f5-a3fb-fb527bafba65&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3656,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;7fcfc849-3d00-4534-82b8-a2cc9a3148bc&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before all\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2913afd7-49b7-4b96-88f5-09ce7bef78ef&quot;,&quot;parentUUID&quot;:&quot;7fcfc849-3d00-4534-82b8-a2cc9a3148bc&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;addr = await hardhat_1.default.getAddresses();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4a5d656d-0451-48f0-81b1-4d1be8a14da0&quot;,&quot;parentUUID&quot;:&quot;7fcfc849-3d00-4534-82b8-a2cc9a3148bc&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:25,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;03d9e0fb-8daf-48a3-9640-5a131707dbbf&quot;,&quot;parentUUID&quot;:&quot;7fcfc849-3d00-4534-82b8-a2cc9a3148bc&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;0c8bf60d-050e-4799-b321-4ee5ad5b6221&quot;,&quot;title&quot;:&quot;#initialization - anchor&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#initialization - anchor\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor \&quot;before each\&quot; hook in \&quot;#initialization - anchor\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const deployment = this.krAssets.find(k =&gt; k.deployArgs.name === name);\nKreskoAsset = deployment.contract;\nKreskoAssetAnchor = deployment.anchor;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7a2ef2cb-5d46-4505-b0e0-8de4ac138006&quot;,&quot;parentUUID&quot;:&quot;0c8bf60d-050e-4799-b321-4ee5ad5b6221&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cant initialize twice&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor cant initialize twice&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:12,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, chai_1.expect)(KreskoAsset.initialize(name, symbol, 18, addr.deployer, hardhat_1.default.Diamond.address)).to.be.revertedWith(test_1.Error.ALREADY_INITIALIZED_OZ);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9514b2ca-a009-4310-83b8-585b6bb647fb&quot;,&quot;parentUUID&quot;:&quot;0c8bf60d-050e-4799-b321-4ee5ad5b6221&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant initialize implementation&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor cant initialize implementation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:30,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const deployment = await hardhat_1.default.deployments.get(symbol);\nconst implementationAddress = deployment.implementation;\nconst KreskoAssetImpl = await hardhat_1.default.ethers.getContractAt(\&quot;KreskoAsset\&quot;, implementationAddress);\nawait (0, chai_1.expect)(KreskoAssetImpl.initialize(name, symbol, 18, addr.deployer, hardhat_1.default.Diamond.address)).to.be.revertedWith(test_1.Error.ALREADY_INITIALIZED_OZ);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b6e949d2-8d97-4221-b1ff-405516e1da2a&quot;,&quot;parentUUID&quot;:&quot;0c8bf60d-050e-4799-b321-4ee5ad5b6221&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:21,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await KreskoAsset.name()).to.equal(name);\n(0, chai_1.expect)(await KreskoAsset.symbol()).to.equal(symbol);\n(0, chai_1.expect)(await KreskoAsset.kresko()).to.equal(hardhat_1.default.Diamond.address);\n(0, chai_1.expect)(await KreskoAsset.hasRole(test_1.Role.ADMIN, addr.deployer)).to.equal(true);\n(0, chai_1.expect)(await KreskoAsset.hasRole(test_1.Role.OPERATOR, hardhat_1.default.Diamond.address)).to.equal(true);\n(0, chai_1.expect)(await KreskoAsset.totalSupply()).to.equal(0);\n(0, chai_1.expect)(await KreskoAsset.isRebased()).to.equal(false);\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, chai_1.expect)(rebaseInfo.denominator).to.equal(0);\n(0, chai_1.expect)(rebaseInfo.positive).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e0cda6b6-7dc3-45f1-a48f-c72b83f6f850&quot;,&quot;parentUUID&quot;:&quot;0c8bf60d-050e-4799-b321-4ee5ad5b6221&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can reinitialize metadata&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - anchor can reinitialize metadata&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newName = \&quot;foo\&quot;;\nconst newSymbol = \&quot;bar\&quot;;\nawait (0, chai_1.expect)(KreskoAsset.updateMetaData(newName, newSymbol, 2)).to.not.be.revertedWith(test_1.Error.ALREADY_INITIALIZED_OZ);\n(0, chai_1.expect)(await KreskoAsset.name()).to.equal(newName);\n(0, chai_1.expect)(await KreskoAsset.symbol()).to.equal(newSymbol);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bcd8fd40-73af-4409-9aae-b98e72206831&quot;,&quot;parentUUID&quot;:&quot;0c8bf60d-050e-4799-b321-4ee5ad5b6221&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9514b2ca-a009-4310-83b8-585b6bb647fb&quot;,&quot;b6e949d2-8d97-4221-b1ff-405516e1da2a&quot;,&quot;e0cda6b6-7dc3-45f1-a48f-c72b83f6f850&quot;,&quot;bcd8fd40-73af-4409-9aae-b98e72206831&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:80,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;ed2853ff-a02d-4bc0-a835-ca1464db9c4d&quot;,&quot;title&quot;:&quot;#initialization - wrapped&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#initialization - wrapped\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped \&quot;before each\&quot; hook in \&quot;#initialization - wrapped\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const deployment = hardhat_1.default.krAssets.find(k =&gt; k.deployArgs.name === name);\nKreskoAsset = deployment.contract;\nKreskoAssetAnchor = deployment.anchor;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9ea2dda4-5eb0-48d0-acee-ad7db1d9f3f7&quot;,&quot;parentUUID&quot;:&quot;ed2853ff-a02d-4bc0-a835-ca1464db9c4d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cant initialize twice&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped cant initialize twice&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:7,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, chai_1.expect)(KreskoAssetAnchor.initialize(KreskoAsset.address, name, symbol, addr.deployer)).to.be.revertedWith(test_1.Error.ALREADY_INITIALIZED_OZ);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;53347cbc-7f7b-459d-bebb-dbe6d7ca654e&quot;,&quot;parentUUID&quot;:&quot;ed2853ff-a02d-4bc0-a835-ca1464db9c4d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant initialize implementation&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped cant initialize implementation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:27,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const deployment = await hardhat_1.default.deployments.get(shared_1.anchorTokenPrefix + symbol);\nconst implementationAddress = deployment.implementation;\nconst KreskoAssetAnchorImpl = await hardhat_1.default.ethers.getContractAt(\&quot;KreskoAssetAnchor\&quot;, implementationAddress);\nawait (0, chai_1.expect)(KreskoAssetAnchorImpl.initialize(KreskoAsset.address, name, symbol, addr.deployer)).to.be.revertedWith(test_1.Error.ALREADY_INITIALIZED_OZ);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c67faf5d-cc11-4c85-8996-cc6f1281331b&quot;,&quot;parentUUID&quot;:&quot;ed2853ff-a02d-4bc0-a835-ca1464db9c4d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can reinitialize metadata&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped can reinitialize metadata&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:12,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const newName = \&quot;foo\&quot;;\nconst newSymbol = \&quot;bar\&quot;;\nawait (0, chai_1.expect)(KreskoAssetAnchor.updateMetaData(newName, newSymbol, 2)).to.not.be.revertedWith(test_1.Error.ALREADY_INITIALIZED_OZ);\n(0, chai_1.expect)(await KreskoAssetAnchor.name()).to.equal(newName);\n(0, chai_1.expect)(await KreskoAssetAnchor.symbol()).to.equal(newSymbol);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3fe5e690-da78-4460-974c-4de671182b62&quot;,&quot;parentUUID&quot;:&quot;ed2853ff-a02d-4bc0-a835-ca1464db9c4d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;sets correct state&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #initialization - wrapped sets correct state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:31,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await KreskoAssetAnchor.name()).to.equal(name);\n(0, chai_1.expect)(await KreskoAssetAnchor.symbol()).to.equal(shared_1.anchorTokenPrefix + symbol);\n(0, chai_1.expect)(await KreskoAssetAnchor.asset()).to.equal(KreskoAsset.address);\n(0, chai_1.expect)(await KreskoAssetAnchor.hasRole(test_1.Role.ADMIN, addr.deployer)).to.equal(true);\n(0, chai_1.expect)(await KreskoAssetAnchor.hasRole(test_1.Role.OPERATOR, hardhat_1.default.Diamond.address)).to.equal(true);\n(0, chai_1.expect)(await KreskoAssetAnchor.totalSupply()).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(await KreskoAsset.totalSupply());\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, chai_1.expect)(rebaseInfo.denominator).to.equal(0);\n(0, chai_1.expect)(rebaseInfo.positive).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d0e7fa69-56dd-4a99-813b-460071cf6388&quot;,&quot;parentUUID&quot;:&quot;ed2853ff-a02d-4bc0-a835-ca1464db9c4d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;53347cbc-7f7b-459d-bebb-dbe6d7ca654e&quot;,&quot;c67faf5d-cc11-4c85-8996-cc6f1281331b&quot;,&quot;3fe5e690-da78-4460-974c-4de671182b62&quot;,&quot;d0e7fa69-56dd-4a99-813b-460071cf6388&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:77,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;bbaac1fc-2a62-44a5-9438-60dbe00bd707&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before all\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b2b90ef4-043b-43ea-9972-b4914629c348&quot;,&quot;parentUUID&quot;:&quot;bbaac1fc-2a62-44a5-9438-60dbe00bd707&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before all\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;users = await hardhat_1.default.getUsers();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c87a94f2-6a9a-4eb4-8a1c-66342c59ddc4&quot;,&quot;parentUUID&quot;:&quot;bbaac1fc-2a62-44a5-9438-60dbe00bd707&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:23,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;15e04be4-df77-4e7b-ad09-9bb9644f1ee1&quot;,&quot;parentUUID&quot;:&quot;bbaac1fc-2a62-44a5-9438-60dbe00bd707&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.owner = users.deployer;\nthis.krAsset = hardhat_1.default.krAssets.find(asset =&gt; asset.deployArgs.symbol === test_1.defaultKrAssetArgs.symbol);\nthis.mintAmount = 125;\nawait this.krAsset.contract.grantRole(test_1.Role.OPERATOR, this.owner.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;77d08457-d43c-4762-8342-79cc8f43e84f&quot;,&quot;parentUUID&quot;:&quot;bbaac1fc-2a62-44a5-9438-60dbe00bd707&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;41d9f724-508e-440b-bc27-351cf6480ff4&quot;,&quot;title&quot;:&quot;#mint&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow the owner to mint to their own address&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should allow the owner to mint to their own address&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:25,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await this.krAsset.contract.totalSupply()).to.equal(0);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(this.owner.address)).to.equal(0);\nawait this.krAsset.contract.connect(this.owner).mint(this.owner.address, this.mintAmount);\n// Check total supply and owner&#x27;s balances increased\n(0, chai_1.expect)(await this.krAsset.contract.totalSupply()).to.equal(this.mintAmount);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(this.owner.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e21ca510-e32c-4645-94e3-234a09a6de0f&quot;,&quot;parentUUID&quot;:&quot;41d9f724-508e-440b-bc27-351cf6480ff4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow the asset owner to mint to another address&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should allow the asset owner to mint to another address&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:25,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await this.krAsset.contract.totalSupply()).to.equal(0);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(users.userOne.address)).to.equal(0);\nawait this.krAsset.contract.connect(this.owner).mint(users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances increased\n(0, chai_1.expect)(await this.krAsset.contract.totalSupply()).to.equal(this.mintAmount);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1f8e539d-2dab-4fbb-a406-05096eb73eff&quot;,&quot;parentUUID&quot;:&quot;41d9f724-508e-440b-bc27-351cf6480ff4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow non-owner addresses to mint tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should not allow non-owner addresses to mint tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:47,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await this.krAsset.contract.totalSupply()).to.equal(0);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(this.owner.address)).to.equal(0);\nawait (0, chai_1.expect)(this.krAsset.contract.connect(users.userOne).mint(this.owner.address, this.mintAmount)).to.be.revertedWith(`AccessControl: account ${users.userOne.address.toLowerCase()} is missing role 0x112e48a576fb3a75acc75d9fcf6e0bc670b27b1dbcd2463502e10e68cf57d6fd`);\n// Check total supply and all account balances unchanged\n(0, chai_1.expect)(await this.krAsset.contract.totalSupply()).to.equal(0);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(this.owner.address)).to.equal(0);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(users.userOne.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e0d3785d-83d3-4630-a837-0c13941f06bb&quot;,&quot;parentUUID&quot;:&quot;41d9f724-508e-440b-bc27-351cf6480ff4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow admin to mint tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #mint should not allow admin to mint tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:39,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, chai_1.expect)(this.krAsset.contract.connect(users.admin).mint(this.owner.address, this.mintAmount)).to.be.revertedWith(`AccessControl: account ${users.admin.address.toLowerCase()} is missing role 0x112e48a576fb3a75acc75d9fcf6e0bc670b27b1dbcd2463502e10e68cf57d6fd`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b56901b6-ce94-4175-82c5-bfd4873366f6&quot;,&quot;parentUUID&quot;:&quot;41d9f724-508e-440b-bc27-351cf6480ff4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;e21ca510-e32c-4645-94e3-234a09a6de0f&quot;,&quot;1f8e539d-2dab-4fbb-a406-05096eb73eff&quot;,&quot;e0d3785d-83d3-4630-a837-0c13941f06bb&quot;,&quot;b56901b6-ce94-4175-82c5-bfd4873366f6&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:136,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;bac6c175-b2ab-42e4-89a5-2512deb26322&quot;,&quot;title&quot;:&quot;#burn&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/01-erc20.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/01-erc20.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn \&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:13,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.mintAmount = 250;\nawait this.krAsset.contract.connect(this.owner).mint(users.userOne.address, this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;71de5376-c692-48dd-afb9-436552e757be&quot;,&quot;parentUUID&quot;:&quot;bac6c175-b2ab-42e4-89a5-2512deb26322&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow the owner to burn tokens from user&#x27;s address (without token allowance)&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should allow the owner to burn tokens from user&#x27;s address (without token allowance)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:53,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await this.krAsset.contract.totalSupply()).to.equal(this.mintAmount);\nawait this.krAsset.contract.connect(this.owner).burn(users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances decreased\n(0, chai_1.expect)(await this.krAsset.contract.totalSupply()).to.equal(0);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(this.owner.address)).to.equal(0);\n// Confirm that owner doesn&#x27;t hold any tokens\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(users.userOne.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c8badc6c-617e-47af-9bb3-033be1e790fe&quot;,&quot;parentUUID&quot;:&quot;bac6c175-b2ab-42e4-89a5-2512deb26322&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow the operator to burn tokens from user&#x27;s address without changing existing allowances&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should allow the operator to burn tokens from user&#x27;s address without changing existing allowances&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:66,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.krAsset.contract.connect(this.owner).approve(users.userOne.address, this.mintAmount);\n(0, chai_1.expect)(await this.krAsset.contract.totalSupply()).to.equal(this.mintAmount);\n(0, chai_1.expect)(await this.krAsset.contract.allowance(this.owner.address, users.userOne.address)).to.equal(this.mintAmount);\nawait this.krAsset.contract.connect(this.owner).burn(users.userOne.address, this.mintAmount);\n// Check total supply and user&#x27;s balances decreased\n(0, chai_1.expect)(await this.krAsset.contract.totalSupply()).to.equal(0);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(users.userOne.address)).to.equal(0);\n// Confirm that owner doesn&#x27;t hold any tokens\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(this.owner.address)).to.equal(0);\n// Confirm that token allowances are unchanged\n(0, chai_1.expect)(await this.krAsset.contract.allowance(this.owner.address, users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;03a08777-d08b-462e-81dd-6911986e74ce&quot;,&quot;parentUUID&quot;:&quot;bac6c175-b2ab-42e4-89a5-2512deb26322&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the operator to burn more tokens than user holds&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should not allow the operator to burn more tokens than user holds&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:23,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userBalance = await this.krAsset.contract.balanceOf(users.userOne.address);\nconst overUserBalance = Number(userBalance) + 1;\n// gh-actions fix\nif (process.env.TESTCI) {\n    await (0, chai_1.expect)(this.krAsset.contract.connect(this.owner).burn(users.userOne.address, overUserBalance)).to\n        .be.reverted;\n}\nelse {\n    await (0, chai_1.expect)(this.krAsset.contract.connect(this.owner).burn(users.userOne.address, overUserBalance)).to\n        .be.reverted;\n}\n// Check total supply and user&#x27;s balances are unchanged\n(0, chai_1.expect)(await this.krAsset.contract.totalSupply()).to.equal(this.mintAmount);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;56962e27-c347-4446-be84-ed74f2681730&quot;,&quot;parentUUID&quot;:&quot;bac6c175-b2ab-42e4-89a5-2512deb26322&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow non-operator addresses to burn tokens&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #burn should not allow non-operator addresses to burn tokens&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:38,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, chai_1.expect)(this.krAsset.contract.connect(users.userTwo).burn(users.userOne.address, this.mintAmount)).to.be.revertedWith(`AccessControl: account ${users.userTwo.address.toLowerCase()} is missing role 0x112e48a576fb3a75acc75d9fcf6e0bc670b27b1dbcd2463502e10e68cf57d6fd`);\n// Check total supply and user&#x27;s balances unchanged\n(0, chai_1.expect)(await this.krAsset.contract.totalSupply()).to.equal(this.mintAmount);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(users.userOne.address)).to.equal(this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7d34948d-a490-4d92-952b-8d3ba90bd418&quot;,&quot;parentUUID&quot;:&quot;bac6c175-b2ab-42e4-89a5-2512deb26322&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;c8badc6c-617e-47af-9bb3-033be1e790fe&quot;,&quot;03a08777-d08b-462e-81dd-6911986e74ce&quot;,&quot;56962e27-c347-4446-be84-ed74f2681730&quot;,&quot;7d34948d-a490-4d92-952b-8d3ba90bd418&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:180,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;6760084d-95ed-4451-9e87-3c8b9d5de28a&quot;,&quot;title&quot;:&quot;KreskoAsset&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before all\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;addr = await hardhat_1.default.getAddresses();\nusers = await hardhat_1.default.getUsers();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b0f3067a-b8e8-439b-a0f3-c07e458d74da&quot;,&quot;parentUUID&quot;:&quot;6760084d-95ed-4451-9e87-3c8b9d5de28a&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before all\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;78a2674f-d01d-42de-8d26-3df6d53addbb&quot;,&quot;parentUUID&quot;:&quot;6760084d-95ed-4451-9e87-3c8b9d5de28a&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:25,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bc06dc59-07cc-4a90-8344-6e33cdf1b5cb&quot;,&quot;parentUUID&quot;:&quot;6760084d-95ed-4451-9e87-3c8b9d5de28a&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset \&quot;before each\&quot; hook in \&quot;KreskoAsset\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;KreskoAsset = hardhat_1.default.krAssets.find(asset =&gt; asset.deployArgs.symbol === test_1.defaultKrAssetArgs.symbol).contract;\n// Grant minting rights for test deployer\nawait KreskoAsset.grantRole(test_1.Role.OPERATOR, addr.deployer);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dbd16f65-d597-42c9-9dcb-221a7b16f73b&quot;,&quot;parentUUID&quot;:&quot;6760084d-95ed-4451-9e87-3c8b9d5de28a&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;1475937a-e73e-40a0-bc06-05420a47658b&quot;,&quot;title&quot;:&quot;#rebase&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can set a positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can set a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = hardhat_1.default.toBig(\&quot;1.525\&quot;);\nconst positive = true;\nawait (0, chai_1.expect)(KreskoAsset.rebase(denominator, positive)).to.not.be.reverted;\n(0, chai_1.expect)(await KreskoAsset.isRebased()).to.equal(true);\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, chai_1.expect)(rebaseInfo.denominator).equal(denominator);\n(0, chai_1.expect)(rebaseInfo.positive).equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;70d2c3a4-6637-4910-b75d-d5c803fa1498&quot;,&quot;parentUUID&quot;:&quot;1475937a-e73e-40a0-bc06-05420a47658b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can set a negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can set a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = hardhat_1.default.toBig(\&quot;1.525\&quot;);\nconst positive = false;\nawait (0, chai_1.expect)(KreskoAsset.rebase(denominator, positive)).to.not.be.reverted;\n(0, chai_1.expect)(await KreskoAsset.isRebased()).to.equal(true);\nconst rebaseInfo = await KreskoAsset.rebaseInfo();\n(0, chai_1.expect)(rebaseInfo.denominator).equal(denominator);\n(0, chai_1.expect)(rebaseInfo.positive).equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9b0f69fe-3e31-4b33-a22b-7c78737a5800&quot;,&quot;parentUUID&quot;:&quot;1475937a-e73e-40a0-bc06-05420a47658b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can be disabled by setting the denominator to 1 ether&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase can be disabled by setting the denominator to 1 ether&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:46,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = hardhat_1.default.toBig(1);\nconst positive = false;\nawait (0, chai_1.expect)(KreskoAsset.rebase(denominator, positive)).to.not.be.reverted;\n(0, chai_1.expect)(await KreskoAsset.isRebased()).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;38218b8d-ac42-4aa2-bbee-52496c3b2f10&quot;,&quot;parentUUID&quot;:&quot;1475937a-e73e-40a0-bc06-05420a47658b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;a5b49356-e566-4f56-973f-0150c86ea25c&quot;,&quot;title&quot;:&quot;#balance + supply&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;has no effect when not enabled&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply has no effect when not enabled&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:19,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAsset.isRebased()).to.equal(false);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;728b0ecb-fb71-40b3-930b-6181877eebb3&quot;,&quot;parentUUID&quot;:&quot;a5b49356-e566-4f56-973f-0150c86ea25c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase @ 2&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase @ 2&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:45,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 2;\nconst positive = true;\nawait KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount.mul(denominator));\n(0, chai_1.expect)(await KreskoAsset.totalSupply()).to.equal(test_1.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;527cfbee-0091-477e-9657-d6e0d1868b6a&quot;,&quot;parentUUID&quot;:&quot;a5b49356-e566-4f56-973f-0150c86ea25c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase @ 3&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase @ 3&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:39,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 3;\nconst positive = true;\nawait KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount.mul(denominator));\n(0, chai_1.expect)(await KreskoAsset.totalSupply()).to.equal(test_1.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;574cb49a-d176-4967-9d1e-c3bc282ad753&quot;,&quot;parentUUID&quot;:&quot;a5b49356-e566-4f56-973f-0150c86ea25c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;increases balance and supply with positive rebase  @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply increases balance and supply with positive rebase  @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:38,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 100;\nconst positive = true;\nawait KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount.mul(denominator));\n(0, chai_1.expect)(await KreskoAsset.totalSupply()).to.equal(test_1.defaultMintAmount.mul(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bab32938-ebb5-4e4f-91b7-e31225df97ca&quot;,&quot;parentUUID&quot;:&quot;a5b49356-e566-4f56-973f-0150c86ea25c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 2&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 2&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:37,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 2;\nconst positive = false;\nawait KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount.div(denominator));\n(0, chai_1.expect)(await KreskoAsset.totalSupply()).to.equal(test_1.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;21f4407b-9e68-4ca3-a62c-b6eb63b095ed&quot;,&quot;parentUUID&quot;:&quot;a5b49356-e566-4f56-973f-0150c86ea25c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 3&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 3&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:40,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 3;\nconst positive = false;\nawait KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount.div(denominator));\n(0, chai_1.expect)(await KreskoAsset.totalSupply()).to.equal(test_1.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;59075823-9797-43f8-ba42-b093cfddfbc5&quot;,&quot;parentUUID&quot;:&quot;a5b49356-e566-4f56-973f-0150c86ea25c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;reduces balance and supply with negative rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #balance + supply reduces balance and supply with negative rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:36,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const denominator = 100;\nconst positive = false;\nawait KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount.div(denominator));\n(0, chai_1.expect)(await KreskoAsset.totalSupply()).to.equal(test_1.defaultMintAmount.div(denominator));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;10795b71-ed47-4056-a0e3-e4e80fc995c7&quot;,&quot;parentUUID&quot;:&quot;a5b49356-e566-4f56-973f-0150c86ea25c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;728b0ecb-fb71-40b3-930b-6181877eebb3&quot;,&quot;527cfbee-0091-477e-9657-d6e0d1868b6a&quot;,&quot;574cb49a-d176-4967-9d1e-c3bc282ad753&quot;,&quot;bab32938-ebb5-4e4f-91b7-e31225df97ca&quot;,&quot;21f4407b-9e68-4ca3-a62c-b6eb63b095ed&quot;,&quot;59075823-9797-43f8-ba42-b093cfddfbc5&quot;,&quot;10795b71-ed47-4056-a0e3-e4e80fc995c7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:254,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;caa1c601-3fa9-4ae6-b12c-e8ac59b622b8&quot;,&quot;title&quot;:&quot;#transfer&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/02-krasset.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/02-krasset.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;has default transfer behaviour after positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transfer behaviour after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:63,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = hardhat_1.default.toBig(1);\nawait KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAsset.mint(addr.userOne, test_1.defaultMintAmount);\nconst denominator = 2;\nconst positive = true;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nconst rebaseInfodDefaultMintAMount = test_1.defaultMintAmount.mul(denominator);\nawait KreskoAsset.transfer(addr.userOne, transferAmount);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a4f0a061-ad19-4ee9-b75b-e6c8f75a620d&quot;,&quot;parentUUID&quot;:&quot;caa1c601-3fa9-4ae6-b12c-e8ac59b622b8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transfer behaviour after negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transfer behaviour after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:63,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = hardhat_1.default.toBig(1);\nawait KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAsset.mint(addr.userOne, test_1.defaultMintAmount);\nconst denominator = 2;\nconst positive = false;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nconst rebaseInfodDefaultMintAMount = test_1.defaultMintAmount.div(denominator);\nawait KreskoAsset.transfer(addr.userOne, transferAmount);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b1ae5d09-0255-4e94-b140-fe08e0c9f03b&quot;,&quot;parentUUID&quot;:&quot;caa1c601-3fa9-4ae6-b12c-e8ac59b622b8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after positive rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:162,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = hardhat_1.default.toBig(1);\nawait KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAsset.mint(addr.userOne, test_1.defaultMintAmount);\nconst denominator = 2;\nconst positive = true;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nawait KreskoAsset.approve(addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = test_1.defaultMintAmount.mul(denominator);\nawait KreskoAsset.connect(users.userOne).transferFrom(addr.deployer, addr.userOne, transferAmount);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, chai_1.expect)(KreskoAsset.connect(users.userOne).transferFrom(addr.deployer, addr.userOne, transferAmount)).to.be.revertedWith(test_1.Error.NOT_ENOUGH_ALLOWANCE);\n(0, chai_1.expect)(await KreskoAsset.allowance(addr.deployer, addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1ace4ffe-6518-436c-98f9-53b3b33da7b7&quot;,&quot;parentUUID&quot;:&quot;caa1c601-3fa9-4ae6-b12c-e8ac59b622b8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after positive rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after positive rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:151,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = hardhat_1.default.toBig(1);\nawait KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAsset.mint(addr.userOne, test_1.defaultMintAmount);\nconst denominator = 100;\nconst positive = true;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nawait KreskoAsset.approve(addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = test_1.defaultMintAmount.mul(denominator);\nawait KreskoAsset.connect(users.userOne).transferFrom(addr.deployer, addr.userOne, transferAmount);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, chai_1.expect)(KreskoAsset.connect(users.userOne).transferFrom(addr.deployer, addr.userOne, transferAmount)).to.be.revertedWith(test_1.Error.NOT_ENOUGH_ALLOWANCE);\n(0, chai_1.expect)(await KreskoAsset.allowance(addr.deployer, addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;12a1c997-9382-4437-a731-2a2a70b25d9a&quot;,&quot;parentUUID&quot;:&quot;caa1c601-3fa9-4ae6-b12c-e8ac59b622b8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after negative rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:159,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = hardhat_1.default.toBig(1);\nawait KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAsset.mint(addr.userOne, test_1.defaultMintAmount);\nconst denominator = 2;\nconst positive = false;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nawait KreskoAsset.approve(addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = test_1.defaultMintAmount.div(denominator);\nawait KreskoAsset.connect(users.userOne).transferFrom(addr.deployer, addr.userOne, transferAmount);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, chai_1.expect)(KreskoAsset.connect(users.userOne).transferFrom(addr.deployer, addr.userOne, transferAmount)).to.be.revertedWith(test_1.Error.NOT_ENOUGH_ALLOWANCE);\n(0, chai_1.expect)(await KreskoAsset.allowance(addr.deployer, addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7e557a6c-49fb-4047-ac5b-1fd1aa729902&quot;,&quot;parentUUID&quot;:&quot;caa1c601-3fa9-4ae6-b12c-e8ac59b622b8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;has default transferFrom behaviour after negative rebase @ 100&quot;,&quot;fullTitle&quot;:&quot;KreskoAsset #rebase #transfer has default transferFrom behaviour after negative rebase @ 100&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:146,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const transferAmount = hardhat_1.default.toBig(1);\nawait KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAsset.mint(addr.userOne, test_1.defaultMintAmount);\nconst denominator = 100;\nconst positive = false;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nawait KreskoAsset.approve(addr.userOne, transferAmount);\nconst rebaseInfodDefaultMintAMount = test_1.defaultMintAmount.div(denominator);\nawait KreskoAsset.connect(users.userOne).transferFrom(addr.deployer, addr.userOne, transferAmount);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.userOne)).to.equal(rebaseInfodDefaultMintAMount.add(transferAmount));\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebaseInfodDefaultMintAMount.sub(transferAmount));\nawait (0, chai_1.expect)(KreskoAsset.connect(users.userOne).transferFrom(addr.deployer, addr.userOne, transferAmount)).to.be.revertedWith(test_1.Error.NOT_ENOUGH_ALLOWANCE);\n(0, chai_1.expect)(await KreskoAsset.allowance(addr.deployer, addr.userOne)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;26225d6b-0c22-4907-9bc6-6bc76846c19b&quot;,&quot;parentUUID&quot;:&quot;caa1c601-3fa9-4ae6-b12c-e8ac59b622b8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;a4f0a061-ad19-4ee9-b75b-e6c8f75a620d&quot;,&quot;b1ae5d09-0255-4e94-b140-fe08e0c9f03b&quot;,&quot;1ace4ffe-6518-436c-98f9-53b3b33da7b7&quot;,&quot;12a1c997-9382-4437-a731-2a2a70b25d9a&quot;,&quot;7e557a6c-49fb-4047-ac5b-1fd1aa729902&quot;,&quot;26225d6b-0c22-4907-9bc6-6bc76846c19b&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:744,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[&quot;70d2c3a4-6637-4910-b75d-d5c803fa1498&quot;,&quot;9b0f69fe-3e31-4b33-a22b-7c78737a5800&quot;,&quot;38218b8d-ac42-4aa2-bbee-52496c3b2f10&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:90,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;89828906-e440-482d-9493-52c721d3165d&quot;,&quot;title&quot;:&quot;KreskoAssetAnchor&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor \&quot;before all\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8ca2836d-66aa-4121-867d-26c57f6e18a2&quot;,&quot;parentUUID&quot;:&quot;89828906-e440-482d-9493-52c721d3165d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor \&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d7764e7a-9b5f-4e88-9528-ab8f83b990c9&quot;,&quot;parentUUID&quot;:&quot;89828906-e440-482d-9493-52c721d3165d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor \&quot;before each\&quot; hook in \&quot;KreskoAssetAnchor\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:447,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;addr = await hardhat_1.default.getAddresses();\nconst asset = hardhat_1.default.krAssets.find(asset =&gt; asset.deployArgs.symbol === test_1.defaultKrAssetArgs.symbol);\nKreskoAsset = asset.contract;\nKreskoAssetAnchor = asset.anchor;\n// Grant minting rights for test deployer\nawait Promise.all([\n    KreskoAsset.grantRole(test_1.Role.OPERATOR, addr.deployer),\n    KreskoAssetAnchor.grantRole(test_1.Role.OPERATOR, addr.deployer),\n    KreskoAsset.approve(KreskoAssetAnchor.address, hardhat_1.default.ethers.constants.MaxUint256),\n]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b67d0c2f-6d34-4e3e-bf8f-c605912c241a&quot;,&quot;parentUUID&quot;:&quot;89828906-e440-482d-9493-52c721d3165d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;2aebfb13-03b6-40ed-821b-3861742dfd67&quot;,&quot;title&quot;:&quot;#minting and burning&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;tracks the supply of underlying&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning tracks the supply of underlying&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:52,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.totalSupply()).to.equal(0);\nawait KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(test_1.defaultMintAmount.add(test_1.defaultMintAmount));\n(0, chai_1.expect)(await KreskoAssetAnchor.totalSupply()).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;59c53c6d-9509-420f-9958-c66e976552ce&quot;,&quot;parentUUID&quot;:&quot;2aebfb13-03b6-40ed-821b-3861742dfd67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning mints 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:125,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAssetAnchor.mint(test_1.defaultMintAmount, addr.deployer);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(KreskoAssetAnchor.address)).to.equal(test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;74e9e24d-d73d-4f60-9f78-78a7777418b9&quot;,&quot;parentUUID&quot;:&quot;2aebfb13-03b6-40ed-821b-3861742dfd67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning deposits 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:125,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAssetAnchor.deposit(test_1.defaultMintAmount, addr.deployer);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(KreskoAssetAnchor.address)).to.equal(test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7bd05af2-8fb6-4c26-9c8b-1e9ee1dba20b&quot;,&quot;parentUUID&quot;:&quot;2aebfb13-03b6-40ed-821b-3861742dfd67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;redeems 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning redeems 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:270,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAssetAnchor.mint(test_1.defaultMintAmount, addr.deployer);\nawait KreskoAssetAnchor.redeem(test_1.defaultMintAmount, addr.deployer, addr.deployer);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(KreskoAssetAnchor.address)).to.equal(0);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;98bf05e7-b304-4b5f-b058-b5db77da4557&quot;,&quot;parentUUID&quot;:&quot;2aebfb13-03b6-40ed-821b-3861742dfd67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;withdraws 1:1 with no rebases&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning withdraws 1:1 with no rebases&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:261,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAssetAnchor.deposit(test_1.defaultMintAmount, addr.deployer);\nawait KreskoAssetAnchor.withdraw(test_1.defaultMintAmount, addr.deployer, addr.deployer);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(KreskoAssetAnchor.address)).to.equal(0);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5bb1b72a-d2aa-4302-968b-c6febb836774&quot;,&quot;parentUUID&quot;:&quot;2aebfb13-03b6-40ed-821b-3861742dfd67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;3e814136-8747-447d-b698-9657f0077d1d&quot;,&quot;title&quot;:&quot;#rebases&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;3342a0c4-7dca-43e2-9fe7-e547f1f527b3&quot;,&quot;title&quot;:&quot;#conversions&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;file&quot;:&quot;/src/test/krasset/03-krasset-anchor.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;mints 1:1 and redeems 1:2 after 1:2 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 1:2 after 1:2 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:311,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAssetAnchor.mint(test_1.defaultMintAmount, addr.deployer);\nconst denominator = 2;\nconst positive = true;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nconst rebasedAmount = test_1.defaultMintAmount.mul(denominator);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(rebasedAmount);\nawait KreskoAssetAnchor.redeem(test_1.defaultMintAmount, addr.deployer, addr.deployer);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebasedAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(KreskoAsset.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b567cc73-4626-4b0d-8a34-38cdcda0aeb2&quot;,&quot;parentUUID&quot;:&quot;3342a0c4-7dca-43e2-9fe7-e547f1f527b3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 1:2 after 1:2 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 1:2 after 1:2 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:283,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAssetAnchor.deposit(test_1.defaultMintAmount, addr.deployer);\nconst denominator = 2;\nconst positive = true;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nconst rebasedAmount = test_1.defaultMintAmount.mul(denominator);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(rebasedAmount);\nawait KreskoAssetAnchor.withdraw(rebasedAmount, addr.deployer, addr.deployer);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebasedAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(KreskoAsset.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9e44642d-be1e-430f-86f2-2655c3d859e4&quot;,&quot;parentUUID&quot;:&quot;3342a0c4-7dca-43e2-9fe7-e547f1f527b3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 1:6 after 1:6 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 1:6 after 1:6 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:299,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAssetAnchor.mint(test_1.defaultMintAmount, addr.deployer);\nconst denominator = 6;\nconst positive = true;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nconst rebasedAmount = test_1.defaultMintAmount.mul(denominator);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(rebasedAmount);\nawait KreskoAssetAnchor.redeem(test_1.defaultMintAmount, addr.deployer, addr.deployer);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebasedAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(KreskoAsset.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d01c6984-1e33-4284-8d02-6e7fa966f086&quot;,&quot;parentUUID&quot;:&quot;3342a0c4-7dca-43e2-9fe7-e547f1f527b3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 1:6 after 1:6 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 1:6 after 1:6 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:269,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAssetAnchor.deposit(test_1.defaultMintAmount, addr.deployer);\nconst denominator = 6;\nconst positive = true;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nconst rebasedAmount = test_1.defaultMintAmount.mul(denominator);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(rebasedAmount);\nawait KreskoAssetAnchor.withdraw(rebasedAmount, addr.deployer, addr.deployer);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebasedAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(KreskoAsset.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cc0cf08c-a5bb-4314-aa5a-15c0cf64c1bc&quot;,&quot;parentUUID&quot;:&quot;3342a0c4-7dca-43e2-9fe7-e547f1f527b3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 2:1 after 2:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 2:1 after 2:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:273,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAssetAnchor.mint(test_1.defaultMintAmount, addr.deployer);\nconst denominator = 2;\nconst positive = false;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nconst rebasedAmount = test_1.defaultMintAmount.div(denominator);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(rebasedAmount);\nawait KreskoAssetAnchor.redeem(test_1.defaultMintAmount, addr.deployer, addr.deployer);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebasedAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(KreskoAsset.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fdbb8a84-9977-4358-a808-b3dc450aacb3&quot;,&quot;parentUUID&quot;:&quot;3342a0c4-7dca-43e2-9fe7-e547f1f527b3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 2:1 after 2:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 2:1 after 2:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:289,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAssetAnchor.deposit(test_1.defaultMintAmount, addr.deployer);\nconst denominator = 2;\nconst positive = false;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nconst rebasedAmount = test_1.defaultMintAmount.div(denominator);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(rebasedAmount);\nawait KreskoAssetAnchor.withdraw(rebasedAmount, addr.deployer, addr.deployer);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebasedAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(KreskoAsset.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;77903e26-1f3f-40f6-9cff-954c862bab48&quot;,&quot;parentUUID&quot;:&quot;3342a0c4-7dca-43e2-9fe7-e547f1f527b3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;mints 1:1 and redeems 6:1 after 6:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions mints 1:1 and redeems 6:1 after 6:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:288,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAssetAnchor.mint(test_1.defaultMintAmount, addr.deployer);\nconst denominator = 6;\nconst positive = false;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nconst rebasedAmount = test_1.defaultMintAmount.div(denominator);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(rebasedAmount);\nawait KreskoAssetAnchor.redeem(test_1.defaultMintAmount, addr.deployer, addr.deployer);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebasedAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(KreskoAsset.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;33adc08e-c82c-425c-aaa8-4a0cc3b15adb&quot;,&quot;parentUUID&quot;:&quot;3342a0c4-7dca-43e2-9fe7-e547f1f527b3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;deposits 1:1 and withdraws 6:1 after 6:1 rebase&quot;,&quot;fullTitle&quot;:&quot;KreskoAssetAnchor #minting and burning #rebases #conversions deposits 1:1 and withdraws 6:1 after 6:1 rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:262,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await KreskoAsset.mint(addr.deployer, test_1.defaultMintAmount);\nawait KreskoAssetAnchor.deposit(test_1.defaultMintAmount, addr.deployer);\nconst denominator = 6;\nconst positive = false;\nawait KreskoAsset.rebase(hardhat_1.default.toBig(denominator), positive);\nconst rebasedAmount = test_1.defaultMintAmount.div(denominator);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(test_1.defaultMintAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.totalAssets()).to.equal(rebasedAmount);\nawait KreskoAssetAnchor.withdraw(rebasedAmount, addr.deployer, addr.deployer);\n(0, chai_1.expect)(await KreskoAsset.balanceOf(addr.deployer)).to.equal(rebasedAmount);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(addr.deployer)).to.equal(0);\n(0, chai_1.expect)(await KreskoAssetAnchor.balanceOf(KreskoAsset.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4972dc21-4456-4118-925b-c9db22d1c428&quot;,&quot;parentUUID&quot;:&quot;3342a0c4-7dca-43e2-9fe7-e547f1f527b3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b567cc73-4626-4b0d-8a34-38cdcda0aeb2&quot;,&quot;9e44642d-be1e-430f-86f2-2655c3d859e4&quot;,&quot;d01c6984-1e33-4284-8d02-6e7fa966f086&quot;,&quot;cc0cf08c-a5bb-4314-aa5a-15c0cf64c1bc&quot;,&quot;fdbb8a84-9977-4358-a808-b3dc450aacb3&quot;,&quot;77903e26-1f3f-40f6-9cff-954c862bab48&quot;,&quot;33adc08e-c82c-425c-aaa8-4a0cc3b15adb&quot;,&quot;4972dc21-4456-4118-925b-c9db22d1c428&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2274,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[&quot;59c53c6d-9509-420f-9958-c66e976552ce&quot;,&quot;74e9e24d-d73d-4f60-9f78-78a7777418b9&quot;,&quot;7bd05af2-8fb6-4c26-9c8b-1e9ee1dba20b&quot;,&quot;98bf05e7-b304-4b5f-b058-b5db77da4557&quot;,&quot;5bb1b72a-d2aa-4302-968b-c6febb836774&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:833,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;02a6a4f8-d800-4d80-b39b-d72d981cefd1&quot;,&quot;title&quot;:&quot;Minter&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7b6b433f-0993-41d1-99e8-827c240a8cd1&quot;,&quot;parentUUID&quot;:&quot;02a6a4f8-d800-4d80-b39b-d72d981cefd1&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:23,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0aa492dd-5a7a-42a4-9051-965998f804a6&quot;,&quot;parentUUID&quot;:&quot;02a6a4f8-d800-4d80-b39b-d72d981cefd1&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;c6d1b8a8-a99e-40ed-b4ec-39b2f115cbea&quot;,&quot;title&quot;:&quot;#initialization&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;sets correct initial state&quot;,&quot;fullTitle&quot;:&quot;Minter #initialization sets correct initial state&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:19,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await hardhat_1.default.Diamond.minterInitializations()).to.equal(1);\nconst { args } = await (0, shared_1.getMinterInitializer)(hardhat_1.default);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.hasRole(test_1.Role.OPERATOR, args.operator)).to.equal(true);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.hasRole(test_1.Role.SAFETY_COUNCIL, hardhat_1.default.Multisig.address)).to.equal(true);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.feeRecipient()).to.equal(args.feeRecipient);\n(0, chai_1.expect)((await hardhat_1.default.Diamond.liquidationIncentiveMultiplier()).rawValue).to.equal(args.liquidationIncentiveMultiplier);\n(0, chai_1.expect)((await hardhat_1.default.Diamond.minimumCollateralizationRatio()).rawValue).to.equal(args.minimumCollateralizationRatio);\n(0, chai_1.expect)((await hardhat_1.default.Diamond.minimumDebtValue()).rawValue).to.equal(args.minimumDebtValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7b7c7f01-8cdd-4851-90fa-332eb6ab76f4&quot;,&quot;parentUUID&quot;:&quot;c6d1b8a8-a99e-40ed-b4ec-39b2f115cbea&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant initialize twice&quot;,&quot;fullTitle&quot;:&quot;Minter #initialization cant initialize twice&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const initializer = await (0, shared_1.getMinterInitializer)(hardhat_1.default);\nconst initializerContract = await hardhat_1.default.ethers.getContract(initializer.name);\nconst tx = await initializerContract.populateTransaction.initialize(initializer.args);\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.upgradeState(tx.to, tx.data)).to.be.revertedWith(test_1.Error.ALREADY_INITIALIZED);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;974ed486-98da-487d-81eb-ed4dfe74f373&quot;,&quot;parentUUID&quot;:&quot;c6d1b8a8-a99e-40ed-b4ec-39b2f115cbea&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;configures all facets correctly&quot;,&quot;fullTitle&quot;:&quot;Minter #initialization configures all facets correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:43,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const facetsOnChain = (await hardhat_1.default.Diamond.facets()).map(([facetAddress, functionSelectors]) =&gt; ({\n    facetAddress,\n    functionSelectors,\n}));\n(0, chai_1.expect)(facetsOnChain).to.have.deep.members(hardhat_1.default.DiamondDeployment.facets.map(f =&gt; ({\n    facetAddress: f.facetAddress,\n    functionSelectors: f.functionSelectors,\n})));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cccfbd8b-7ee8-47d2-952c-40870011d858&quot;,&quot;parentUUID&quot;:&quot;c6d1b8a8-a99e-40ed-b4ec-39b2f115cbea&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;7b7c7f01-8cdd-4851-90fa-332eb6ab76f4&quot;,&quot;974ed486-98da-487d-81eb-ed4dfe74f373&quot;,&quot;cccfbd8b-7ee8-47d2-952c-40870011d858&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:86,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;689d5f30-6f82-4f47-8022-2f5a4e009055&quot;,&quot;title&quot;:&quot;Minter&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/01-configuration.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/01-configuration.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;users = await hardhat_1.default.getUsers();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f18a014f-a596-4ffa-9d19-ad734674ba20&quot;,&quot;parentUUID&quot;:&quot;689d5f30-6f82-4f47-8022-2f5a4e009055&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;24aa37f9-4600-48d5-9cc1-c9eddb1eed7b&quot;,&quot;parentUUID&quot;:&quot;689d5f30-6f82-4f47-8022-2f5a4e009055&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:23,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3ba8e8cf-73ac-4309-a0b0-81cd1bda475e&quot;,&quot;parentUUID&quot;:&quot;689d5f30-6f82-4f47-8022-2f5a4e009055&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;55e4a2ff-9f62-4e0d-8ee9-37a01dd022df&quot;,&quot;title&quot;:&quot;#configuration&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/01-configuration.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/01-configuration.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can modify all parameters&quot;,&quot;fullTitle&quot;:&quot;Minter #configuration can modify all parameters&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:31,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const Diamond = hardhat_1.default.Diamond.connect(users.operator);\nconst update = (0, test_1.getNewMinterParams)(users.operator.address);\nawait (0, chai_1.expect)(Diamond.updateLiquidationIncentiveMultiplier(update.liquidationIncentiveMultiplier)).to.not.be\n    .reverted;\nawait (0, chai_1.expect)(Diamond.updateMinimumCollateralizationRatio(update.minimumCollateralizationRatio)).to.not.be\n    .reverted;\nawait (0, chai_1.expect)(Diamond.updateMinimumDebtValue(update.minimumDebtValue)).to.not.be.reverted;\nawait (0, chai_1.expect)(Diamond.updateLiquidationThreshold(update.liquidationThreshold)).to.not.be.reverted;\nawait (0, chai_1.expect)(Diamond.updateFeeRecipient(update.feeRecipient)).to.not.be.reverted;\nconst { liquidationIncentiveMultiplier, minimumCollateralizationRatio, minimumDebtValue, liquidationThreshold, feeRecipient, } = await hardhat_1.default.Diamond.getAllParams();\n(0, chai_1.expect)(update.liquidationIncentiveMultiplier.toBigInt()).to.equal(liquidationIncentiveMultiplier.rawValue);\n(0, chai_1.expect)(update.minimumCollateralizationRatio.toBigInt()).to.equal(minimumCollateralizationRatio.rawValue);\n(0, chai_1.expect)(update.minimumDebtValue.toBigInt()).to.equal(minimumDebtValue.rawValue);\n(0, chai_1.expect)(update.liquidationThreshold.toBigInt()).to.equal(liquidationThreshold.rawValue);\n(0, chai_1.expect)(update.feeRecipient).to.equal(feeRecipient);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b21dfe78-e056-400d-bebc-bd2d19bc06d8&quot;,&quot;parentUUID&quot;:&quot;55e4a2ff-9f62-4e0d-8ee9-37a01dd022df&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can add a collateral asset&quot;,&quot;fullTitle&quot;:&quot;Minter #configuration can add a collateral asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1882,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract } = await (0, collaterals_1.addMockCollateralAsset)(test_1.defaultCollateralArgs);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.collateralExists(contract.address)).to.equal(true);\nconst [, oraclePrice] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(contract.address, hardhat_1.default.toBig(1), true);\n(0, chai_1.expect)(Number(oraclePrice)).to.equal(hardhat_1.default.toBig(test_1.defaultCollateralArgs.price, 8));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;df5b0e0a-b7da-4b2e-a0dc-5ee5433b2319&quot;,&quot;parentUUID&quot;:&quot;55e4a2ff-9f62-4e0d-8ee9-37a01dd022df&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can add a kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter #configuration can add a kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2336,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract, kresko } = await (0, krassets_1.addMockKreskoAsset)();\nconst values = await kresko();\nconst kreskoPriceAnswer = hardhat_1.default.fromBig((await hardhat_1.default.Diamond.getKrAssetValue(contract.address, hardhat_1.default.toBig(1), true)).rawValue, 8);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.krAssetExists(contract.address)).to.equal(true);\n(0, chai_1.expect)(values.exists).to.equal(true);\n(0, chai_1.expect)(Number(values.kFactor)).to.equal(Number((0, lib_1.toFixedPoint)(test_1.defaultKrAssetArgs.factor)));\n(0, chai_1.expect)(kreskoPriceAnswer).to.equal(test_1.defaultKrAssetArgs.price);\n(0, chai_1.expect)(hardhat_1.default.fromBig(values.supplyLimit)).to.equal(test_1.defaultKrAssetArgs.supplyLimit);\n(0, chai_1.expect)(hardhat_1.default.fromBig(values.closeFee.rawValue)).to.equal(test_1.defaultKrAssetArgs.closeFee);\n(0, chai_1.expect)(hardhat_1.default.fromBig(values.openFee.rawValue)).to.equal(test_1.defaultKrAssetArgs.openFee);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;33c39d91-cbfa-4b5e-ab7a-967f51eae512&quot;,&quot;parentUUID&quot;:&quot;55e4a2ff-9f62-4e0d-8ee9-37a01dd022df&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update AMM oracle&quot;,&quot;fullTitle&quot;:&quot;Minter #configuration can update AMM oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:32,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const ammOracle = await smock_1.smock.fake(\&quot;UniswapV2Oracle\&quot;);\nawait hardhat_1.default.Diamond.updateAMMOracle(ammOracle.address);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.ammOracle()).to.equal(ammOracle.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;93484be8-964a-4bba-87bb-3e48028a98af&quot;,&quot;parentUUID&quot;:&quot;55e4a2ff-9f62-4e0d-8ee9-37a01dd022df&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update external oracle decimals&quot;,&quot;fullTitle&quot;:&quot;Minter #configuration can update external oracle decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:10,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const decimals = 8;\nawait hardhat_1.default.Diamond.updateExtOracleDecimals(decimals);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.extOracleDecimals()).to.equal(decimals);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c9ed85f7-f602-4a6b-92f2-955598feda1c&quot;,&quot;parentUUID&quot;:&quot;55e4a2ff-9f62-4e0d-8ee9-37a01dd022df&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can update values of a kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter #configuration can update values of a kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3480,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { contract, anchor, priceAggregator } = await (0, krassets_1.addMockKreskoAsset)();\nconst oracleAnswer = hardhat_1.default.fromBig(await priceAggregator.latestAnswer(), 8);\nconst kreskoAnswer = hardhat_1.default.fromBig((await hardhat_1.default.Diamond.getKrAssetValue(contract.address, hardhat_1.default.toBig(1), true)).rawValue, 8);\n(0, chai_1.expect)(oracleAnswer).to.equal(kreskoAnswer);\n(0, chai_1.expect)(oracleAnswer).to.equal(test_1.defaultKrAssetArgs.price);\nconst update = {\n    factor: (0, lib_1.toFixedPoint)(1.2),\n    supplyLimit: 12000,\n    price: 20,\n    closeFee: (0, lib_1.toFixedPoint)(0.02),\n    openFee: (0, lib_1.toFixedPoint)(0.02),\n};\nconst [newPriceFeed] = await (0, test_1.getMockOracleFor)(await contract.name(), update.price);\nawait hardhat_1.default.Diamond.connect(users.operator).updateKreskoAsset(contract.address, anchor.address, update.factor, newPriceFeed.address, hardhat_1.default.toBig(update.supplyLimit), update.closeFee, update.openFee);\nconst newValues = await hardhat_1.default.Diamond.kreskoAsset(contract.address);\nconst updatedOracleAnswer = hardhat_1.default.fromBig(await newPriceFeed.latestAnswer(), 8);\nconst newKreskoAnswer = hardhat_1.default.fromBig((await hardhat_1.default.Diamond.getKrAssetValue(contract.address, hardhat_1.default.toBig(1), true)).rawValue, 8);\n(0, chai_1.expect)(newValues.exists).to.equal(true);\n(0, chai_1.expect)(Number(newValues.kFactor)).to.equal(Number(update.factor));\n(0, chai_1.expect)(hardhat_1.default.fromBig(newValues.supplyLimit)).to.equal(update.supplyLimit);\n(0, chai_1.expect)(updatedOracleAnswer).to.equal(newKreskoAnswer);\n(0, chai_1.expect)(updatedOracleAnswer).to.equal(update.price);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fff302ee-2888-47c4-8501-75b454bcb6d9&quot;,&quot;parentUUID&quot;:&quot;55e4a2ff-9f62-4e0d-8ee9-37a01dd022df&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b21dfe78-e056-400d-bebc-bd2d19bc06d8&quot;,&quot;df5b0e0a-b7da-4b2e-a0dc-5ee5433b2319&quot;,&quot;33c39d91-cbfa-4b5e-ab7a-967f51eae512&quot;,&quot;93484be8-964a-4bba-87bb-3e48028a98af&quot;,&quot;c9ed85f7-f602-4a6b-92f2-955598feda1c&quot;,&quot;fff302ee-2888-47c4-8501-75b454bcb6d9&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:7771,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;cf6f9317-3148-455e-9ff3-615772f94321&quot;,&quot;title&quot;:&quot;Minter&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;users = await hardhat_1.default.getUsers();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c93bfca3-4a44-4a8f-bca7-2c3b50817b5c&quot;,&quot;parentUUID&quot;:&quot;cf6f9317-3148-455e-9ff3-615772f94321&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;25d88332-4131-4cc5-982e-088d1055fd4c&quot;,&quot;parentUUID&quot;:&quot;cf6f9317-3148-455e-9ff3-615772f94321&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;804e6d39-a028-4cb3-8c42-6533874ae166&quot;,&quot;parentUUID&quot;:&quot;cf6f9317-3148-455e-9ff3-615772f94321&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:13,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.collateral = this.collaterals.find(c =&gt; c.deployArgs.name === _test_utils_1.defaultCollateralArgs.name);\nthis.initialBalance = (0, lib_1.toBig)(100000);\nawait this.collateral.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [users.userOne.address]: this.initialBalance,\n});\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [users.userOne.address]: {\n        [hardhat_1.default.Diamond.address]: this.initialBalance,\n    },\n});\n(0, chai_1.expect)(await this.collateral.contract.balanceOf(users.userOne.address)).to.equal(this.initialBalance);\nthis.depositArgs = {\n    user: users.userOne,\n    asset: this.collateral,\n    amount: (0, lib_1.toBig)(10000),\n};&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ffcbfad2-cab7-4e61-bdec-e99789b63d2a&quot;,&quot;parentUUID&quot;:&quot;cf6f9317-3148-455e-9ff3-615772f94321&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;ebbb3985-b647-4b85-8284-751b977c689c&quot;,&quot;title&quot;:&quot;#collateral&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;be9abd34-9105-43e5-8e92-4d8a7ff08452&quot;,&quot;title&quot;:&quot;#deposit&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow an account to deposit whitelisted collateral&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit should allow an account to deposit whitelisted collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:32,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Account has no deposited assets\nconst depositedCollateralAssetsBefore = await hardhat_1.default.Diamond.getDepositedCollateralAssets(this.depositArgs.user.address);\n(0, chai_1.expect)(depositedCollateralAssetsBefore).to.deep.equal([]);\n// Deposit collateral\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.address, this.depositArgs.amount)).not.to.be.reverted;\n// Account now has deposited assets\nconst depositedCollateralAssetsAfter = await hardhat_1.default.Diamond.getDepositedCollateralAssets(this.depositArgs.user.address);\n(0, chai_1.expect)(depositedCollateralAssetsAfter).to.deep.equal([this.collateral.address]);\n// Account&#x27;s collateral deposit balances have increased\n(0, chai_1.expect)(await hardhat_1.default.Diamond.collateralDeposits(this.depositArgs.user.address, this.collateral.address)).to.equal(this.depositArgs.amount);\n// Kresko contract&#x27;s collateral balance has increased\n(0, chai_1.expect)(await this.collateral.contract.balanceOf(hardhat_1.default.Diamond.address)).to.equal(this.depositArgs.amount);\n// Account&#x27;s collateral balance has decreased\n(0, chai_1.expect)((0, lib_1.fromBig)(await this.collateral.contract.balanceOf(users.userOne.address))).to.equal((0, lib_1.fromBig)(this.initialBalance) - (0, lib_1.fromBig)(this.depositArgs.amount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9411285d-f2a2-4c72-896f-afa4aa7916b6&quot;,&quot;parentUUID&quot;:&quot;be9abd34-9105-43e5-8e92-4d8a7ff08452&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an arbitrary account to deposit whitelisted collateral on behalf of another account&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit should allow an arbitrary account to deposit whitelisted collateral on behalf of another account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:39,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Load arbitrary user with sufficient collateral for testing purposes\nconst arbitraryUser = users.userThree;\nawait this.collateral.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [arbitraryUser.address]: this.initialBalance,\n});\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [arbitraryUser.address]: {\n        [hardhat_1.default.Diamond.address]: this.initialBalance,\n    },\n});\n// Initially, the array of the user&#x27;s deposited collateral assets should be empty.\nconst depositedCollateralAssetsBefore = await hardhat_1.default.Diamond.getDepositedCollateralAssets(this.depositArgs.user.address);\n(0, chai_1.expect)(depositedCollateralAssetsBefore).to.deep.equal([]);\n// Deposit collateral\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userThree).depositCollateral(this.depositArgs.user.address, this.collateral.address, this.depositArgs.amount)).not.to.be.reverted;\n// Confirm the array of the user&#x27;s deposited collateral assets has been pushed to.\nconst depositedCollateralAssetsAfter = await hardhat_1.default.Diamond.getDepositedCollateralAssets(this.depositArgs.user.address);\n(0, chai_1.expect)(depositedCollateralAssetsAfter).to.deep.equal([this.collateral.address]);\n// Confirm the amount deposited is recorded for the user.\nconst amountDeposited = await hardhat_1.default.Diamond.collateralDeposits(this.depositArgs.user.address, this.collateral.address);\n(0, chai_1.expect)(amountDeposited).to.equal(this.depositArgs.amount);\n// Confirm the amount as been transferred from the user into Kresko.sol\nconst kreskoBalance = await this.collateral.contract.balanceOf(hardhat_1.default.Diamond.address);\n(0, chai_1.expect)(kreskoBalance).to.equal(this.depositArgs.amount);\n// Confirm the depositor&#x27;s (arbitraryUser) wallet balance has been adjusted accordingly\nconst depositorBalanceAfter = await this.collateral.contract.balanceOf(arbitraryUser.address);\n(0, chai_1.expect)((0, lib_1.fromBig)(depositorBalanceAfter)).to.equal((0, lib_1.fromBig)(this.initialBalance) - (0, lib_1.fromBig)(this.depositArgs.amount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;56d48967-a1e8-41ea-8e88-af6da1d57007&quot;,&quot;parentUUID&quot;:&quot;be9abd34-9105-43e5-8e92-4d8a7ff08452&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to deposit more collateral to an existing deposit&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit should allow an account to deposit more collateral to an existing deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:36,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Deposit first batch of collateral\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.address, this.depositArgs.amount)).not.to.be.reverted;\n// Deposit second batch of collateral\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.address, this.depositArgs.amount)).not.to.be.reverted;\n// Confirm the array of the user&#x27;s deposited collateral assets hasn&#x27;t been double-pushed to.\nconst depositedCollateralAssetsAfter = await hardhat_1.default.Diamond.getDepositedCollateralAssets(this.depositArgs.user.address);\n(0, chai_1.expect)(depositedCollateralAssetsAfter).to.deep.equal([this.collateral.address]);\n// Confirm the amount deposited is recorded for the user.\nconst amountDeposited = await hardhat_1.default.Diamond.collateralDeposits(this.depositArgs.user.address, this.collateral.address);\n(0, chai_1.expect)(amountDeposited).to.equal(this.depositArgs.amount.add(this.depositArgs.amount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1cdc4924-5c60-457f-8968-6aa1acdf667f&quot;,&quot;parentUUID&quot;:&quot;be9abd34-9105-43e5-8e92-4d8a7ff08452&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to have deposited multiple collateral assets&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit should allow an account to have deposited multiple collateral assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1864,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Load user account with a different type of collateral\nconst collateralArgs = {\n    name: \&quot;SecondCollateral\&quot;,\n    price: _test_utils_1.defaultOraclePrice,\n    factor: 1,\n    decimals: _test_utils_1.defaultDecimals,\n};\nconst { contract, mocks } = await (0, collaterals_1.addMockCollateralAsset)(collateralArgs);\nawait mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [users.userOne.address]: this.initialBalance,\n});\nawait mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [users.userOne.address]: {\n        [hardhat_1.default.Diamond.address]: this.initialBalance,\n    },\n});\n// Deposit batch of first collateral type\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.address, this.depositArgs.amount)).not.to.be.reverted;\n// Deposit batch of second collateral type\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(this.depositArgs.user).depositCollateral(this.depositArgs.user.address, contract.address, this.depositArgs.amount)).not.to.be.reverted;\n// Confirm the array of the user&#x27;s deposited collateral assets contains both collateral assets\nconst depositedCollateralAssetsAfter = await hardhat_1.default.Diamond.getDepositedCollateralAssets(this.depositArgs.user.address);\n(0, chai_1.expect)(depositedCollateralAssetsAfter).to.deep.equal([this.collateral.address, contract.address]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1bc85a25-a480-491f-8a0e-8fd7b56a42c9&quot;,&quot;parentUUID&quot;:&quot;be9abd34-9105-43e5-8e92-4d8a7ff08452&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit CollateralDeposited event&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit should emit CollateralDeposited event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:18,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await hardhat_1.default.Diamond.connect(this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.address, this.depositArgs.amount);\nconst event = await (0, lib_1.getInternalEvent)(tx, types_1.MinterEvent__factory.connect(hardhat_1.default.Diamond.address, this.depositArgs.user), \&quot;CollateralDeposited\&quot;);\n(0, chai_1.expect)(event.account).to.equal(this.depositArgs.user.address);\n(0, chai_1.expect)(event.collateralAsset).to.equal(this.collateral.address);\n(0, chai_1.expect)(event.amount).to.equal(this.depositArgs.amount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f2d8780a-8fe0-4526-99b3-9b21b1a8d90e&quot;,&quot;parentUUID&quot;:&quot;be9abd34-9105-43e5-8e92-4d8a7ff08452&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if depositing collateral that has not been whitelisted&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit should revert if depositing collateral that has not been whitelisted&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, chai_1.expect)(hardhat_1.default.Diamond.connect(this.depositArgs.user).depositCollateral(this.depositArgs.user.address, \&quot;0x0000000000000000000000000000000000000001\&quot;, this.depositArgs.amount)).to.be.revertedWith(errors_1.Error.COLLATERAL_DOESNT_EXIST);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b53ceef0-b209-4df5-ae64-a7a5a508257c&quot;,&quot;parentUUID&quot;:&quot;be9abd34-9105-43e5-8e92-4d8a7ff08452&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if depositing an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit should revert if depositing an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:12,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, chai_1.expect)(hardhat_1.default.Diamond.connect(this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.address, 0)).to.be.revertedWith(errors_1.Error.ZERO_DEPOSIT);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cb083990-2079-4cec-abc3-8955cd5143f3&quot;,&quot;parentUUID&quot;:&quot;be9abd34-9105-43e5-8e92-4d8a7ff08452&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if collateral is not depositable&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit should revert if collateral is not depositable&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:63,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const { deployer, devTwo, extOne } = await hardhat_1.default.ethers.getNamedSigners();\nawait (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.DEPOSIT, true, 0], [deployer, devTwo, extOne]);\nconst isDepositPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.DEPOSIT.toString(), this.collateral.address);\n(0, chai_1.expect)(isDepositPaused).to.equal(true);\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.contract.address, 0)).to.be.revertedWith(errors_1.Error.ZERO_DEPOSIT);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d900432b-ee6d-40cb-91e2-2822085c9094&quot;,&quot;parentUUID&quot;:&quot;be9abd34-9105-43e5-8e92-4d8a7ff08452&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9411285d-f2a2-4c72-896f-afa4aa7916b6&quot;,&quot;56d48967-a1e8-41ea-8e88-af6da1d57007&quot;,&quot;1cdc4924-5c60-457f-8968-6aa1acdf667f&quot;,&quot;1bc85a25-a480-491f-8a0e-8fd7b56a42c9&quot;,&quot;f2d8780a-8fe0-4526-99b3-9b21b1a8d90e&quot;,&quot;b53ceef0-b209-4df5-ae64-a7a5a508257c&quot;,&quot;cb083990-2079-4cec-abc3-8955cd5143f3&quot;,&quot;d900432b-ee6d-40cb-91e2-2822085c9094&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2075,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;73bdfc94-f708-44f9-9f5c-624e916a2485&quot;,&quot;title&quot;:&quot;#withdraw&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#withdraw\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw \&quot;before each\&quot; hook in \&quot;#withdraw\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:16,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Deposit collateral\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(this.depositArgs.user).depositCollateral(this.depositArgs.user.address, this.collateral.contract.address, this.depositArgs.amount)).not.to.be.reverted;\nthis.collateral = this.collaterals[0];\nthis.depositAmount = this.depositArgs.amount;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;34b5d6d6-b833-429b-a305-f49b435145d1&quot;,&quot;parentUUID&quot;:&quot;73bdfc94-f708-44f9-9f5c-624e916a2485&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;1cbaed92-905c-4ea7-8b9e-4a47d2d12815&quot;,&quot;title&quot;:&quot;when the account&#x27;s minimum collateral value is 0&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow an account to withdraw their entire deposit&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow an account to withdraw their entire deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:53,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const depositedCollateralAssets = await hardhat_1.default.Diamond.getDepositedCollateralAssets(users.userOne.address);\n(0, chai_1.expect)(depositedCollateralAssets).to.deep.equal([this.collateral.address]);\nawait hardhat_1.default.Diamond.connect(users.userOne).withdrawCollateral(users.userOne.address, this.collateral.address, this.depositAmount, 0);\n// Ensure that the collateral asset is removed from the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssetsPostWithdraw = await hardhat_1.default.Diamond.getDepositedCollateralAssets(users.userOne.address);\n(0, chai_1.expect)(depositedCollateralAssetsPostWithdraw).to.deep.equal([]);\n// Ensure the change in the user&#x27;s deposit is recorded.\nconst amountDeposited = await hardhat_1.default.Diamond.collateralDeposits(users.userOne.address, this.collateral.address);\n(0, chai_1.expect)(amountDeposited).to.equal(0);\n// Ensure the amount transferred is correct\nconst kreskoBalance = await this.collateral.contract.balanceOf(hardhat_1.default.Diamond.address);\n(0, chai_1.expect)(kreskoBalance).to.equal(0);\nconst userOneBalance = await this.collateral.contract.balanceOf(users.userOne.address);\n(0, chai_1.expect)(userOneBalance).to.equal(this.initialBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;53127ca7-f92f-458d-adb6-bab5e4bae3f7&quot;,&quot;parentUUID&quot;:&quot;1cbaed92-905c-4ea7-8b9e-4a47d2d12815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow an account to withdraw a portion of their deposit&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow an account to withdraw a portion of their deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:44,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = this.depositAmount.div(2);\nawait hardhat_1.default.Diamond.connect(users.userOne).withdrawCollateral(users.userOne.address, this.collateral.address, withdrawAmount, 0);\n// Ensure the change in the user&#x27;s deposit is recorded.\nconst amountDeposited = await hardhat_1.default.Diamond.collateralDeposits(users.userOne.address, this.collateral.address);\n(0, chai_1.expect)(amountDeposited).to.equal(this.depositAmount.sub(withdrawAmount));\n// Ensure that the collateral asset is still in the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssets = await hardhat_1.default.Diamond.getDepositedCollateralAssets(users.userOne.address);\n(0, chai_1.expect)(depositedCollateralAssets).to.deep.equal([this.collateral.address]);\nconst kreskoBalance = await this.collateral.contract.balanceOf(hardhat_1.default.Diamond.address);\n(0, chai_1.expect)(kreskoBalance).to.equal(this.depositAmount.sub(withdrawAmount));\nconst userOneBalance = await this.collateral.contract.balanceOf(users.userOne.address);\n(0, chai_1.expect)(userOneBalance).to.equal(this.initialBalance.sub(amountDeposited));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;90661f0e-1bb9-47dc-939e-5c824d712471&quot;,&quot;parentUUID&quot;:&quot;1cbaed92-905c-4ea7-8b9e-4a47d2d12815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to withdraw another accounts deposit&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should allow trusted address to withdraw another accounts deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:54,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Grant userThree the MANAGER role\nawait hardhat_1.default.Diamond.connect(users.deployer).grantRole(_test_utils_1.Role.MANAGER, users.userThree.address);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.hasRole(_test_utils_1.Role.MANAGER, users.userThree.address)).to.equal(true);\nconst collateralBefore = await hardhat_1.default.Diamond.collateralDeposits(users.userOne.address, this.collateral.address);\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userThree).withdrawCollateral(users.userOne.address, this.collateral.address, this.depositAmount, 0)).to.not.be.reverted;\nconst collateralAfter = await hardhat_1.default.Diamond.collateralDeposits(users.userOne.address, this.collateral.address);\n// Ensure that collateral was withdrawn\n(0, chai_1.expect)(collateralAfter).to.equal(collateralBefore.sub(this.depositAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a3ab4df2-e58d-4dbe-8605-f9b7926a45eb&quot;,&quot;parentUUID&quot;:&quot;1cbaed92-905c-4ea7-8b9e-4a47d2d12815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit CollateralWithdrawn event&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should emit CollateralWithdrawn event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await hardhat_1.default.Diamond.connect(users.userOne).withdrawCollateral(users.userOne.address, this.collateral.address, this.depositAmount, 0);\nconst event = await (0, lib_1.getInternalEvent)(tx, types_1.MinterEvent__factory.connect(hardhat_1.default.Diamond.address, users.userOne), \&quot;CollateralWithdrawn\&quot;);\n(0, chai_1.expect)(event.account).to.equal(users.userOne.address);\n(0, chai_1.expect)(event.collateralAsset).to.equal(this.collateral.address);\n(0, chai_1.expect)(event.amount).to.equal(this.depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;df369ff5-3112-4e16-b51b-d6de8e72fc4e&quot;,&quot;parentUUID&quot;:&quot;1cbaed92-905c-4ea7-8b9e-4a47d2d12815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted address to withdraw another accounts deposit&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw when the account&#x27;s minimum collateral value is 0 should not allow untrusted address to withdraw another accounts deposit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:34,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userThree).withdrawCollateral(users.userOne.address, this.collateral.address, this.initialBalance, 0)).to.be.revertedWith(`AccessControl: account ${users.userThree.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c53172b4-cdd8-4809-bfe2-2013edd7fbf4&quot;,&quot;parentUUID&quot;:&quot;1cbaed92-905c-4ea7-8b9e-4a47d2d12815&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;cd4b35f5-c63f-4871-a078-6f50563bdb24&quot;,&quot;title&quot;:&quot;when the account&#x27;s minimum collateral value is &gt; 0&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;when the account&#x27;s minimum collateral value is &gt; 0\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 \&quot;before each\&quot; hook in \&quot;when the account&#x27;s minimum collateral value is &gt; 0\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:58,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.krAsset = hardhat_1.default.krAssets.find(asset =&gt; asset.deployArgs.symbol === _test_utils_1.defaultKrAssetArgs.symbol);\n// userOne mints some kr assets\nthis.mintAmount = (0, lib_1.toBig)(100);\nawait hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, this.mintAmount);\n// Mint amount differs from deposited amount due to open fee\nconst amountDeposited = await hardhat_1.default.Diamond.collateralDeposits(users.userOne.address, this.collateral.address);\nthis.initialUserOneDeposited = amountDeposited;\nthis.mcr = await hardhat_1.default.Diamond.minimumCollateralizationRatio();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d583d61c-1779-4f7b-8233-916e1c9cfdfe&quot;,&quot;parentUUID&quot;:&quot;cd4b35f5-c63f-4871-a078-6f50563bdb24&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow an account to withdraw their deposit if it does not violate the health factor&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should allow an account to withdraw their deposit if it does not violate the health factor&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:121,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = (0, lib_1.toBig)(10);\n// Ensure that the withdrawal would not put the account&#x27;s collateral value\n// less than the account&#x27;s minimum collateral value:\nconst accountMinCollateralValue = await hardhat_1.default.Diamond.getAccountMinimumCollateralValueAtRatio(users.userOne.address, this.mcr);\nconst accountCollateralValue = await hardhat_1.default.Diamond.getAccountCollateralValue(users.userOne.address);\nconst [withdrawnCollateralValue] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.collateral.address, withdrawAmount, false);\n(0, chai_1.expect)(accountCollateralValue.rawValue\n    .sub(withdrawnCollateralValue.rawValue)\n    .gte(accountMinCollateralValue.rawValue)).to.be.true;\nawait hardhat_1.default.Diamond.connect(users.userOne).withdrawCollateral(users.userOne.address, this.collateral.address, withdrawAmount, 0);\n// Ensure that the collateral asset is still in the account&#x27;s deposited collateral\n// assets array.\nconst depositedCollateralAssets = await hardhat_1.default.Diamond.getDepositedCollateralAssets(users.userOne.address);\n(0, chai_1.expect)(depositedCollateralAssets).to.deep.equal([this.collateral.address]);\n// Ensure the change in the user&#x27;s deposit is recorded.\nconst amountDeposited = await hardhat_1.default.Diamond.collateralDeposits(users.userOne.address, this.collateral.address);\n(0, chai_1.expect)(amountDeposited).to.equal(this.depositAmount.sub(withdrawAmount));\n// Check the balances of the contract and user\nconst kreskoBalance = await this.collateral.contract.balanceOf(hardhat_1.default.Diamond.address);\n(0, chai_1.expect)(kreskoBalance).to.equal(this.depositAmount.sub(withdrawAmount));\nconst userOneBalance = await this.collateral.contract.balanceOf(users.userOne.address);\n(0, chai_1.expect)(userOneBalance).to.equal(this.initialBalance.sub(this.depositAmount.sub(withdrawAmount)));\n// Ensure the account&#x27;s minimum collateral value is &lt;= the account collateral value\n// These are FixedPoint.Unsigned, be sure to use `rawValue` when appropriate!\nconst accountMinCollateralValueAfter = await hardhat_1.default.Diamond.getAccountMinimumCollateralValueAtRatio(users.userOne.address, this.mcr);\nconst accountCollateralValueAfter = await hardhat_1.default.Diamond.getAccountCollateralValue(users.userOne.address);\n(0, chai_1.expect)(accountMinCollateralValueAfter.rawValue.lte(accountCollateralValueAfter.rawValue)).to.be\n    .true;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ce4fab08-74a6-48fa-86c9-1719257f7093&quot;,&quot;parentUUID&quot;:&quot;cd4b35f5-c63f-4871-a078-6f50563bdb24&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow withdraws that exceed deposits and only send the user total deposit available&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should allow withdraws that exceed deposits and only send the user total deposit available&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:88,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const user = users.userFour;\nawait this.collateral.setBalance(user, ethers_1.BigNumber.from(0));\nawait this.collateral.setBalance(user, (0, lib_1.toBig)(1000));\nawait this.collateral.contract\n    .connect(user)\n    .approve(hardhat_1.default.Diamond.address, hardhat_1.default.ethers.constants.MaxUint256);\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: (0, lib_1.toBig)(1000),\n    user,\n});\nawait (0, collaterals_1.withdrawCollateral)({\n    asset: this.collateral,\n    amount: (0, lib_1.toBig)(1010),\n    user,\n});\n(0, chai_1.expect)(await this.collateral.contract.balanceOf(user.address)).to.equal((0, lib_1.toBig)(1000));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ae0b6d7d-7177-4def-9b9d-3b638a37f09d&quot;,&quot;parentUUID&quot;:&quot;cd4b35f5-c63f-4871-a078-6f50563bdb24&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if withdrawing an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if withdrawing an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:15,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = 0;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).withdrawCollateral(users.userOne.address, this.collateral.address, 0, withdrawAmount)).to.be.revertedWith(errors_1.Error.ZERO_WITHDRAW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;845b6d17-10d4-41e6-af64-219fc0ed5eca&quot;,&quot;parentUUID&quot;:&quot;cd4b35f5-c63f-4871-a078-6f50563bdb24&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if the withdrawal violates the health factor&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if the withdrawal violates the health factor&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:66,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// userOne has a debt position, so attempting to withdraw the entire collateral deposit should be impossible\nconst withdrawAmount = this.initialBalance;\n// Ensure that the withdrawal would in fact put the account&#x27;s collateral value\n// less than the account&#x27;s minimum collateral value:\nconst accountMinCollateralValue = await hardhat_1.default.Diamond.getAccountMinimumCollateralValueAtRatio(users.userOne.address, this.mcr);\nconst accountCollateralValue = await hardhat_1.default.Diamond.getAccountCollateralValue(users.userOne.address);\nconst [withdrawnCollateralValue] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.collateral.address, withdrawAmount, false);\n(0, chai_1.expect)(accountCollateralValue.rawValue\n    .sub(withdrawnCollateralValue.rawValue)\n    .lt(accountMinCollateralValue.rawValue)).to.be.true;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).withdrawCollateral(users.userOne.address, this.collateral.address, withdrawAmount, 0)).to.be.revertedWith(errors_1.Error.COLLATERAL_INSUFFICIENT_AMOUNT);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c073eed7-7961-4c6f-95c4-e1bcf217cf7b&quot;,&quot;parentUUID&quot;:&quot;cd4b35f5-c63f-4871-a078-6f50563bdb24&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should revert if the depositedCollateralAssetIndex is incorrect&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw when the account&#x27;s minimum collateral value is 0 when the account&#x27;s minimum collateral value is &gt; 0 should revert if the depositedCollateralAssetIndex is incorrect&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:9,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const withdrawAmount = this.depositAmount.div(2);\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).withdrawCollateral(users.userOne.address, this.collateral.address, withdrawAmount, 1)).to.be.revertedWith(errors_1.Error.ARRAY_OUT_OF_BOUNDS);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4b9613c4-46a1-4438-a7bc-e0dc7f117248&quot;,&quot;parentUUID&quot;:&quot;cd4b35f5-c63f-4871-a078-6f50563bdb24&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;ce4fab08-74a6-48fa-86c9-1719257f7093&quot;,&quot;ae0b6d7d-7177-4def-9b9d-3b638a37f09d&quot;,&quot;845b6d17-10d4-41e6-af64-219fc0ed5eca&quot;,&quot;c073eed7-7961-4c6f-95c4-e1bcf217cf7b&quot;,&quot;4b9613c4-46a1-4438-a7bc-e0dc7f117248&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:299,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[&quot;53127ca7-f92f-458d-adb6-bab5e4bae3f7&quot;,&quot;90661f0e-1bb9-47dc-939e-5c824d712471&quot;,&quot;a3ab4df2-e58d-4dbe-8605-f9b7926a45eb&quot;,&quot;df369ff5-3112-4e16-b51b-d6de8e72fc4e&quot;,&quot;c53172b4-cdd8-4809-bfe2-2013edd7fbf4&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:214,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;66533b33-d973-435b-babf-bf2d412b04b3&quot;,&quot;title&quot;:&quot;#deposit - rebase events&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#deposit - rebase events\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit - rebase events \&quot;before each\&quot; hook in \&quot;#deposit - rebase events\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:121,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;arbitraryUser = hardhat_1.default.users.userThree;\narbitraryUserDiamond = hardhat_1.default.Diamond.connect(arbitraryUser);\nawait this.collateral.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [arbitraryUser.address]: this.initialBalance,\n});\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [arbitraryUser.address]: {\n        [hardhat_1.default.Diamond.address]: this.initialBalance,\n    },\n});\nthis.krAsset = this.krAssets.find(k =&gt; k.deployArgs.name === _test_utils_1.defaultKrAssetArgs.name);\n// grant operator role to deployer for rebases\nawait this.krAsset.contract.grantRole(_test_utils_1.Role.OPERATOR, users.deployer.address);\nconst assetInfo = await this.krAsset.kresko();\n// Add krAsset as a collateral with anchor and cFactor of 1\nawait hardhat_1.default.Diamond.connect(users.operator).addCollateralAsset(this.krAsset.contract.address, this.krAsset.anchor.address, hardhat_1.default.toBig(1), assetInfo.oracle);\n// Allowance for Kresko\nawait this.krAsset.contract\n    .connect(arbitraryUser)\n    .approve(hardhat_1.default.Diamond.address, hardhat_1.default.ethers.constants.MaxUint256);\n// Deposit some collateral\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.collateral.address, this.depositArgs.amount);\n// Mint some krAssets\nawait arbitraryUserDiamond.mintKreskoAsset(arbitraryUser.address, this.krAsset.address, mintAmount);\n// Deposit all debt on tests\nthis.krAssetCollateralAmount = await arbitraryUserDiamond.kreskoAssetDebt(arbitraryUser.address, this.krAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e7fb13a8-ec15-4116-9a88-4ee70a922ce6&quot;,&quot;parentUUID&quot;:&quot;66533b33-d973-435b-babf-bf2d412b04b3&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;f68d3e9c-200d-49ee-af34-1da765fa5f71&quot;,&quot;title&quot;:&quot;deposit amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when deposit is made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit - rebase events deposit amounts are calculated correctly when deposit is made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:60,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst expectedDepositsAfter = this.krAssetCollateralAmount.mul(denominator);\nconst depositsBefore = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nconst finalDeposits = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, chai_1.expect)(depositsBefore).to.not.bignumber.equal(finalDeposits);\n(0, chai_1.expect)(finalDeposits).to.bignumber.equal(expectedDepositsAfter);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ef6b0228-04a8-4473-a2ec-d4446787674d&quot;,&quot;parentUUID&quot;:&quot;f68d3e9c-200d-49ee-af34-1da765fa5f71&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit - rebase events deposit amounts are calculated correctly when deposit is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:62,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst depositAmountAfterRebase = this.krAssetCollateralAmount.div(denominator);\n// Deposit\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst depositsBefore = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nconst finalDeposits = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, chai_1.expect)(depositsBefore).to.not.bignumber.equal(finalDeposits);\n(0, chai_1.expect)(finalDeposits).to.bignumber.equal(depositAmountAfterRebase);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c22732dd-bb15-4b2c-9ba1-a0614eb36272&quot;,&quot;parentUUID&quot;:&quot;f68d3e9c-200d-49ee-af34-1da765fa5f71&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit - rebase events deposit amounts are calculated correctly when deposit is made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:59,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\nconst depositsBefore = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Deposit after the rebase\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, depositAmount);\n// Get collateral deposits after\nconst finalDeposits = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, chai_1.expect)(depositsBefore).to.not.bignumber.equal(finalDeposits);\n(0, chai_1.expect)(finalDeposits).to.bignumber.equal(depositAmount);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bb44d8d5-0080-40c3-ae20-3b5a7e67ba76&quot;,&quot;parentUUID&quot;:&quot;f68d3e9c-200d-49ee-af34-1da765fa5f71&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit - rebase events deposit amounts are calculated correctly when deposit is made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:62,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\nconst depositsBefore = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Deposit after the rebase\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, depositAmount);\n// Get collateral deposits after\nconst finalDeposits = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, chai_1.expect)(depositsBefore).to.not.bignumber.equal(finalDeposits);\n(0, chai_1.expect)(finalDeposits).to.bignumber.equal(depositAmount);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3d524f9d-7435-439c-9021-61bc7bc52219&quot;,&quot;parentUUID&quot;:&quot;f68d3e9c-200d-49ee-af34-1da765fa5f71&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit - rebase events deposit amounts are calculated correctly when deposit is made before and after a positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:83,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Get deposits after\nconst depositsAfter = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, chai_1.expect)(depositsAfter).to.bignumber.equal(halfDepositAfterRebase);\n// Deposit second time\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositAfterRebase);\n// Get deposits after\nconst finalDeposits = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n(0, chai_1.expect)(finalDeposits).to.bignumber.equal(fullDepositAmount);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0792a5f4-ccee-4418-b0f5-b94bf28964b4&quot;,&quot;parentUUID&quot;:&quot;f68d3e9c-200d-49ee-af34-1da765fa5f71&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit - rebase events deposit amounts are calculated correctly when deposit is made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:86,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositBeforeRebase);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Get deposits after\nconst depositsAfterRebase = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, chai_1.expect)(depositsAfterRebase).to.bignumber.equal(halfDepositAfterRebase);\n// Deposit second time\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositAfterRebase);\n// Get deposits after\nconst finalDeposits = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n(0, chai_1.expect)(finalDeposits).to.bignumber.equal(fullDepositAmount);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9f50e1e8-7150-40da-9160-a7c6697375d6&quot;,&quot;parentUUID&quot;:&quot;f68d3e9c-200d-49ee-af34-1da765fa5f71&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;ef6b0228-04a8-4473-a2ec-d4446787674d&quot;,&quot;c22732dd-bb15-4b2c-9ba1-a0614eb36272&quot;,&quot;bb44d8d5-0080-40c3-ae20-3b5a7e67ba76&quot;,&quot;3d524f9d-7435-439c-9021-61bc7bc52219&quot;,&quot;0792a5f4-ccee-4418-b0f5-b94bf28964b4&quot;,&quot;9f50e1e8-7150-40da-9160-a7c6697375d6&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:412,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;b80b0b40-2e9f-495d-953c-745cb97ca61b&quot;,&quot;title&quot;:&quot;deposit usd values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when deposit is made before positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit - rebase events deposit usd values are calculated correctly when deposit is made before positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:81,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst valueBefore = await hardhat_1.default.Diamond.getAccountCollateralValue(arbitraryUser.address);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\nthis.krAsset.setPrice(newPrice);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Get collateral value of account after\nconst valueAfter = await hardhat_1.default.Diamond.getAccountCollateralValue(arbitraryUser.address);\n// Ensure that the collateral value stays the same\n(0, chai_1.expect)(valueBefore.rawValue).to.bignumber.equal(valueAfter.rawValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;36bd192f-d7e0-4f7a-941f-be231d09c7ce&quot;,&quot;parentUUID&quot;:&quot;b80b0b40-2e9f-495d-953c-745cb97ca61b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit - rebase events deposit usd values are calculated correctly when deposit is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:84,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst valueBefore = await hardhat_1.default.Diamond.getAccountCollateralValue(arbitraryUser.address);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\nthis.krAsset.setPrice(newPrice);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Get collateral value of account after\nconst valueAfter = await hardhat_1.default.Diamond.getAccountCollateralValue(arbitraryUser.address);\n// Ensure that the collateral value stays the same\n(0, chai_1.expect)(valueBefore.rawValue).to.bignumber.equal(valueAfter.rawValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7abdef40-3d90-4fda-a914-8ce4fc788665&quot;,&quot;parentUUID&quot;:&quot;b80b0b40-2e9f-495d-953c-745cb97ca61b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit - rebase events deposit usd values are calculated correctly when deposit is made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:62,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\n// Get expected value before rebase and deposit\nconst [expectedValue] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, this.krAssetCollateralAmount, false);\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Deposit rebased amount after\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, depositAmount);\n// Get collateral value of account after\nconst [valueAfter] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, depositAmount, false);\n// Ensure that the collateral value stays the same\n(0, chai_1.expect)(expectedValue.rawValue).to.bignumber.equal(valueAfter.rawValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;35c64391-75e8-46f9-afa8-8dfb089a69f0&quot;,&quot;parentUUID&quot;:&quot;b80b0b40-2e9f-495d-953c-745cb97ca61b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit - rebase events deposit usd values are calculated correctly when deposit is made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:64,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\n// Get expected value before rebase and deposit\nconst [expectedValue] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, this.krAssetCollateralAmount, false);\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Deposit rebased amount after\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, depositAmount);\n// Get collateral value of account after\nconst [valueAfter] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, depositAmount, false);\n// Ensure that the collateral value stays the same\n(0, chai_1.expect)(expectedValue.rawValue).to.bignumber.equal(valueAfter.rawValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3b5e69e3-e27c-4a6a-8d59-5cea9f74fb2c&quot;,&quot;parentUUID&quot;:&quot;b80b0b40-2e9f-495d-953c-745cb97ca61b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit - rebase events deposit usd values are calculated correctly when deposit is made before and after a positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:105,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositBeforeRebase);\nconst [expectedValue] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, halfDepositBeforeRebase, false);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Get value after\nconst [valueAfterRebase] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, halfDepositAfterRebase, false);\n// Ensure that the collateral value stays the same\n(0, chai_1.expect)(expectedValue.rawValue).to.bignumber.equal(valueAfterRebase.rawValue);\n// Calculate added value since price adjusted in the rebase\nconst [expectedValueAfterSecondDeposit] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, fullDepositAmount, false);\n// Deposit more\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositAfterRebase);\n// Get value\nconst [finalValue] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral value stays the same\n(0, chai_1.expect)(finalValue.rawValue).to.bignumber.equal(expectedValueAfterSecondDeposit.rawValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;707a3130-7514-4f82-8a43-9ccad5302944&quot;,&quot;parentUUID&quot;:&quot;b80b0b40-2e9f-495d-953c-745cb97ca61b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when deposit is made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #deposit - rebase events deposit usd values are calculated correctly when deposit is made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:105,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\n// Deposit half before, half after\nconst halfDepositBeforeRebase = this.krAssetCollateralAmount.div(2);\nconst halfDepositAfterRebase = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositBeforeRebase);\nconst [expectedValue] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, halfDepositBeforeRebase, false);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Get value after\nconst [valueAfterRebase] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, halfDepositAfterRebase, false);\n// Ensure that the collateral value stays the same\n(0, chai_1.expect)(expectedValue.rawValue).to.bignumber.equal(valueAfterRebase.rawValue);\n// Calculate added value since price adjusted in the rebase\nconst [expectedValueAfterSecondDeposit] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.krAsset.address, fullDepositAmount, false);\n// Deposit more\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, halfDepositAfterRebase);\n// Get deposits after\nconst [finalValue] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral value stays the same\n(0, chai_1.expect)(finalValue.rawValue).to.bignumber.equal(expectedValueAfterSecondDeposit.rawValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1ef8ce65-7f21-484c-b7d7-669fd7dc9efe&quot;,&quot;parentUUID&quot;:&quot;b80b0b40-2e9f-495d-953c-745cb97ca61b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;36bd192f-d7e0-4f7a-941f-be231d09c7ce&quot;,&quot;7abdef40-3d90-4fda-a914-8ce4fc788665&quot;,&quot;35c64391-75e8-46f9-afa8-8dfb089a69f0&quot;,&quot;3b5e69e3-e27c-4a6a-8d59-5cea9f74fb2c&quot;,&quot;707a3130-7514-4f82-8a43-9ccad5302944&quot;,&quot;1ef8ce65-7f21-484c-b7d7-669fd7dc9efe&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:501,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;1b25d53c-5a1c-48c9-8dea-bc1e982feff4&quot;,&quot;title&quot;:&quot;#withdraw - rebase events&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#withdraw - rebase events\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events \&quot;before each\&quot; hook in \&quot;#withdraw - rebase events\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:746,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;arbitraryUser = users.userThree;\narbitraryUserDiamond = hardhat_1.default.Diamond.connect(arbitraryUser);\nawait this.collateral.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [arbitraryUser.address]: this.initialBalance,\n});\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [arbitraryUser.address]: {\n        [hardhat_1.default.Diamond.address]: this.initialBalance,\n    },\n});\nthis.krAsset = this.krAssets.find(k =&gt; k.deployArgs.name === _test_utils_1.defaultKrAssetArgs.name);\n// grant operator role to deployer for rebases\nawait this.krAsset.contract.grantRole(_test_utils_1.Role.OPERATOR, users.deployer.address);\nconst assetInfo = await this.krAsset.kresko();\n// Add krAsset as a collateral with anchor and cFactor of 1\nawait hardhat_1.default.Diamond.connect(users.operator).addCollateralAsset(this.krAsset.contract.address, this.krAsset.anchor.address, hardhat_1.default.toBig(1), assetInfo.oracle);\n// Allowance for Kresko\nawait this.krAsset.contract\n    .connect(arbitraryUser)\n    .approve(hardhat_1.default.Diamond.address, hardhat_1.default.ethers.constants.MaxUint256);\n// Deposit some collateral\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.collateral.address, this.depositArgs.amount);\n// Mint some krAssets\nawait arbitraryUserDiamond.mintKreskoAsset(arbitraryUser.address, this.krAsset.address, mintAmount);\n// Deposit all debt on tests\nthis.krAssetCollateralAmount = await arbitraryUserDiamond.kreskoAssetDebt(arbitraryUser.address, this.krAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6e5c7633-1904-4c0a-8cc5-cf8455d7abe6&quot;,&quot;parentUUID&quot;:&quot;1b25d53c-5a1c-48c9-8dea-bc1e982feff4&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;608f083d-486e-414d-95cb-d24b0be2a8ce&quot;,&quot;title&quot;:&quot;withdraw amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when withdrawing a deposit made before positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a deposit made before positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:127,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Deposit collateral before rebase\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nconst depositsAfter = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, chai_1.expect)(depositsAfter).to.bignumber.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount, cIndex);\nconst finalDeposits = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\nconst finalBalance = await this.krAsset.contract.balanceOf(arbitraryUser.address);\n(0, chai_1.expect)(finalDeposits).to.equal(0);\n(0, chai_1.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b0ec7ce3-b4e4-4bf0-8e19-b1296ad2f918&quot;,&quot;parentUUID&quot;:&quot;608f083d-486e-414d-95cb-d24b0be2a8ce&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a deposit made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:125,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit collateral before rebase\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nconst depositsAfter = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is adjusted by the rebase\n(0, chai_1.expect)(depositsAfter).to.bignumber.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount, cIndex);\nconst finalDeposits = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\nconst finalBalance = await this.krAsset.contract.balanceOf(arbitraryUser.address);\n(0, chai_1.expect)(finalDeposits).to.equal(0);\n(0, chai_1.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a3ba524b-322d-4799-9880-1e4293ae1129&quot;,&quot;parentUUID&quot;:&quot;608f083d-486e-414d-95cb-d24b0be2a8ce&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a deposit made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:122,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Deposit after the rebase\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Get collateral deposits after\nconst depositsAfter = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, chai_1.expect)(depositsAfter).to.bignumber.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount, cIndex);\nconst finalDeposits = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\nconst finalBalance = await this.krAsset.contract.balanceOf(arbitraryUser.address);\n(0, chai_1.expect)(finalDeposits).to.equal(0);\n(0, chai_1.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;79e7ebfd-ddd5-444c-8b09-f5e1c2a620fe&quot;,&quot;parentUUID&quot;:&quot;608f083d-486e-414d-95cb-d24b0be2a8ce&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a deposit made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:123,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Deposit after the rebase\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Get collateral deposits after\nconst depositsAfter = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral balance is what was deposited as no rebases occured after\n(0, chai_1.expect)(depositsAfter).to.bignumber.equal(rebasedDepositAmount);\n// Withdraw rebased amount\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount, cIndex);\nconst finalDeposits = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\nconst finalBalance = await this.krAsset.contract.balanceOf(arbitraryUser.address);\n(0, chai_1.expect)(finalDeposits).to.equal(0);\n(0, chai_1.expect)(finalBalance).to.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a1d4586d-376f-405d-bbfb-c7869f8ce0c8&quot;,&quot;parentUUID&quot;:&quot;608f083d-486e-414d-95cb-d24b0be2a8ce&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a deposit made before and after a positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:155,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Deposit half before, half (rebase adjusted) after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Deposit before the rebase\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, firstDepositAmount);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Get deposits before\nconst depositsFirst = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n(0, chai_1.expect)(depositsFirst).to.bignumber.equal(firstDepositAmount);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Deposit after the rebase\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, secondDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure deposit balance matches expected\n(0, chai_1.expect)(depositsAfter).to.bignumber.equal(fullDepositAmount);\n// Withdraw rebased amount\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.krAsset.address, fullDepositAmount, cIndex);\nconst finalDeposits = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\nconst finalBalance = await this.krAsset.contract.balanceOf(arbitraryUser.address);\n(0, chai_1.expect)(finalDeposits).to.equal(0);\n(0, chai_1.expect)(finalBalance).to.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f26acdc3-a00d-40ac-87d4-a982cc3c23ba&quot;,&quot;parentUUID&quot;:&quot;608f083d-486e-414d-95cb-d24b0be2a8ce&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a deposit made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:158,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Deposit half before, half (rebase adjusted) after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).div(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit before the rebase\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, firstDepositAmount);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Get deposits before\nconst depositsFirst = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n(0, chai_1.expect)(depositsFirst).to.bignumber.equal(firstDepositAmount);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Deposit after the rebase\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, secondDepositAmount);\n// Get collateral deposits after\nconst depositsAfter = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\n// Ensure deposit balance matches expected\n(0, chai_1.expect)(depositsAfter).to.bignumber.equal(fullDepositAmount);\n// Withdraw rebased amount\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.krAsset.address, fullDepositAmount, cIndex);\nconst finalDeposits = await hardhat_1.default.Diamond.collateralDeposits(arbitraryUser.address, this.krAsset.address);\nconst finalBalance = await this.krAsset.contract.balanceOf(arbitraryUser.address);\n(0, chai_1.expect)(finalDeposits).to.equal(0);\n(0, chai_1.expect)(finalBalance).to.bignumber.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;03dfb66c-63f0-4d35-a6be-526b45db46f9&quot;,&quot;parentUUID&quot;:&quot;608f083d-486e-414d-95cb-d24b0be2a8ce&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a non-rebased collateral after a rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw amounts are calculated correctly when withdrawing a non-rebased collateral after a rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:98,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\nconst withdrawAmount = (0, lib_1.toBig)(10);\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst nrcBalanceBefore = await this.collateral.contract.balanceOf(arbitraryUser.address);\nconst expectedNrcBalanceAfter = nrcBalanceBefore.add(withdrawAmount);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.collateral.address);\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.collateral.address, withdrawAmount, cIndex);\n(0, chai_1.expect)(await this.collateral.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(expectedNrcBalanceAfter);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d9d656cf-3c34-478e-8b20-b7f77041d0c9&quot;,&quot;parentUUID&quot;:&quot;608f083d-486e-414d-95cb-d24b0be2a8ce&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b0ec7ce3-b4e4-4bf0-8e19-b1296ad2f918&quot;,&quot;a3ba524b-322d-4799-9880-1e4293ae1129&quot;,&quot;79e7ebfd-ddd5-444c-8b09-f5e1c2a620fe&quot;,&quot;a1d4586d-376f-405d-bbfb-c7869f8ce0c8&quot;,&quot;f26acdc3-a00d-40ac-87d4-a982cc3c23ba&quot;,&quot;03dfb66c-63f0-4d35-a6be-526b45db46f9&quot;,&quot;d9d656cf-3c34-478e-8b20-b7f77041d0c9&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:908,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;3e943093-baf2-4589-9c84-9080a9fb24cf&quot;,&quot;title&quot;:&quot;withdraw usd values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/02-deposit-withdraw.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when withdrawing a deposit made before positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrawing a deposit made before positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:118,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount, cIndex);\nconst [finalValue] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.krAsset.address);\n(0, chai_1.expect)(finalValue.rawValue).to.equal(0);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1b3388f3-00b3-4527-92d0-0f7e07d47ae2&quot;,&quot;parentUUID&quot;:&quot;3e943093-baf2-4589-9c84-9080a9fb24cf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrawing a deposit made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:120,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\nconst rebasedDepositAmount = this.krAssetCollateralAmount.div(denominator);\n// Deposit\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Withdraw the full rebased amount\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.krAsset.address, rebasedDepositAmount, cIndex);\n// Get value\nconst [finalValue] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.krAsset.address);\n(0, chai_1.expect)(finalValue.rawValue).to.equal(0);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(rebasedDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;71541b6b-5f6f-4521-b5bd-8aef1dadea96&quot;,&quot;parentUUID&quot;:&quot;3e943093-baf2-4589-9c84-9080a9fb24cf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrwaing a deposit made after an positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrwaing a deposit made after an positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:121,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\nconst depositAmount = this.krAssetCollateralAmount.mul(denominator);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Deposit rebased amount after\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, depositAmount);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Withdraw the full rebased amount\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.krAsset.address, depositAmount, cIndex);\n// Get value\nconst [finalValue] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.krAsset.address);\n(0, chai_1.expect)(finalValue.rawValue).to.equal(0);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c9e66cd1-5f5f-42ba-9573-7933ea3b75f2&quot;,&quot;parentUUID&quot;:&quot;3e943093-baf2-4589-9c84-9080a9fb24cf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made after an negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrawing a deposit made after an negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:128,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\nconst depositAmount = this.krAssetCollateralAmount.div(denominator);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Deposit rebased amount after\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, depositAmount);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Withdraw the full rebased amount\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.krAsset.address, depositAmount, cIndex);\n// Get value\nconst [finalValue] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.krAsset.address);\n(0, chai_1.expect)(finalValue.rawValue).to.equal(0);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;aeac293d-1600-4278-ad49-3c99d9c7ce37&quot;,&quot;parentUUID&quot;:&quot;3e943093-baf2-4589-9c84-9080a9fb24cf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a positiveing rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrawing a deposit made before and after a positiveing rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:166,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\n// Deposit half before, half after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(2).mul(denominator);\nconst fullDepositAmount = this.krAssetCollateralAmount.mul(denominator);\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, firstDepositAmount);\nconst [expectedValue] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Get value after\nconst [valueAfterRebase] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral value stays the same\n(0, chai_1.expect)(expectedValue.rawValue).to.bignumber.equal(valueAfterRebase.rawValue);\n// Deposit more\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, secondDepositAmount);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Withdraw the full rebased amount\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.krAsset.address, fullDepositAmount, cIndex);\n// Get value\nconst [finalValue] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.krAsset.address);\n(0, chai_1.expect)(finalValue.rawValue).to.equal(0);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;af42189e-63d3-4140-aa36-5d841b37590d&quot;,&quot;parentUUID&quot;:&quot;3e943093-baf2-4589-9c84-9080a9fb24cf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a deposit made before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrawing a deposit made before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:171,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) * denominator;\n// Deposit half before, half after\nconst firstDepositAmount = this.krAssetCollateralAmount.div(2);\nconst secondDepositAmount = this.krAssetCollateralAmount.div(denominator).div(2);\nconst fullDepositAmount = this.krAssetCollateralAmount.div(denominator);\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, firstDepositAmount);\nconst [expectedValue] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.krAsset.address);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Get value after\nconst [valueAfterRebase] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.krAsset.address);\n// Ensure that the collateral value stays the same\n(0, chai_1.expect)(expectedValue.rawValue).to.bignumber.equal(valueAfterRebase.rawValue);\n// Deposit more\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, secondDepositAmount);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.krAsset.address);\n// Withdraw the full rebased amount\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.krAsset.address, fullDepositAmount, cIndex);\n// Get value\nconst [finalValue] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.krAsset.address);\n(0, chai_1.expect)(finalValue.rawValue).to.equal(0);\n(0, chai_1.expect)(await this.krAsset.contract.balanceOf(arbitraryUser.address)).to.bignumber.equal(fullDepositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8979cc34-705a-4133-ba23-6758abec2b90&quot;,&quot;parentUUID&quot;:&quot;3e943093-baf2-4589-9c84-9080a9fb24cf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when withdrawing a non-rebased collateral after a rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #collateral #withdraw - rebase events withdraw usd values are calculated correctly when withdrawing a non-rebased collateral after a rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:173,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst newPrice = (0, lib_1.fromBig)(await this.krAsset.getPrice(), 8) / denominator;\nconst withdrawAmount = (0, lib_1.toBig)(10);\nawait arbitraryUserDiamond.depositCollateral(arbitraryUser.address, this.krAsset.address, this.krAssetCollateralAmount);\nconst accountValueBefore = await hardhat_1.default.Diamond.getAccountCollateralValue(arbitraryUser.address);\nconst [nrcValueBefore] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.collateral.address);\nconst [withdrawValue] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.collateral.address, withdrawAmount, false);\nconst expectedNrcValueAfter = nrcValueBefore.rawValue.sub(withdrawValue.rawValue);\n// Rebase the asset according to params\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nconst cIndex = await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(arbitraryUser.address, this.collateral.address);\nawait arbitraryUserDiamond.withdrawCollateral(arbitraryUser.address, this.collateral.address, withdrawAmount, cIndex);\nconst finalAccountValue = await hardhat_1.default.Diamond.getAccountCollateralValue(arbitraryUser.address);\nconst [finalValue] = await hardhat_1.default.Diamond.getAccountSingleCollateralValueAndRealValue(arbitraryUser.address, this.collateral.address);\n(0, chai_1.expect)(finalValue.rawValue).to.equal(expectedNrcValueAfter);\n(0, chai_1.expect)(finalAccountValue.rawValue).to.bignumber.equal(accountValueBefore.rawValue.sub(withdrawValue.rawValue));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;352e1456-4f3f-4107-b183-cdaa68efac31&quot;,&quot;parentUUID&quot;:&quot;3e943093-baf2-4589-9c84-9080a9fb24cf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;1b3388f3-00b3-4527-92d0-0f7e07d47ae2&quot;,&quot;71541b6b-5f6f-4521-b5bd-8aef1dadea96&quot;,&quot;c9e66cd1-5f5f-42ba-9573-7933ea3b75f2&quot;,&quot;aeac293d-1600-4278-ad49-3c99d9c7ce37&quot;,&quot;af42189e-63d3-4140-aa36-5d841b37590d&quot;,&quot;8979cc34-705a-4133-ba23-6758abec2b90&quot;,&quot;352e1456-4f3f-4107-b183-cdaa68efac31&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:997,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;74fe6ee5-1d0d-4d29-9055-1567456d7d04&quot;,&quot;title&quot;:&quot;Minter&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;313b349a-4e2a-4159-ba8e-35507fe1dea5&quot;,&quot;parentUUID&quot;:&quot;74fe6ee5-1d0d-4d29-9055-1567456d7d04&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c03fea28-09d5-4316-8b50-9a7bbc8a90af&quot;,&quot;parentUUID&quot;:&quot;74fe6ee5-1d0d-4d29-9055-1567456d7d04&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:145,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;users = hardhat_1.default.users;\n// -------------------------------- Set up mock assets --------------------------------\nconst collateralArgs = {\n    name: \&quot;CollateralAsset\&quot;,\n    price: 10,\n    factor: 1,\n    decimals: 18,\n};\nthis.collateral = hardhat_1.default.collaterals.find(c =&gt; c.deployArgs.name === _test_utils_1.defaultCollateralArgs.name);\nthis.collateral = await this.collateral.update(collateralArgs);\nthis.collateral.setPrice(collateralArgs.price);\nawait this.collateral.update(collateralArgs);\n// Set up mock KreskoAsset\nconst krAssetArgs = {\n    name: \&quot;KreskoAsset\&quot;,\n    price: 11,\n    factor: 1,\n    supplyLimit: 1000000,\n    closeFee: _test_utils_1.defaultCloseFee,\n    openFee: _test_utils_1.defaultOpenFee,\n};\nthis.krAsset = hardhat_1.default.krAssets.find(c =&gt; c.deployArgs.name === _test_utils_1.defaultKrAssetArgs.name);\nthis.krAsset.setPrice(krAssetArgs.price);\n// grant operator role to deployer for rebases\nawait this.krAsset.contract.grantRole(_test_utils_1.Role.OPERATOR, hardhat_1.default.users.deployer.address);\nconst assetInfo = await this.krAsset.kresko();\n// Add krAsset as a collateral with anchor and cFactor of 1\nawait hardhat_1.default.Diamond.connect(hardhat_1.default.users.operator).addCollateralAsset(this.krAsset.contract.address, this.krAsset.anchor.address, hardhat_1.default.toBig(1), assetInfo.oracle);\n// -------------------------------- Set up userOne deposit/debt --------------------------------\nawait this.collateral.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [hardhat_1.default.users.liquidator.address]: hardhat_1.default.toBig(100000000),\n});\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [hardhat_1.default.users.liquidator.address]: {\n        [hardhat_1.default.Diamond.address]: hardhat_1.default.toBig(100000000),\n    },\n});\n// Deposit collateral\nthis.defaultDepositAmount = 20; // 20 * $10 = $200 in collateral asset value\nawait this.collateral.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [hardhat_1.default.users.userOne.address]: hardhat_1.default.toBig(this.defaultDepositAmount),\n});\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [hardhat_1.default.users.userOne.address]: {\n        [hardhat_1.default.Diamond.address]: hardhat_1.default.toBig(this.defaultDepositAmount),\n    },\n});\nawait (0, collaterals_1.depositCollateral)({\n    user: hardhat_1.default.users.userOne,\n    amount: this.defaultDepositAmount,\n    asset: this.collateral,\n});\n// // Mint KrAsset\nthis.defaultMintAmount = 10; // 10 * $11 = $110 in debt value\nawait (0, krassets_1.mintKrAsset)({\n    user: hardhat_1.default.users.userOne,\n    amount: this.defaultMintAmount,\n    asset: this.krAsset,\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;464dd588-a8b3-484b-974c-02273cc47b70&quot;,&quot;parentUUID&quot;:&quot;74fe6ee5-1d0d-4d29-9055-1567456d7d04&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;23dfcc75-ac48-423b-a20f-7558baa92bcb&quot;,&quot;title&quot;:&quot;#liquidation&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;8987a206-9e76-42a9-8394-ce026ecbfa86&quot;,&quot;title&quot;:&quot;#isAccountLiquidatable&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should identify accounts below their liquidation threshold&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #isAccountLiquidatable should identify accounts below their liquidation threshold&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:66,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Confirm that current amount is under min collateral value\nconst liquidationThreshold = await hardhat_1.default.Diamond.liquidationThreshold();\nconst minCollateralUSD = await hardhat_1.default.Diamond.getAccountMinimumCollateralValueAtRatio(users.userOne.address, liquidationThreshold);\n(0, chai_1.expect)(this.defaultDepositAmount * this.collateral.deployArgs.price &gt;\n    hardhat_1.default.fromBig(minCollateralUSD.rawValue, 8));\n// The account should be NOT liquidatable as collateral value ($200) &gt;= min collateral value ($154)\nconst initialCanLiquidate = await hardhat_1.default.Diamond.isAccountLiquidatable(users.userOne.address);\n(0, chai_1.expect)(initialCanLiquidate).to.equal(false);\n// Update collateral price to $7.5\nconst newCollateralPrice = 7.5;\nthis.collateral.setPrice(newCollateralPrice);\nconst [, newCollateralOraclePrice] = await hardhat_1.default.Diamond.getCollateralValueAndOraclePrice(this.collateral.address, hardhat_1.default.toBig(1), true);\n(0, chai_1.expect)(hardhat_1.default.fromBig(newCollateralOraclePrice.rawValue, 8)).to.equal(newCollateralPrice);\n// The account should be liquidatable as collateral value ($140) &lt; min collateral value ($154)\nconst secondaryCanLiquidate = await hardhat_1.default.Diamond.isAccountLiquidatable(users.userOne.address);\n(0, chai_1.expect)(secondaryCanLiquidate).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8810b314-0970-443e-9af6-91d243a33166&quot;,&quot;parentUUID&quot;:&quot;8987a206-9e76-42a9-8394-ce026ecbfa86&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;8810b314-0970-443e-9af6-91d243a33166&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:66,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;ce0bf827-3614-4306-8ecf-d7376dc771f0&quot;,&quot;title&quot;:&quot;#liquidate&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#liquidate\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate \&quot;before each\&quot; hook in \&quot;#liquidate\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Grant userTwo tokens to use for liquidation\nawait this.krAsset.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [hardhat_1.default.users.userTwo.address]: hardhat_1.default.toBig(10000),\n});\n// Update collateral price from $10 to $7.5\nconst newCollateralPrice = 7.5;\nthis.collateral.setPrice(newCollateralPrice);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d4e268f6-0d0f-4209-afd0-06ee84523a7c&quot;,&quot;parentUUID&quot;:&quot;ce0bf827-3614-4306-8ecf-d7376dc771f0&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow unhealthy accounts to be liquidated&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate should allow unhealthy accounts to be liquidated&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:758,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Confirm we can liquidate this account\nconst canLiquidate = await hardhat_1.default.Diamond.isAccountLiquidatable(users.userOne.address);\n(0, chai_1.expect)(canLiquidate).to.equal(true);\n// Fetch pre-liquidation state for users and contracts\nconst beforeUserOneCollateralAmount = await hardhat_1.default.Diamond.collateralDeposits(users.userOne.address, this.collateral.address);\nconst beforeUserOneDebtAmount = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\nconst beforeUserTwoCollateralBalance = await this.collateral.contract.balanceOf(users.userTwo.address);\nconst beforeUserTwoKreskoAssetBalance = await this.krAsset.contract.balanceOf(users.userTwo.address);\nconst beforeKreskoCollateralBalance = await this.collateral.contract.balanceOf(hardhat_1.default.Diamond.address);\n// Liquidate userOne\nconst maxLiq = await hardhat_1.default.Diamond.calculateMaxLiquidatableValueForAssets(users.userOne.address, this.krAsset.address, this.collateral.address);\nconst maxRepayAmount = hardhat_1.default.toBig(Number(maxLiq.rawValue.div(await this.krAsset.getPrice())));\nconst mintedKreskoAssetIndex = 0;\nconst depositedCollateralAssetIndex = 0;\nawait hardhat_1.default.Diamond.connect(users.userTwo).liquidate(users.userOne.address, this.krAsset.address, maxRepayAmount, this.collateral.address, mintedKreskoAssetIndex, depositedCollateralAssetIndex);\n// Confirm that the liquidated user&#x27;s debt amount has decreased by the repaid amount\nconst afterUserOneDebtAmount = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(afterUserOneDebtAmount.eq(beforeUserOneDebtAmount.sub(maxRepayAmount)));\n// Confirm that some of the liquidated user&#x27;s collateral has been seized\nconst afterUserOneCollateralAmount = await hardhat_1.default.Diamond.collateralDeposits(users.userOne.address, this.collateral.address);\n(0, chai_1.expect)(afterUserOneCollateralAmount.lt(beforeUserOneCollateralAmount));\n// Confirm that userTwo&#x27;s kresko asset balance has decreased by the repaid amount\nconst afterUserTwoKreskoAssetBalance = await this.krAsset.contract.balanceOf(users.userTwo.address);\n(0, chai_1.expect)(afterUserTwoKreskoAssetBalance.eq(beforeUserTwoKreskoAssetBalance.sub(maxRepayAmount)));\n// Confirm that userTwo has received some collateral from the contract\nconst afterUserTwoCollateralBalance = await this.collateral.contract.balanceOf(users.userTwo.address);\n(0, chai_1.expect)(afterUserTwoCollateralBalance).gt(beforeUserTwoCollateralBalance);\n// Confirm that Kresko contract&#x27;s collateral balance has decreased.\nconst afterKreskoCollateralBalance = await this.collateral.contract.balanceOf(hardhat_1.default.Diamond.address);\n(0, chai_1.expect)(afterKreskoCollateralBalance).lt(beforeKreskoCollateralBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1df40b0c-7cad-4aa4-a81e-c9f9d79b1fbc&quot;,&quot;parentUUID&quot;:&quot;ce0bf827-3614-4306-8ecf-d7376dc771f0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit LiquidationOccurred event&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate should emit LiquidationOccurred event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:103,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Attempt liquidation\nconst repayAmount = 10; // userTwo holds Kresko assets that can be used to repay userOne&#x27;s loan\nconst mintedKreskoAssetIndex = 0;\nconst depositedCollateralAssetIndex = 0;\nconst tx = await hardhat_1.default.Diamond.connect(users.userTwo).liquidate(users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, mintedKreskoAssetIndex, depositedCollateralAssetIndex);\nconst event = await (0, lib_1.getInternalEvent)(tx, typechain_1.MinterEvent__factory.connect(hardhat_1.default.Diamond.address, users.userTwo), \&quot;LiquidationOccurred\&quot;);\n(0, chai_1.expect)(event.account).to.equal(users.userOne.address);\n(0, chai_1.expect)(event.liquidator).to.equal(users.userTwo.address);\n(0, chai_1.expect)(event.repayKreskoAsset).to.equal(this.krAsset.address);\n(0, chai_1.expect)(event.repayAmount).to.equal(repayAmount);\n(0, chai_1.expect)(event.seizedCollateralAsset).to.equal(this.collateral.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;242f0dfe-a103-43cd-9b1b-6caabca3f0f6&quot;,&quot;parentUUID&quot;:&quot;ce0bf827-3614-4306-8ecf-d7376dc771f0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations of healthy accounts&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate should not allow liquidations of healthy accounts&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:322,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Update collateral price from $5 to $10\nconst newCollateralPrice = 10;\nthis.collateral.setPrice(newCollateralPrice);\n// Confirm that the account has sufficient collateral to not be liquidated\nconst liquidationThreshold = await hardhat_1.default.Diamond.liquidationThreshold();\nconst minimumCollateralUSDValueRequired = await hardhat_1.default.Diamond.getAccountMinimumCollateralValueAtRatio(users.userOne.address, liquidationThreshold);\nconst currUserOneCollateralAmount = await hardhat_1.default.Diamond.collateralDeposits(users.userOne.address, this.collateral.address);\n(0, chai_1.expect)(hardhat_1.default.fromBig(currUserOneCollateralAmount) * newCollateralPrice &gt;\n    hardhat_1.default.fromBig(minimumCollateralUSDValueRequired.rawValue, 8));\nconst canLiquidate = await hardhat_1.default.Diamond.isAccountLiquidatable(users.userOne.address);\n(0, chai_1.expect)(canLiquidate).to.equal(false);\nconst repayAmount = 10;\nconst mintedKreskoAssetIndex = 0;\nconst depositedCollateralAssetIndex = 0;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userTwo).liquidate(users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, mintedKreskoAssetIndex, depositedCollateralAssetIndex)).to.be.revertedWith(errors_1.Error.NOT_LIQUIDATABLE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;28e94bda-669c-4f1e-b1f3-794619a5e733&quot;,&quot;parentUUID&quot;:&quot;ce0bf827-3614-4306-8ecf-d7376dc771f0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations if repayment amount is 0&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate should not allow liquidations if repayment amount is 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Liquidation should fail\nconst repayAmount = 0;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userTwo).liquidate(users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, 0, 0)).to.be.revertedWith(errors_1.Error.ZERO_REPAY);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4b272b0e-500f-4935-803d-d423ac9d71cb&quot;,&quot;parentUUID&quot;:&quot;ce0bf827-3614-4306-8ecf-d7376dc771f0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations with krAsset amount greater than krAsset debt of user&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate should not allow liquidations with krAsset amount greater than krAsset debt of user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:82,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Get user&#x27;s debt for this kresko asset\nconst krAssetDebtUserOne = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n// Ensure we are repaying more than debt\nconst repayAmount = krAssetDebtUserOne.add(hardhat_1.default.toBig(1));\n// Liquidation should fail\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userTwo).liquidate(users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, 0, 0)).to.be.revertedWith(errors_1.Error.KRASSET_BURN_AMOUNT_OVERFLOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9b459bc2-570d-4de5-98c0-059f241235a0&quot;,&quot;parentUUID&quot;:&quot;ce0bf827-3614-4306-8ecf-d7376dc771f0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations with USD value greater than the USD value required for regaining healthy position&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate should not allow liquidations with USD value greater than the USD value required for regaining healthy position&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:99,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const maxLiquidation = hardhat_1.default.fromBig((await hardhat_1.default.Diamond.calculateMaxLiquidatableValueForAssets(users.userOne.address, this.krAsset.address, this.collateral.address)).rawValue, 8);\nconst repaymentAmount = hardhat_1.default.toBig((maxLiquidation + 1) / this.krAsset.deployArgs.price);\n// Ensure liquidation cannot happen\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userTwo).liquidate(users.userOne.address, this.krAsset.address, repaymentAmount, this.collateral.address, 0, 0)).to.be.revertedWith(errors_1.Error.LIQUIDATION_OVERFLOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0de2f66a-2776-4a30-88b7-195bea6759c2&quot;,&quot;parentUUID&quot;:&quot;ce0bf827-3614-4306-8ecf-d7376dc771f0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidations when account is under MCR but not under liquidation threshold&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate should not allow liquidations when account is under MCR but not under liquidation threshold&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:85,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.collateral.setPrice(this.collateral.deployArgs.price);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(users.userOne.address)).to.be.false;\nconst minCollateralUSD = await hardhat_1.default.Diamond.getAccountMinimumCollateralValueAtRatio(users.userOne.address, await hardhat_1.default.Diamond.minimumCollateralizationRatio());\nconst liquidationThresholdUSD = await hardhat_1.default.Diamond.getAccountMinimumCollateralValueAtRatio(users.userOne.address, await hardhat_1.default.Diamond.liquidationThreshold());\nthis.collateral.setPrice(this.collateral.deployArgs.price * 0.775);\nconst accountCollateralValue = await hardhat_1.default.Diamond.getAccountCollateralValue(users.userOne.address);\n(0, chai_1.expect)(accountCollateralValue.rawValue.lt(minCollateralUSD.rawValue)).to.be.true;\n(0, chai_1.expect)(accountCollateralValue.rawValue.gt(liquidationThresholdUSD.rawValue)).to.be.true;\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(users.userOne.address)).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a91632af-14a3-4ac4-8c3f-63eb24f8f77a&quot;,&quot;parentUUID&quot;:&quot;ce0bf827-3614-4306-8ecf-d7376dc771f0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations without liquidator approval of Kresko assets to Kresko.sol contract&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate should allow liquidations without liquidator approval of Kresko assets to Kresko.sol contract&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:103,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Check that liquidator&#x27;s token approval to Kresko.sol contract is 0\n(0, chai_1.expect)(await this.krAsset.contract.allowance(users.userTwo.address, hardhat_1.default.Diamond.address)).to.equal(0);\n// Liquidation should succeed despite lack of token approval\nconst repayAmount = 10;\nconst mintedKreskoAssetIndex = 0;\nconst depositedCollateralAssetIndex = 0;\nawait hardhat_1.default.Diamond.connect(users.userTwo).liquidate(users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, mintedKreskoAssetIndex, depositedCollateralAssetIndex);\n// Confirm that liquidator&#x27;s token approval is still 0\n(0, chai_1.expect)(await this.krAsset.contract.allowance(users.userTwo.address, hardhat_1.default.Diamond.address)).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;685fb390-4a38-4501-8496-c36e4cafde81&quot;,&quot;parentUUID&quot;:&quot;ce0bf827-3614-4306-8ecf-d7376dc771f0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not change liquidator&#x27;s existing token approvals during a successful liquidation&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate should not change liquidator&#x27;s existing token approvals during a successful liquidation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:115,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Liquidator increases contract&#x27;s token approval\nconst repayAmount = 10;\nawait this.krAsset.contract.connect(users.userTwo).approve(hardhat_1.default.Diamond.address, repayAmount);\n(0, chai_1.expect)(await this.krAsset.contract.allowance(users.userTwo.address, hardhat_1.default.Diamond.address)).to.equal(repayAmount);\nconst mintedKreskoAssetIndex = 0;\nconst depositedCollateralAssetIndex = 0;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userTwo).liquidate(users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, mintedKreskoAssetIndex, depositedCollateralAssetIndex)).not.to.be.reverted;\n// Confirm that liquidator&#x27;s token approval is unchanged\n(0, chai_1.expect)(await this.krAsset.contract.allowance(users.userTwo.address, hardhat_1.default.Diamond.address)).to.equal(repayAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9dbd9ebe-2b64-4941-a5c7-a008d955dc77&quot;,&quot;parentUUID&quot;:&quot;ce0bf827-3614-4306-8ecf-d7376dc771f0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow borrowers to liquidate themselves&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate should not allow borrowers to liquidate themselves&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Liquidation should fail\nconst repayAmount = 5;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).liquidate(users.userOne.address, this.krAsset.address, repayAmount, this.collateral.address, 0, 0)).to.be.revertedWith(errors_1.Error.SELF_LIQUIDATION);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9c70b477-06a7-439b-96fa-02eb86fc3534&quot;,&quot;parentUUID&quot;:&quot;ce0bf827-3614-4306-8ecf-d7376dc771f0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;1df40b0c-7cad-4aa4-a81e-c9f9d79b1fbc&quot;,&quot;242f0dfe-a103-43cd-9b1b-6caabca3f0f6&quot;,&quot;28e94bda-669c-4f1e-b1f3-794619a5e733&quot;,&quot;4b272b0e-500f-4935-803d-d423ac9d71cb&quot;,&quot;9b459bc2-570d-4de5-98c0-059f241235a0&quot;,&quot;0de2f66a-2776-4a30-88b7-195bea6759c2&quot;,&quot;a91632af-14a3-4ac4-8c3f-63eb24f8f77a&quot;,&quot;685fb390-4a38-4501-8496-c36e4cafde81&quot;,&quot;9dbd9ebe-2b64-4941-a5c7-a008d955dc77&quot;,&quot;9c70b477-06a7-439b-96fa-02eb86fc3534&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1684,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;de49d5db-3bb3-4156-a400-6da775c59a67&quot;,&quot;title&quot;:&quot;#liquidate - rebasing events&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#liquidate - rebasing events\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate - rebasing events \&quot;before each\&quot; hook in \&quot;#liquidate - rebasing events\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:781,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;userToLiquidate = hardhat_1.default.users.userThree;\nuserToLiquidateTwo = hardhat_1.default.users.userFour;\nthis.collateral.setPrice(collateralPrice);\nthis.krAsset.setPrice(krAssetPrice);\n// Deposit collateral for liquidator\nawait (0, collaterals_1.depositCollateral)({\n    user: users.liquidator,\n    asset: this.collateral,\n    amount: liquidatorAmounts.collateralDeposits,\n});\nawait (0, _test_utils_1.leverageKrAsset)(userToLiquidate, this.krAsset, this.collateral, userToLiquidateAmounts.krAssetCollateralDeposits);\nawait (0, _test_utils_1.leverageKrAsset)(userToLiquidateTwo, this.krAsset, this.collateral, userToLiquidateAmounts.krAssetCollateralDeposits);\n// 1.5 = collateral value === debt value * MCR\n(0, chai_1.expect)(await (0, _test_utils_1.getHealthFactor)(userToLiquidate)).to.lessThanOrEqual(1.51);\n(0, chai_1.expect)(await (0, _test_utils_1.getHealthFactor)(userToLiquidateTwo)).to.lessThanOrEqual(1.51);\n// not liquidatable\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.false;\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidateTwo.address)).to.be.false;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;04880dd5-e55b-4626-8bcb-a65a54a0a114&quot;,&quot;parentUUID&quot;:&quot;de49d5db-3bb3-4156-a400-6da775c59a67&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should not allow liquidation of healthy accounts after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate - rebasing events should not allow liquidation of healthy accounts after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:95,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasePrice = hardhat_1.default.fromBig(await this.krAsset.getPrice(), 8) / denominator;\nthis.krAsset.setPrice(rebasePrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.false;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(hardhat_1.default.users.liquidator).liquidate(userToLiquidate.address, this.krAsset.address, 1, this.collateral.address, await hardhat_1.default.Diamond.getMintedKreskoAssetsIndex(userToLiquidate.address, this.krAsset.address), await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(userToLiquidate.address, this.collateral.address))).to.be.revertedWith(errors_1.Error.NOT_LIQUIDATABLE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d3529e1f-bb71-4ab5-aabf-a445c7aa1fce&quot;,&quot;parentUUID&quot;:&quot;de49d5db-3bb3-4156-a400-6da775c59a67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow liquidation of healthy accounts after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate - rebasing events should not allow liquidation of healthy accounts after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:97,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasePrice = hardhat_1.default.fromBig(await this.krAsset.getPrice(), 8) * denominator;\nthis.krAsset.setPrice(rebasePrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.false;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(hardhat_1.default.users.liquidator).liquidate(userToLiquidate.address, this.krAsset.address, 1, this.collateral.address, await hardhat_1.default.Diamond.getMintedKreskoAssetsIndex(userToLiquidate.address, this.krAsset.address), await hardhat_1.default.Diamond.getDepositedCollateralAssetIndex(userToLiquidate.address, this.collateral.address))).to.be.revertedWith(errors_1.Error.NOT_LIQUIDATABLE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7f6dd952-a81e-430b-a5b4-ba44bb2ad81a&quot;,&quot;parentUUID&quot;:&quot;de49d5db-3bb3-4156-a400-6da775c59a67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations of unhealthy accounts after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate - rebasing events should allow liquidations of unhealthy accounts after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:439,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasePrice = hardhat_1.default.fromBig(await this.krAsset.getPrice(), 8) / denominator;\nthis.krAsset.setPrice(rebasePrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.false;\nthis.collateral.setPrice(rebasePrice * 2);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.true;\nawait (0, chai_1.expect)((0, liquidations_1.liquidate)(userToLiquidate, this.krAsset, this.collateral)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;badc2ead-c480-4be4-b636-88f2b639f658&quot;,&quot;parentUUID&quot;:&quot;de49d5db-3bb3-4156-a400-6da775c59a67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow liquidations of unhealthy accounts after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate - rebasing events should allow liquidations of unhealthy accounts after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:425,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasePrice = hardhat_1.default.fromBig(await this.krAsset.getPrice(), 8) * denominator;\nthis.krAsset.setPrice(rebasePrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.false;\nthis.krAsset.setPrice(rebasePrice * 2);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidate.address)).to.be.true;\nawait (0, chai_1.expect)((0, liquidations_1.liquidate)(userToLiquidate, this.krAsset, this.collateral)).to.not.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;62b74e1d-5933-47c5-b106-1ee94bc6f5d3&quot;,&quot;parentUUID&quot;:&quot;de49d5db-3bb3-4156-a400-6da775c59a67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate correct amount of krAssets after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate - rebasing events should liquidate correct amount of krAssets after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4480,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Change price to make user position unhealthy\nconst startingPrice = hardhat_1.default.fromBig(await this.krAsset.getPrice(), 8);\nconst newPrice = startingPrice * 2;\nthis.krAsset.setPrice(newPrice);\nconst results = {\n    collateralSeized: 0,\n    debtRepaid: 0,\n    userOneValueAfter: 0,\n    userOneHFAfter: 0,\n    collateralSeizedRebase: 0,\n    debtRepaidRebase: 0,\n    userTwoValueAfter: 0,\n    userTwoHFAfter: 0,\n};\n// Get values for a liquidation that happens before rebase\nwhile (await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidate.address)) {\n    const values = await (0, liquidations_1.liquidate)(userToLiquidate, this.krAsset, this.krAsset);\n    results.collateralSeized += values.collateralSeized;\n    results.debtRepaid += values.debtRepaid;\n}\nresults.userOneValueAfter = hardhat_1.default.fromBig((await hardhat_1.default.Diamond.getAccountCollateralValue(userToLiquidate.address)).rawValue, 8);\nresults.userOneHFAfter = await (0, _test_utils_1.getHealthFactor)(userToLiquidate);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst rebasePrice = newPrice / denominator;\n// Rebase\nthis.krAsset.setPrice(rebasePrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidateTwo.address)).to.be.true;\n// Get values for a liquidation that happens after a rebase\nwhile (await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidateTwo.address)) {\n    const values = await (0, liquidations_1.liquidate)(userToLiquidateTwo, this.krAsset, this.krAsset);\n    results.collateralSeizedRebase += values.collateralSeized;\n    results.debtRepaidRebase += values.debtRepaid;\n}\nresults.userTwoValueAfter = hardhat_1.default.fromBig((await hardhat_1.default.Diamond.getAccountCollateralValue(userToLiquidateTwo.address)).rawValue, 8);\nresults.userTwoHFAfter = await (0, _test_utils_1.getHealthFactor)(userToLiquidateTwo);\n(0, chai_1.expect)(results.userTwoHFAfter).to.closeTo(results.userOneHFAfter, INTEREST_RATE_DELTA);\n(0, chai_1.expect)(results.collateralSeized * denominator).to.closeTo(results.collateralSeizedRebase, INTEREST_RATE_DELTA);\n(0, chai_1.expect)(results.debtRepaid * denominator).to.closeTo(results.debtRepaidRebase, INTEREST_RATE_DELTA);\n(0, chai_1.expect)(results.userOneValueAfter).to.closeTo(results.userTwoValueAfter, INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;874a5094-34dd-4440-a4f6-38878cc22799&quot;,&quot;parentUUID&quot;:&quot;de49d5db-3bb3-4156-a400-6da775c59a67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should liquidate correct amount of assets after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #liquidation #liquidate - rebasing events should liquidate correct amount of assets after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5029,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Change price to make user position unhealthy\nconst startingPrice = hardhat_1.default.fromBig(await this.krAsset.getPrice(), 8);\nconst newPrice = startingPrice * 2;\nthis.krAsset.setPrice(newPrice);\nconst results = {\n    collateralSeized: 0,\n    debtRepaid: 0,\n    userOneValueAfter: 0,\n    userOneHFAfter: 0,\n    collateralSeizedRebase: 0,\n    debtRepaidRebase: 0,\n    userTwoValueAfter: 0,\n    userTwoHFAfter: 0,\n};\n// Get values for a liquidation that happens before rebase\nwhile (await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidate.address)) {\n    const values = await (0, liquidations_1.liquidate)(userToLiquidate, this.krAsset, this.krAsset);\n    results.collateralSeized += values.collateralSeized;\n    results.debtRepaid += values.debtRepaid;\n}\nresults.userOneValueAfter = hardhat_1.default.fromBig((await hardhat_1.default.Diamond.getAccountCollateralValue(userToLiquidate.address)).rawValue, 8);\nresults.userOneHFAfter = await (0, _test_utils_1.getHealthFactor)(userToLiquidate);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst rebasePrice = newPrice * denominator;\n// Rebase\nthis.krAsset.setPrice(rebasePrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidateTwo.address)).to.be.true;\n// Get values for a liquidation that happens after a rebase\nwhile (await hardhat_1.default.Diamond.isAccountLiquidatable(userToLiquidateTwo.address)) {\n    const values = await (0, liquidations_1.liquidate)(userToLiquidateTwo, this.krAsset, this.krAsset);\n    results.collateralSeizedRebase += values.collateralSeized;\n    results.debtRepaidRebase += values.debtRepaid;\n}\nresults.userTwoValueAfter = hardhat_1.default.fromBig((await hardhat_1.default.Diamond.getAccountCollateralValue(userToLiquidateTwo.address)).rawValue, 8);\nresults.userTwoHFAfter = await (0, _test_utils_1.getHealthFactor)(userToLiquidateTwo);\n(0, chai_1.expect)(results.userTwoHFAfter).to.closeTo(results.userOneHFAfter, INTEREST_RATE_DELTA);\n(0, chai_1.expect)(results.collateralSeized / denominator).to.closeTo(results.collateralSeizedRebase, INTEREST_RATE_DELTA);\n(0, chai_1.expect)(results.debtRepaid / denominator).to.closeTo(results.debtRepaidRebase, INTEREST_RATE_DELTA);\n(0, chai_1.expect)(results.userOneValueAfter).to.closeTo(results.userTwoValueAfter, INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ce5915dd-fd53-4c6d-87e8-1c34382d8cb6&quot;,&quot;parentUUID&quot;:&quot;de49d5db-3bb3-4156-a400-6da775c59a67&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d3529e1f-bb71-4ab5-aabf-a445c7aa1fce&quot;,&quot;7f6dd952-a81e-430b-a5b4-ba44bb2ad81a&quot;,&quot;badc2ead-c480-4be4-b636-88f2b639f658&quot;,&quot;62b74e1d-5933-47c5-b106-1ee94bc6f5d3&quot;,&quot;874a5094-34dd-4440-a4f6-38878cc22799&quot;,&quot;ce5915dd-fd53-4c6d-87e8-1c34382d8cb6&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:10565,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;bd8e9f80-b108-45fb-8957-587bf3d00ab1&quot;,&quot;title&quot;:&quot;Minter&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;users = await hardhat_1.default.getUsers();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6a4c8c81-f5d6-43f6-a5f3-0ce7fc375347&quot;,&quot;parentUUID&quot;:&quot;bd8e9f80-b108-45fb-8957-587bf3d00ab1&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before all\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5a9da48d-cb44-4885-bf12-3fa0fa6a2989&quot;,&quot;parentUUID&quot;:&quot;bd8e9f80-b108-45fb-8957-587bf3d00ab1&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:32,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8239fa0c-32de-432b-95b9-b0d40b611ca7&quot;,&quot;parentUUID&quot;:&quot;bd8e9f80-b108-45fb-8957-587bf3d00ab1&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter \&quot;before each\&quot; hook in \&quot;Minter\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:54,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.collateral = this.collaterals.find(c =&gt; c.deployArgs.name === _test_utils_1.defaultCollateralArgs.name);\nthis.krAsset = this.krAssets.find(c =&gt; c.deployArgs.name === _test_utils_1.defaultKrAssetArgs.name);\nawait this.krAsset.contract.grantRole(_test_utils_1.Role.OPERATOR, users.deployer.address);\nthis.krAsset.setPrice(this.krAsset.deployArgs.price);\nthis.krAsset.setMarketOpen(this.krAsset.deployArgs.marketOpen);\n// Load account with collateral\nthis.initialBalance = (0, lib_1.toBig)(100000);\nawait this.collateral.setBalance(users.userOne, this.initialBalance);\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [users.userOne.address]: {\n        [hardhat_1.default.Diamond.address]: this.initialBalance,\n    },\n});\nthis.collateral.setPrice(this.collateral.deployArgs.price);\n// User deposits 10,000 collateral\nawait (0, collaterals_1.depositCollateral)({ amount: 10000, user: users.userOne, asset: this.collateral });&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9a7436d0-c5f7-48d9-989a-5e23b2603fce&quot;,&quot;parentUUID&quot;:&quot;bd8e9f80-b108-45fb-8957-587bf3d00ab1&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;074a5826-a422-445d-a2f4-f58cdfd2bd2c&quot;,&quot;title&quot;:&quot;#mint+burn&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;65902b65-ba73-4c97-bc28-13a82d45b1dc&quot;,&quot;title&quot;:&quot;#mint&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow users to mint whitelisted Kresko assets backed by collateral&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint whitelisted Kresko assets backed by collateral&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:81,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially the Kresko asset&#x27;s total supply should be 0\nconst kreskoAssetTotalSupplyBefore = await this.krAsset.contract.totalSupply();\n(0, chai_1.expect)(kreskoAssetTotalSupplyBefore).to.equal(0);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsBefore = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsBefore).to.deep.equal([]);\n// Mint Kresko asset\nconst mintAmount = (0, lib_1.toBig)(1);\nawait hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsAfter).to.deep.equal([this.krAsset.address]);\n// Confirm the amount minted is recorded for the user.\nconst amountMinted = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(amountMinted).to.equal(mintAmount);\n// Confirm the user&#x27;s Kresko asset balance has increased\nconst userBalance = await this.krAsset.mocks.contract.balanceOf(users.userOne.address);\n(0, chai_1.expect)(userBalance).to.equal(mintAmount);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await this.krAsset.contract.totalSupply();\n(0, chai_1.expect)(kreskoAssetTotalSupplyAfter.eq(kreskoAssetTotalSupplyBefore.add(mintAmount)));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f8dc25a5-157b-4a25-b900-472258a92d38&quot;,&quot;parentUUID&quot;:&quot;65902b65-ba73-4c97-bc28-13a82d45b1dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow successive, valid mints of the same Kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow successive, valid mints of the same Kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:169,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially the Kresko asset&#x27;s total supply should be 0\nconst kreskoAssetTotalSupplyInitial = await this.krAsset.contract.totalSupply();\n(0, chai_1.expect)(kreskoAssetTotalSupplyInitial).to.equal(0);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsInitial = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsInitial).to.deep.equal([]);\n// Mint Kresko asset\nconst firstMintAmount = (0, lib_1.toBig)(5);\nawait hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, firstMintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsAfter).to.deep.equal([this.krAsset.address]);\n// Confirm the amount minted is recorded for the user.\nconst amountMintedAfter = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(amountMintedAfter).to.equal(firstMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceAfter = await this.krAsset.contract.balanceOf(users.userOne.address);\n(0, chai_1.expect)(userBalanceAfter).to.equal(amountMintedAfter);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await this.krAsset.contract.totalSupply();\n(0, chai_1.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyInitial.add(firstMintAmount));\n// ------------------------ Second mint ------------------------\n// Mint Kresko asset\nconst secondMintAmount = (0, lib_1.toBig)(5);\nawait hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, secondMintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets is unchanged\nconst mintedKreskoAssetsFinal = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsFinal).to.deep.equal([this.krAsset.address]);\n// Confirm the second mint amount is recorded for the user\nconst amountMintedFinal = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(amountMintedFinal).to.closeTo(firstMintAmount.add(secondMintAmount), INTEREST_RATE_DELTA);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceFinal = await this.krAsset.contract.balanceOf(users.userOne.address);\n(0, chai_1.expect)(userBalanceFinal).to.closeTo(amountMintedFinal, INTEREST_RATE_DELTA);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyFinal = await this.krAsset.contract.totalSupply();\n(0, chai_1.expect)(kreskoAssetTotalSupplyFinal).to.closeTo(kreskoAssetTotalSupplyAfter.add(secondMintAmount), INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dbd7beef-ae8c-4dc5-8d4f-afb1ad9ed304&quot;,&quot;parentUUID&quot;:&quot;65902b65-ba73-4c97-bc28-13a82d45b1dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to mint multiple different Kresko assets&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint multiple different Kresko assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2874,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially the Kresko asset&#x27;s total supply should be 0\nconst kreskoAssetTotalSupplyInitial = await this.krAsset.contract.totalSupply();\n(0, chai_1.expect)(kreskoAssetTotalSupplyInitial).to.equal(0);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsInitial = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsInitial).to.deep.equal([]);\n// Mint Kresko asset\nconst firstMintAmount = (0, lib_1.toBig)(1);\nawait hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, firstMintAmount);\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to.\nconst mintedKreskoAssetsAfter = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsAfter).to.deep.equal([this.krAsset.address]);\n// Confirm the amount minted is recorded for the user.\nconst amountMintedAfter = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(amountMintedAfter).to.equal(firstMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceAfter = await this.krAsset.contract.balanceOf(users.userOne.address);\n(0, chai_1.expect)(userBalanceAfter).to.equal(amountMintedAfter);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst kreskoAssetTotalSupplyAfter = await this.krAsset.contract.totalSupply();\n(0, chai_1.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyInitial.add(firstMintAmount));\n// ------------------------ Second mint ------------------------\n// Add second mock krAsset to protocol\nconst secondKrAssetArgs = {\n    name: \&quot;SecondKreskoAsset\&quot;,\n    symbol: \&quot;SecondKreskoAsset\&quot;,\n    price: 5,\n    marketOpen: true,\n    factor: 1,\n    supplyLimit: 100000,\n    closeFee: _test_utils_1.defaultCloseFee,\n    openFee: 0,\n};\nconst { contract: secondKreskoAsset } = await (0, krassets_1.addMockKreskoAsset)(secondKrAssetArgs);\n// Mint Kresko asset\nconst secondMintAmount = (0, lib_1.toBig)(2);\nawait hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, secondKreskoAsset.address, secondMintAmount);\n// Confirm that the second address has been pushed to the array of the user&#x27;s minted Kresko assets\nconst mintedKreskoAssetsFinal = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsFinal).to.deep.equal([this.krAsset.address, secondKreskoAsset.address]);\n// Confirm the second mint amount is recorded for the user\nconst amountMintedAssetTwo = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, secondKreskoAsset.address);\n(0, chai_1.expect)(amountMintedAssetTwo).to.equal(secondMintAmount);\n// Confirm the Kresko Asset as been minted to the user from Kresko.sol\nconst userBalanceFinal = await secondKreskoAsset.balanceOf(users.userOne.address);\n(0, chai_1.expect)(userBalanceFinal).to.equal(amountMintedAssetTwo);\n// Confirm that the Kresko asset&#x27;s total supply increased as expected\nconst secondKreskoAssetTotalSupply = await secondKreskoAsset.totalSupply();\n(0, chai_1.expect)(secondKreskoAssetTotalSupply).to.equal(secondMintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9e057cdf-f0bd-4021-b3d3-07c10d4b612f&quot;,&quot;parentUUID&quot;:&quot;65902b65-ba73-4c97-bc28-13a82d45b1dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to mint Kresko assets with USD value equal to the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow users to mint Kresko assets with USD value equal to the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:82,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Confirm that the user does not have an existing debt position for this Kresko asset\nconst initialKreskoAssetDebt = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(initialKreskoAssetDebt).to.equal(0);\n// Confirm that the mint amount&#x27;s USD value is equal to the contract&#x27;s current minimum debt value\nconst mintAmount = (0, lib_1.toBig)(1); // 1 * $10 = $10\nconst mintAmountUSDValue = await hardhat_1.default.Diamond.getKrAssetValue(this.krAsset.address, mintAmount, false);\nconst currMinimumDebtValue = await hardhat_1.default.Diamond.minimumDebtValue();\n(0, chai_1.expect)((0, lib_1.fromBig)(mintAmountUSDValue.rawValue, 8)).to.equal(Number(currMinimumDebtValue) / 10 ** 8);\nawait hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount);\n// Confirm that the mint was successful and user&#x27;s balances have increased\nconst finalKreskoAssetDebt = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(finalKreskoAssetDebt).to.equal(mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6663fe98-964c-4000-a6d7-d8520ce26c75&quot;,&quot;parentUUID&quot;:&quot;65902b65-ba73-4c97-bc28-13a82d45b1dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow a trusted address to mint Kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should allow a trusted address to mint Kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:84,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Grant userThree the MANAGER role\nawait hardhat_1.default.Diamond.connect(users.deployer).grantRole(_test_utils_1.Role.MANAGER, users.userThree.address);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.hasRole(_test_utils_1.Role.MANAGER, users.userThree.address)).to.equal(true);\n// Initially the Kresko asset&#x27;s total supply should be 0\nconst kreskoAssetTotalSupplyBefore = await this.krAsset.contract.totalSupply();\n(0, chai_1.expect)(kreskoAssetTotalSupplyBefore).to.equal(0);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsBefore = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsBefore).to.deep.equal([]);\n// userThree (trusted contract) mints Kresko asset for userOne\nconst mintAmount = (0, lib_1.toBig)(1);\nawait hardhat_1.default.Diamond.connect(users.userThree).mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount);\n// Check that debt exists now for userOne\nconst userOneDebtFromUserThreeMint = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(userOneDebtFromUserThreeMint).to.equal(mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;864dd286-f119-4139-be43-c3e904debc70&quot;,&quot;parentUUID&quot;:&quot;65902b65-ba73-4c97-bc28-13a82d45b1dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit KreskoAssetMinted event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should emit KreskoAssetMinted event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:57,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const mintAmount = (0, lib_1.toBig)(500);\nconst tx = await hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount);\nconst event = await (0, lib_1.getInternalEvent)(tx, types_1.MinterEvent__factory.connect(hardhat_1.default.Diamond.address, users.userOne), \&quot;KreskoAssetMinted\&quot;);\n(0, chai_1.expect)(event.account).to.equal(users.userOne.address);\n(0, chai_1.expect)(event.kreskoAsset).to.equal(this.krAsset.address);\n(0, chai_1.expect)(event.amount).to.equal(mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dea057ff-cd97-4df0-9899-e359374a9b2f&quot;,&quot;parentUUID&quot;:&quot;65902b65-ba73-4c97-bc28-13a82d45b1dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted account to mint Kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow untrusted account to mint Kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:36,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Initially the Kresko asset&#x27;s total supply should be 0\nconst kreskoAssetTotalSupplyBefore = await this.krAsset.contract.totalSupply();\n(0, chai_1.expect)(kreskoAssetTotalSupplyBefore).to.equal(0);\n// Initially, the array of the user&#x27;s minted kresko assets should be empty.\nconst mintedKreskoAssetsBefore = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsBefore).to.deep.equal([]);\n// Mint Kresko asset\nconst mintAmount = (0, lib_1.toBig)(1);\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userTwo.address, this.krAsset.address, mintAmount)).to.be.revertedWith(`AccessControl: account ${users.userOne.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e1881bb9-181c-4aab-bb84-4887393d0bbe&quot;,&quot;parentUUID&quot;:&quot;65902b65-ba73-4c97-bc28-13a82d45b1dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint Kresko assets if the resulting position&#x27;s USD value is less than the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint Kresko assets if the resulting position&#x27;s USD value is less than the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:55,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Confirm that the user does not have an existing debt position for this Kresko asset\nconst initialKreskoAssetDebt = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(initialKreskoAssetDebt).to.equal(0);\n// Confirm that the mint amount&#x27;s USD value is below the contract&#x27;s current minimum debt value\nconst minAmount = 100000000; // 8 decimals\nconst mintAmount = minAmount - 1;\nconst mintAmountUSDValue = await hardhat_1.default.Diamond.getKrAssetValue(this.krAsset.address, mintAmount, false);\nconst currMinimumDebtValue = await hardhat_1.default.Diamond.minimumDebtValue();\n(0, chai_1.expect)(Number(mintAmountUSDValue)).to.be.lessThan(Number(currMinimumDebtValue));\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount)).to.be.revertedWith(errors_1.Error.KRASSET_MINT_AMOUNT_LOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;720ac7c8-5e4d-41fb-b7c1-7f0d119ea11b&quot;,&quot;parentUUID&quot;:&quot;65902b65-ba73-4c97-bc28-13a82d45b1dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint non-whitelisted Kresko assets&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint non-whitelisted Kresko assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:7,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Attempt to mint a non-deployed, non-whitelisted Kresko asset\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, \&quot;0x0000000000000000000000000000000000000002\&quot;, (0, lib_1.toBig)(1))).to.be.revertedWith(errors_1.Error.KRASSET_DOESNT_EXIST);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1e0c72ca-36d4-42d6-9ca8-801613e2729c&quot;,&quot;parentUUID&quot;:&quot;65902b65-ba73-4c97-bc28-13a82d45b1dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to mint Kresko assets over their collateralization ratio limit&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow users to mint Kresko assets over their collateralization ratio limit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:34,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// We can ignore price and collateral factor as both this.collateral and this.krAsset both\n// have the same price ($10) and same collateral factor (1)\nconst collateralAmountDeposited = await hardhat_1.default.Diamond.collateralDeposits(users.userOne.address, this.collateral.address);\n// Apply 150% MCR and increase deposit amount to be above the maximum allowed by MCR\nconst mcrAmount = (0, lib_1.fromBig)(collateralAmountDeposited) / 1.5;\nconst mintAmount = (0, lib_1.toBig)(mcrAmount + 1);\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount)).to.be.revertedWith(errors_1.Error.KRASSET_COLLATERAL_LOW);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ba1810f8-eca6-4c02-b0ff-37d31c1dd3e3&quot;,&quot;parentUUID&quot;:&quot;65902b65-ba73-4c97-bc28-13a82d45b1dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the minting of any Kresko asset amount over its maximum limit&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow the minting of any Kresko asset amount over its maximum limit&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:33,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// User deposits another 10,000 collateral tokens, enabling mints of up to 20,000/1.5 = ~13,333 kresko asset tokens\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).depositCollateral(users.userOne.address, this.collateral.address, (0, lib_1.toBig)(10000))).not.to.be.reverted;\nconst krAsset = await hardhat_1.default.Diamond.kreskoAsset(this.krAsset.address);\nconst overSupplyLimit = (0, lib_1.fromBig)(krAsset.supplyLimit) + 1;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, (0, lib_1.toBig)(overSupplyLimit))).to.be.revertedWith(errors_1.Error.KRASSET_MAX_SUPPLY_REACHED);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c2941910-fd9e-4e54-8386-73156b2996a8&quot;,&quot;parentUUID&quot;:&quot;65902b65-ba73-4c97-bc28-13a82d45b1dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow the minting of kreskoAssets if the market is closed&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint should not allow the minting of kreskoAssets if the market is closed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:71,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.krAsset.setMarketOpen(false);\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, (0, lib_1.toBig)(1))).to.be.revertedWith(errors_1.Error.KRASSET_MARKET_CLOSED);\n// Confirm that the user has no minted krAssets\nconst mintedKreskoAssetsBefore = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsBefore).to.deep.equal([]);\n// Confirm that opening the market makes krAsset mintable again\nthis.krAsset.setMarketOpen(true);\nawait hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, (0, lib_1.toBig)(1));\n// Confirm the array of the user&#x27;s minted Kresko assets has been pushed to\nconst mintedKreskoAssetsAfter = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsAfter).to.deep.equal([this.krAsset.address]);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e4a8144e-8ed4-4506-ae64-c0a819b64bcb&quot;,&quot;parentUUID&quot;:&quot;65902b65-ba73-4c97-bc28-13a82d45b1dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f8dc25a5-157b-4a25-b900-472258a92d38&quot;,&quot;dbd7beef-ae8c-4dc5-8d4f-afb1ad9ed304&quot;,&quot;9e057cdf-f0bd-4021-b3d3-07c10d4b612f&quot;,&quot;6663fe98-964c-4000-a6d7-d8520ce26c75&quot;,&quot;864dd286-f119-4139-be43-c3e904debc70&quot;,&quot;dea057ff-cd97-4df0-9899-e359374a9b2f&quot;,&quot;e1881bb9-181c-4aab-bb84-4887393d0bbe&quot;,&quot;720ac7c8-5e4d-41fb-b7c1-7f0d119ea11b&quot;,&quot;1e0c72ca-36d4-42d6-9ca8-801613e2729c&quot;,&quot;ba1810f8-eca6-4c02-b0ff-37d31c1dd3e3&quot;,&quot;c2941910-fd9e-4e54-8386-73156b2996a8&quot;,&quot;e4a8144e-8ed4-4506-ae64-c0a819b64bcb&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:3583,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;e7378b0f-9e06-4554-9cb3-2b2e61160280&quot;,&quot;title&quot;:&quot;#mint - rebase events&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;ce6371f7-bac9-44e1-a717-ac748d6fdbef&quot;,&quot;title&quot;:&quot;debt amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when minted before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt amounts are calculated correctly when minted before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:92,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait userOne.mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount);\nconst balanceBefore = await this.krAsset.contract.balanceOf(users.userOne.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, krassets_1.getDebtIndexAdjustedBalance)(users.userOne, this.krAsset);\n(0, chai_1.expect)(balanceAfter).to.bignumber.equal(mintAmount.mul(denominator));\n(0, chai_1.expect)(balanceBefore).to.not.bignumber.equal(balanceAfter);\n// Ensure that debt amount is also adjsuted by the rebase\nconst debtAmount = await userOne.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(balanceAfterAdjusted).to.bignumber.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a4ead153-f68f-4442-98f7-84e4af15bdd7&quot;,&quot;parentUUID&quot;:&quot;ce6371f7-bac9-44e1-a717-ac748d6fdbef&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt amounts are calculated correctly when minted before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:90,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait userOne.mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount);\nconst balanceBefore = await this.krAsset.contract.balanceOf(users.userOne.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, krassets_1.getDebtIndexAdjustedBalance)(users.userOne, this.krAsset);\n(0, chai_1.expect)(balanceAfter).to.bignumber.equal(mintAmount.div(denominator));\n(0, chai_1.expect)(balanceBefore).to.not.bignumber.equal(balanceAfter);\n// Ensure that debt amount is also adjsuted by the rebase\nconst debtAmount = await userOne.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(balanceAfterAdjusted).to.bignumber.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a6bb7e21-66e3-4056-9fd6-486e6f77f336&quot;,&quot;parentUUID&quot;:&quot;ce6371f7-bac9-44e1-a717-ac748d6fdbef&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt amounts are calculated correctly when minted after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:91,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait userOne.mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount);\nconst balanceBefore = await this.krAsset.contract.balanceOf(users.userOne.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, krassets_1.getDebtIndexAdjustedBalance)(users.userOne, this.krAsset);\n(0, chai_1.expect)(balanceAfter).to.bignumber.equal(mintAmount.mul(denominator));\n(0, chai_1.expect)(balanceBefore).to.not.bignumber.equal(balanceAfter);\n// Ensure that debt amount is also adjusted by the rebase\nconst debtAmount = await userOne.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(balanceAfterAdjusted).to.bignumber.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7751d8d7-ea3a-49d2-80f5-bda3c20944c6&quot;,&quot;parentUUID&quot;:&quot;ce6371f7-bac9-44e1-a717-ac748d6fdbef&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt amounts are calculated correctly when minted after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:96,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait userOne.mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount);\nconst balanceBefore = await this.krAsset.contract.balanceOf(users.userOne.address);\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Ensure that the minted balance is adjusted by the rebase\nconst [balanceAfter, balanceAfterAdjusted] = await (0, krassets_1.getDebtIndexAdjustedBalance)(users.userOne, this.krAsset);\n(0, chai_1.expect)(balanceAfter).to.bignumber.equal(mintAmount.div(denominator));\n(0, chai_1.expect)(balanceBefore).to.not.bignumber.equal(balanceAfter);\n// Ensure that debt amount is also adjusted by the rebase\nconst debtAmount = await userOne.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(balanceAfterAdjusted).to.bignumber.equal(debtAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e63ca38f-e1a1-4d59-8dd8-c866b2b7ed3e&quot;,&quot;parentUUID&quot;:&quot;ce6371f7-bac9-44e1-a717-ac748d6fdbef&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;a4ead153-f68f-4442-98f7-84e4af15bdd7&quot;,&quot;a6bb7e21-66e3-4056-9fd6-486e6f77f336&quot;,&quot;7751d8d7-ea3a-49d2-80f5-bda3c20944c6&quot;,&quot;e63ca38f-e1a1-4d59-8dd8-c866b2b7ed3e&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:369,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;361b2ac6-c7bb-4770-9fe9-64616828a3ab&quot;,&quot;title&quot;:&quot;debt values are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when mint is made before positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt values are calculated correctly when mint is made before positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:111,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Mint before rebase\nawait userOne.mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount);\nconst valueBeforeRebase = await userOne.getAccountKrAssetValue(users.userOne.address);\n// Adjust price accordingly\nconst assetPrice = await this.krAsset.getPrice();\nthis.krAsset.setPrice(hardhat_1.default.fromBig(assetPrice.div(denominator), 8));\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Ensure that the value inside protocol matches the value before rebase\nconst valueAfterRebase = await userOne.getAccountKrAssetValue(users.userOne.address);\n(0, chai_1.expect)(valueAfterRebase.rawValue).to.bignumber.equal(await (0, calculations_1.toScaledAmount)(valueBeforeRebase.rawValue, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f4e71153-af82-4473-8c4b-f14f53c855e2&quot;,&quot;parentUUID&quot;:&quot;361b2ac6-c7bb-4770-9fe9-64616828a3ab&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when mint is made before negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt values are calculated correctly when mint is made before negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:108,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Mint before rebase\nawait userOne.mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount);\nconst valueBeforeRebase = await userOne.getAccountKrAssetValue(users.userOne.address);\n// Adjust price accordingly\nconst assetPrice = await this.krAsset.getPrice();\nthis.krAsset.setPrice(hardhat_1.default.fromBig(assetPrice.mul(denominator), 8));\n// Rebase the asset according to params\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Ensure that the value inside protocol matches the value before rebase\nconst valueAfterRebase = await userOne.getAccountKrAssetValue(users.userOne.address);\n(0, chai_1.expect)(valueAfterRebase.rawValue).to.bignumber.equal(await (0, calculations_1.toScaledAmount)(valueBeforeRebase.rawValue, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6c34d6c4-7ce4-48f5-b545-101fb75d6b38&quot;,&quot;parentUUID&quot;:&quot;361b2ac6-c7bb-4770-9fe9-64616828a3ab&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt values are calculated correctly when minted after positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:99,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Equal value after rebase\nconst equalMintAmount = mintAmount.mul(denominator);\nconst assetPrice = await this.krAsset.getPrice();\n// Get value of the future mint before rebase\nconst valueBeforeRebase = await userOne.getKrAssetValue(this.krAsset.address, mintAmount, false);\n// Adjust price accordingly\nthis.krAsset.setPrice(hardhat_1.default.fromBig(assetPrice, 8) / denominator);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nawait userOne.mintKreskoAsset(users.userOne.address, this.krAsset.address, equalMintAmount);\n// Ensure that value after mint matches what is expected\nconst valueAfterRebase = await userOne.getAccountKrAssetValue(users.userOne.address);\n(0, chai_1.expect)(valueAfterRebase.rawValue).to.bignumber.equal(await (0, calculations_1.toScaledAmount)(valueBeforeRebase.rawValue, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4decacfe-1ca2-4998-b6f9-6bb22538c8fd&quot;,&quot;parentUUID&quot;:&quot;361b2ac6-c7bb-4770-9fe9-64616828a3ab&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted after negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt values are calculated correctly when minted after negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:106,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Equal value after rebase\nconst equalMintAmount = mintAmount.div(denominator);\nconst assetPrice = await this.krAsset.getPrice();\n// Get value of the future mint before rebase\nconst valueBeforeRebase = await userOne.getKrAssetValue(this.krAsset.address, mintAmount, false);\n// Adjust price accordingly\nthis.krAsset.setPrice(hardhat_1.default.fromBig(assetPrice.mul(denominator), 8));\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nawait userOne.mintKreskoAsset(users.userOne.address, this.krAsset.address, equalMintAmount);\n// Ensure that value after mint matches what is expected\nconst valueAfterRebase = await userOne.getAccountKrAssetValue(users.userOne.address);\n(0, chai_1.expect)(valueAfterRebase.rawValue).to.bignumber.equal(await (0, calculations_1.toScaledAmount)(valueBeforeRebase.rawValue, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7b5913ea-a796-4dcb-8115-ff7030b210e0&quot;,&quot;parentUUID&quot;:&quot;361b2ac6-c7bb-4770-9fe9-64616828a3ab&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f4e71153-af82-4473-8c4b-f14f53c855e2&quot;,&quot;6c34d6c4-7ce4-48f5-b545-101fb75d6b38&quot;,&quot;4decacfe-1ca2-4998-b6f9-6bb22538c8fd&quot;,&quot;7b5913ea-a796-4dcb-8115-ff7030b210e0&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:424,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;fde41c35-787d-40f0-9fd1-241048f470dc&quot;,&quot;title&quot;:&quot;debt values and amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when minted before and after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt values and amounts are calculated correctly when minted before and after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:274,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\nconst assetPrice = await this.krAsset.getPrice();\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst mintAmountAfterRebase = mintAmount.mul(denominator);\nconst assetPriceRebase = assetPrice.div(denominator);\n// Get value of the future mint\nconst valueBeforeRebase = await userOne.getKrAssetValue(this.krAsset.address, mintAmount, false);\n// Mint before rebase\nawait userOne.mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount);\n// Get results\nconst balanceAfterFirstMint = await this.krAsset.contract.balanceOf(users.userOne.address);\nconst debtAmountAfterFirstMint = await userOne.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\nconst debtValueAfterFirstMint = await userOne.getAccountKrAssetValue(users.userOne.address);\n// Assert\n(0, chai_1.expect)(balanceAfterFirstMint).to.bignumber.equal(debtAmountAfterFirstMint);\n(0, chai_1.expect)(valueBeforeRebase.rawValue).to.bignumber.equal(debtValueAfterFirstMint.rawValue);\n// Adjust price and rebase\nthis.krAsset.setPrice(hardhat_1.default.fromBig(assetPriceRebase, 8));\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Ensure debt amounts and balances match\nconst [balanceAfterFirstRebase, balanceAfterFirstRebaseAdjusted] = await (0, krassets_1.getDebtIndexAdjustedBalance)(users.userOne, this.krAsset);\nconst debtAmountAfterFirstRebase = await userOne.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(balanceAfterFirstRebase).to.bignumber.equal(mintAmountAfterRebase);\n(0, chai_1.expect)(balanceAfterFirstRebaseAdjusted).to.bignumber.equal(debtAmountAfterFirstRebase);\n// Ensure debt usd values match\nconst debtValueAfterFirstRebase = await userOne.getAccountKrAssetValue(users.userOne.address);\n(0, chai_1.expect)(await (0, calculations_1.fromScaledAmount)(debtValueAfterFirstRebase.rawValue, this.krAsset)).to.bignumber.equal(debtValueAfterFirstMint.rawValue);\n(0, chai_1.expect)(await (0, calculations_1.fromScaledAmount)(debtValueAfterFirstRebase.rawValue, this.krAsset)).to.bignumber.equal(valueBeforeRebase.rawValue);\n// Mint after rebase\nawait userOne.mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmountAfterRebase);\n// Ensure debt amounts and balances match\nconst balanceAfterSecondMint = await this.krAsset.contract.balanceOf(users.userOne.address);\n// Ensure balance matches\nconst expectedBalanceAfterSecondMint = balanceAfterFirstRebase.add(mintAmountAfterRebase);\n(0, chai_1.expect)(balanceAfterSecondMint).to.bignumber.equal(expectedBalanceAfterSecondMint);\n// Ensure debt usd values match\nconst debtValueAfterSecondMint = await userOne.getAccountKrAssetValue(users.userOne.address);\n(0, chai_1.expect)(await (0, calculations_1.fromScaledAmount)(debtValueAfterSecondMint.rawValue, this.krAsset)).to.bignumber.closeTo(debtValueAfterFirstMint.rawValue.mul(2), INTEREST_RATE_PRICE_DELTA);\n(0, chai_1.expect)(debtValueAfterSecondMint.rawValue).to.bignumber.closeTo(valueBeforeRebase.rawValue.mul(2), INTEREST_RATE_PRICE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f1f0031e-05ce-42f2-a3c0-2b25bb3f9e3e&quot;,&quot;parentUUID&quot;:&quot;fde41c35-787d-40f0-9fd1-241048f470dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when minted before and after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #mint - rebase events debt values and amounts are calculated correctly when minted before and after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:250,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\nconst assetPrice = await this.krAsset.getPrice();\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst mintAmountAfterRebase = mintAmount.div(denominator);\nconst assetPriceRebase = assetPrice.mul(denominator);\n// Get value of the future mint\nconst valueBeforeRebase = await userOne.getKrAssetValue(this.krAsset.address, mintAmount, false);\n// Mint before rebase\nawait userOne.mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount);\n// Get results\nconst balanceAfterFirstMint = await this.krAsset.contract.balanceOf(users.userOne.address);\nconst debtAmountAfterFirstMint = await userOne.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\nconst debtValueAfterFirstMint = await userOne.getAccountKrAssetValue(users.userOne.address);\n// Assert\n(0, chai_1.expect)(balanceAfterFirstMint).to.bignumber.equal(debtAmountAfterFirstMint);\n(0, chai_1.expect)(valueBeforeRebase.rawValue).to.bignumber.equal(debtValueAfterFirstMint.rawValue);\n// Adjust price and rebase\nthis.krAsset.setPrice(hardhat_1.default.fromBig(assetPriceRebase, 8));\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Ensure debt amounts and balances match\nconst [balanceAfterFirstRebase, balanceAfterFirstRebaseAdjusted] = await (0, krassets_1.getDebtIndexAdjustedBalance)(users.userOne, this.krAsset);\nconst debtAmountAfterFirstRebase = await userOne.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(balanceAfterFirstRebase).to.bignumber.equal(mintAmountAfterRebase);\n(0, chai_1.expect)(balanceAfterFirstRebaseAdjusted).to.bignumber.equal(debtAmountAfterFirstRebase);\n// Ensure debt usd values match\nconst debtValueAfterFirstRebase = await userOne.getAccountKrAssetValue(users.userOne.address);\n(0, chai_1.expect)(debtValueAfterFirstRebase.rawValue).to.bignumber.equal(await (0, calculations_1.toScaledAmount)(debtValueAfterFirstMint.rawValue, this.krAsset));\n(0, chai_1.expect)(debtValueAfterFirstRebase.rawValue).to.bignumber.equal(await (0, calculations_1.toScaledAmount)(valueBeforeRebase.rawValue, this.krAsset));\n// Mint after rebase\nawait userOne.mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmountAfterRebase);\n// Ensure debt usd values match\nconst debtValueAfterSecondMint = await userOne.getAccountKrAssetValue(users.userOne.address);\n(0, chai_1.expect)(debtValueAfterSecondMint.rawValue).to.bignumber.closeTo(await (0, calculations_1.toScaledAmount)(debtValueAfterFirstMint.rawValue.mul(2), this.krAsset), INTEREST_RATE_PRICE_DELTA);\n(0, chai_1.expect)(debtValueAfterSecondMint.rawValue).to.bignumber.closeTo(await (0, calculations_1.toScaledAmount)(valueBeforeRebase.rawValue.mul(2), this.krAsset), INTEREST_RATE_PRICE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c98f3e30-716d-470b-a6e4-542a1da9f9c3&quot;,&quot;parentUUID&quot;:&quot;fde41c35-787d-40f0-9fd1-241048f470dc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f1f0031e-05ce-42f2-a3c0-2b25bb3f9e3e&quot;,&quot;c98f3e30-716d-470b-a6e4-542a1da9f9c3&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:524,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;5997f3ee-81b9-4a3a-bfd5-2cc67963c6c9&quot;,&quot;title&quot;:&quot;#burn&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn \&quot;before each\&quot; hook in \&quot;#burn\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:125,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Create userOne debt position\nthis.mintAmount = (0, lib_1.toBig)(2);\nawait hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, this.mintAmount);\n// Load userThree with Kresko Assets\nawait this.collateral.mocks.contract.setVariable(\&quot;_balances\&quot;, {\n    [users.userThree.address]: this.initialBalance,\n});\nawait this.collateral.mocks.contract.setVariable(\&quot;_allowances\&quot;, {\n    [users.userThree.address]: {\n        [hardhat_1.default.Diamond.address]: this.initialBalance,\n    },\n});\n(0, chai_1.expect)(await this.collateral.contract.balanceOf(users.userThree.address)).to.equal(this.initialBalance);\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userThree).depositCollateral(users.userThree.address, this.collateral.address, (0, lib_1.toBig)(10000))).not.to.be.reverted;\nawait hardhat_1.default.Diamond.connect(users.userThree).mintKreskoAsset(users.userThree.address, this.krAsset.address, this.mintAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1b74c768-847d-42aa-8750-e719f1d603b0&quot;,&quot;parentUUID&quot;:&quot;5997f3ee-81b9-4a3a-bfd5-2cc67963c6c9&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should allow users to burn some of their Kresko asset balances&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn some of their Kresko asset balances&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:80,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetTotalSupplyBefore = await this.krAsset.contract.totalSupply();\n// Burn Kresko asset\nconst burnAmount = (0, lib_1.toBig)(1);\nconst kreskoAssetIndex = 0;\nawait hardhat_1.default.Diamond.connect(users.userOne).burnKreskoAsset(users.userOne.address, this.krAsset.address, burnAmount, kreskoAssetIndex);\n// Confirm the user no long holds the burned Kresko asset amount\nconst userBalance = await this.krAsset.contract.balanceOf(users.userOne.address);\n(0, chai_1.expect)(userBalance).to.equal(this.mintAmount.sub(burnAmount));\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await this.krAsset.contract.totalSupply();\n(0, chai_1.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyBefore.sub(burnAmount));\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsAfter).to.deep.equal([this.krAsset.address]);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst userDebt = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(userDebt).to.closeTo(this.mintAmount.sub(burnAmount), INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5d845f3d-2f61-4c32-9c86-86dcc724c759&quot;,&quot;parentUUID&quot;:&quot;5997f3ee-81b9-4a3a-bfd5-2cc67963c6c9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to burn their full balance of a Kresko asset&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn their full balance of a Kresko asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6e12e0d2-86e4-46e6-adcb-2a162f7014f5&quot;,&quot;parentUUID&quot;:&quot;5997f3ee-81b9-4a3a-bfd5-2cc67963c6c9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to burn its own Kresko asset balances on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow trusted address to burn its own Kresko asset balances on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:97,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Grant userThree the MANAGER role\nawait hardhat_1.default.Diamond.connect(users.deployer).grantRole(_test_utils_1.Role.MANAGER, users.userThree.address);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.hasRole(_test_utils_1.Role.MANAGER, users.userThree.address)).to.equal(true);\nconst kreskoAssetTotalSupplyBefore = await this.krAsset.contract.totalSupply();\n// Burn Kresko asset\nconst burnAmount = (0, lib_1.toBig)(1);\nconst kreskoAssetIndex = 0;\n// User three burns it&#x27;s KreskoAsset to reduce userOnes debt\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userThree).burnKreskoAsset(users.userOne.address, this.krAsset.address, burnAmount, kreskoAssetIndex)).to.not.be.reverted;\n// Confirm the userOne had no effect on it&#x27;s kreskoAsset balance\nconst userOneBalance = await this.krAsset.contract.balanceOf(users.userOne.address);\n(0, chai_1.expect)(userOneBalance).to.equal(this.mintAmount);\n// Confirm the userThree no long holds the burned Kresko asset amount\nconst userThreeBalance = await this.krAsset.contract.balanceOf(users.userThree.address);\n(0, chai_1.expect)(userThreeBalance).to.equal(this.mintAmount.sub(burnAmount));\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await this.krAsset.contract.totalSupply();\n(0, chai_1.expect)(kreskoAssetTotalSupplyAfter).to.equal(kreskoAssetTotalSupplyBefore.sub(burnAmount));\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsAfter).to.deep.equal([this.krAsset.address]);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst userOneDebt = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(userOneDebt).to.closeTo(this.mintAmount.sub(burnAmount), INTEREST_RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;590c5c34-b70f-467f-994c-0275aaf3f435&quot;,&quot;parentUUID&quot;:&quot;5997f3ee-81b9-4a3a-bfd5-2cc67963c6c9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow trusted address to burn the full balance of its Kresko asset on behalf another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow trusted address to burn the full balance of its Kresko asset on behalf another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7b7bc21a-2e67-4f11-98ca-cac8cb07d572&quot;,&quot;parentUUID&quot;:&quot;5997f3ee-81b9-4a3a-bfd5-2cc67963c6c9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should burn up to the minimum debt position amount if the requested burn would result in a position under the minimum debt value&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should burn up to the minimum debt position amount if the requested burn would result in a position under the minimum debt value&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:99,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userBalanceBefore = await this.krAsset.contract.balanceOf(users.userOne.address);\nconst kreskoAssetTotalSupplyBefore = await this.krAsset.contract.totalSupply();\n// Calculate actual burn amount\nconst userOneDebt = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\nconst minDebtValue = (0, lib_1.fromBig)((await hardhat_1.default.Diamond.minimumDebtValue()).rawValue, 8);\nconst oraclePrice = this.krAsset.deployArgs.price;\nconst burnAmount = hardhat_1.default.toBig((0, lib_1.fromBig)(userOneDebt) - minDebtValue / oraclePrice);\n// Burn Kresko asset\nconst kreskoAssetIndex = 0;\nawait hardhat_1.default.Diamond.connect(users.userOne).burnKreskoAsset(users.userOne.address, this.krAsset.address, burnAmount, kreskoAssetIndex);\n// Confirm the user holds the expected Kresko asset amount\nconst userBalance = await this.krAsset.contract.balanceOf(users.userOne.address);\n// expect(fromBig(userBalance)).to.equal(fromBig(userBalanceBefore.sub(burnAmount)));\n(0, chai_1.expect)(userBalance).eq(userBalanceBefore.sub(burnAmount));\n// Confirm that the Kresko asset&#x27;s total supply decreased as expected\nconst kreskoAssetTotalSupplyAfter = await this.krAsset.contract.totalSupply();\n(0, chai_1.expect)(kreskoAssetTotalSupplyAfter).eq(kreskoAssetTotalSupplyBefore.sub(burnAmount));\n// Confirm the array of the user&#x27;s minted Kresko assets still contains the asset&#x27;s address\nconst mintedKreskoAssetsAfter = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsAfter).to.deep.equal([this.krAsset.address]);\n// Confirm the user&#x27;s minted kresko asset amount has been updated\nconst newUserDebt = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(newUserDebt).to.be.equal(userOneDebt.sub(burnAmount));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;02887954-7f5f-4a0e-b2e5-b4f965d65f08&quot;,&quot;parentUUID&quot;:&quot;5997f3ee-81b9-4a3a-bfd5-2cc67963c6c9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should emit KreskoAssetBurned event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should emit KreskoAssetBurned event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:56,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nconst tx = await hardhat_1.default.Diamond.connect(users.userOne).burnKreskoAsset(users.userOne.address, this.krAsset.address, this.mintAmount.div(5), kreskoAssetIndex);\nconst event = await (0, lib_1.getInternalEvent)(tx, types_1.MinterEvent__factory.connect(hardhat_1.default.Diamond.address, users.userOne), \&quot;KreskoAssetBurned\&quot;);\n(0, chai_1.expect)(event.account).to.equal(users.userOne.address);\n(0, chai_1.expect)(event.kreskoAsset).to.equal(this.krAsset.address);\n(0, chai_1.expect)(event.amount).to.equal(this.mintAmount.div(5));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7c4d1ed7-7b0a-413d-8311-d84b5c15fa7a&quot;,&quot;parentUUID&quot;:&quot;5997f3ee-81b9-4a3a-bfd5-2cc67963c6c9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow users to burn Kresko assets without giving token approval to Kresko.sol contract&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should allow users to burn Kresko assets without giving token approval to Kresko.sol contract&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:129,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const secondMintAmount = 1;\nconst burnAmount = this.mintAmount.add(secondMintAmount);\nawait hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, secondMintAmount);\nconst kreskoAssetIndex = 0;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).burnKreskoAsset(users.userOne.address, this.krAsset.address, burnAmount, kreskoAssetIndex)).to.be.not.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;22e82175-4c54-4b86-8d8e-f8942dda2274&quot;,&quot;parentUUID&quot;:&quot;5997f3ee-81b9-4a3a-bfd5-2cc67963c6c9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to burn an amount of 0&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow users to burn an amount of 0&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).burnKreskoAsset(users.userOne.address, this.krAsset.address, 0, kreskoAssetIndex)).to.be.revertedWith(errors_1.Error.ZERO_BURN);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6f3707d9-7614-4dc6-a5cd-2668233d4439&quot;,&quot;parentUUID&quot;:&quot;5997f3ee-81b9-4a3a-bfd5-2cc67963c6c9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow untrusted address to burn any kresko assets on behalf of another user&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow untrusted address to burn any kresko assets on behalf of another user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:27,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userThree).burnKreskoAsset(users.userOne.address, this.krAsset.address, 100, kreskoAssetIndex)).to.be.revertedWith(`AccessControl: account ${users.userThree.address.toLowerCase()} is missing role 0x46925e0f0cc76e485772167edccb8dc449d43b23b55fc4e756b063f49099e6a0`);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;40718cd0-a156-451d-b79e-75f80fbfcc22&quot;,&quot;parentUUID&quot;:&quot;5997f3ee-81b9-4a3a-bfd5-2cc67963c6c9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow users to burn more kresko assets than they hold as debt&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn should not allow users to burn more kresko assets than they hold as debt&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const kreskoAssetIndex = 0;\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebt(users.userOne.address, this.krAsset.address);\nconst burnAmount = debt.add(hardhat_1.default.toBig(1));\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(users.userOne).burnKreskoAsset(users.userOne.address, this.krAsset.address, burnAmount, kreskoAssetIndex)).to.be.reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;99edcea9-b4eb-45e7-8c7c-3ee9e0298974&quot;,&quot;parentUUID&quot;:&quot;5997f3ee-81b9-4a3a-bfd5-2cc67963c6c9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;5bdab834-ef90-426f-95d3-3fd21820a8ca&quot;,&quot;title&quot;:&quot;Protocol open fee&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should charge the protocol open fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol open fee should charge the protocol open fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:149,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const openFee = 0.01;\nconst openFeeBig = (0, lib_1.toBig)(openFee); // use toBig() to emulate closeFee&#x27;s 18 decimals on contract\nthis.krAsset = hardhat_1.default.krAssets.find(asset =&gt; asset.deployArgs.symbol === _test_utils_1.defaultKrAssetArgs.symbol);\nawait this.krAsset.update({\n    ..._test_utils_1.defaultKrAssetArgs,\n    openFee,\n});\nconst mintAmount = (0, lib_1.toBig)(1);\nconst mintValue = mintAmount.mul(this.krAsset.deployArgs.price);\nconst expectedFeeValue = mintValue.mul(openFeeBig);\nconst expectedCollateralFeeAmount = expectedFeeValue.div(this.collateral.deployArgs.price);\n// Get the balances prior to the fee being charged.\nconst kreskoCollateralAssetBalanceBefore = await this.collateral.contract.balanceOf(hardhat_1.default.Diamond.address);\nconst feeRecipientCollateralBalanceBefore = await this.collateral.contract.balanceOf(await hardhat_1.default.Diamond.feeRecipient());\n// Mint Kresko asset\nconst tx = await hardhat_1.default.Diamond.connect(users.userOne).mintKreskoAsset(users.userOne.address, this.krAsset.address, mintAmount);\n// Get the balances after the fees have been charged.\nconst kreskoCollateralAssetBalanceAfter = await this.collateral.contract.balanceOf(hardhat_1.default.Diamond.address);\nconst feeRecipientCollateralBalanceAfter = await this.collateral.contract.balanceOf(await hardhat_1.default.Diamond.feeRecipient());\n// Ensure the amount gained / lost by the kresko contract and the fee recipient are as expected\nconst feeRecipientBalanceIncrease = feeRecipientCollateralBalanceAfter.sub(feeRecipientCollateralBalanceBefore);\n(0, chai_1.expect)(kreskoCollateralAssetBalanceBefore.sub(kreskoCollateralAssetBalanceAfter)).to.equal(feeRecipientBalanceIncrease);\n// Normalize expected amount because protocol closeFee has 10**18 decimals\nconst normalizedExpectedCollateralFeeAmount = (0, lib_1.fromBig)(expectedCollateralFeeAmount) / 10 ** 18;\n(0, chai_1.expect)(feeRecipientBalanceIncrease).to.equal((0, lib_1.toBig)(normalizedExpectedCollateralFeeAmount));\n// Ensure the emitted event is as expected.\nconst event = await (0, lib_1.getInternalEvent)(tx, types_1.MinterEvent__factory.connect(hardhat_1.default.Diamond.address, users.userOne), \&quot;OpenFeePaid\&quot;);\n(0, chai_1.expect)(event.account).to.equal(users.userOne.address);\n(0, chai_1.expect)(event.paymentCollateralAsset).to.equal(this.collateral.address);\n(0, chai_1.expect)(event.paymentAmount).to.equal((0, lib_1.toBig)(normalizedExpectedCollateralFeeAmount));\nconst expectedFeeValueNormalizedA = expectedFeeValue.div(10 ** 10); // Normalize krAsset price&#x27;s 10**10 decimals on contract\nconst expectedFeeValueNormalizedB = (0, lib_1.fromBig)(expectedFeeValueNormalizedA); // Normalize closeFee&#x27;s 10**18 decimals on contract\n(0, chai_1.expect)(event.paymentValue).to.equal(expectedFeeValueNormalizedB);\n// Now verify that calcExpectedFee function returns accurate fee amount\nconst feeRes = await hardhat_1.default.Diamond.calcExpectedFee(users.userOne.address, this.krAsset.address, mintAmount, _test_utils_1.Fee.OPEN);\nconst output = feeRes.toString().split(\&quot;,\&quot;);\nconst openFeeAmount = Number(output[1]) / 10 ** 18;\n(0, chai_1.expect)(openFeeAmount).eq(normalizedExpectedCollateralFeeAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;378656ee-1822-4b01-8f19-5d2c98232b02&quot;,&quot;parentUUID&quot;:&quot;5bdab834-ef90-426f-95d3-3fd21820a8ca&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;378656ee-1822-4b01-8f19-5d2c98232b02&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:149,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;e4fd2791-5b40-4c57-a627-552f6f016db9&quot;,&quot;title&quot;:&quot;Protocol close fee&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should charge the protocol close fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol close fee should charge the protocol close fee with a single collateral asset if the deposit amount is sufficient and emit CloseFeePaid event&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:87,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const burnAmount = (0, lib_1.toBig)(1);\nconst burnValue = burnAmount.mul(this.krAsset.deployArgs.price);\nconst closeFee = (0, lib_1.toBig)(this.krAsset.deployArgs.closeFee); // use toBig() to emulate closeFee&#x27;s 18 decimals on contract\nconst expectedFeeValue = burnValue.mul(closeFee);\nconst expectedCollateralFeeAmount = expectedFeeValue.div(this.collateral.deployArgs.price);\n// Get the balances prior to the fee being charged.\nconst kreskoCollateralAssetBalanceBefore = await this.collateral.contract.balanceOf(hardhat_1.default.Diamond.address);\nconst feeRecipientCollateralBalanceBefore = await this.collateral.contract.balanceOf(await hardhat_1.default.Diamond.feeRecipient());\n// Burn Kresko asset\nconst kreskoAssetIndex = 0;\nconst tx = await hardhat_1.default.Diamond.connect(users.userOne).burnKreskoAsset(users.userOne.address, this.krAsset.address, burnAmount, kreskoAssetIndex);\n// Get the balances after the fees have been charged.\nconst kreskoCollateralAssetBalanceAfter = await this.collateral.contract.balanceOf(hardhat_1.default.Diamond.address);\nconst feeRecipientCollateralBalanceAfter = await this.collateral.contract.balanceOf(await hardhat_1.default.Diamond.feeRecipient());\n// Ensure the amount gained / lost by the kresko contract and the fee recipient are as expected\nconst feeRecipientBalanceIncrease = feeRecipientCollateralBalanceAfter.sub(feeRecipientCollateralBalanceBefore);\n(0, chai_1.expect)(kreskoCollateralAssetBalanceBefore.sub(kreskoCollateralAssetBalanceAfter)).to.equal(feeRecipientBalanceIncrease);\n// Normalize expected amount because protocol closeFee has 10**18 decimals\nconst normalizedExpectedCollateralFeeAmount = (0, lib_1.fromBig)(expectedCollateralFeeAmount) / 10 ** 18;\n(0, chai_1.expect)(feeRecipientBalanceIncrease).to.equal((0, lib_1.toBig)(normalizedExpectedCollateralFeeAmount));\n// Ensure the emitted event is as expected.\nconst event = await (0, lib_1.getInternalEvent)(tx, types_1.MinterEvent__factory.connect(hardhat_1.default.Diamond.address, users.userOne), \&quot;CloseFeePaid\&quot;);\n(0, chai_1.expect)(event.account).to.equal(users.userOne.address);\n(0, chai_1.expect)(event.paymentCollateralAsset).to.equal(this.collateral.address);\n(0, chai_1.expect)(event.paymentAmount).to.equal((0, lib_1.toBig)(normalizedExpectedCollateralFeeAmount));\nconst expectedFeeValueNormalizedA = expectedFeeValue.div(10 ** 10); // Normalize krAsset price&#x27;s 10**10 decimals on contract\nconst expectedFeeValueNormalizedB = (0, lib_1.fromBig)(expectedFeeValueNormalizedA); // Normalize closeFee&#x27;s 10**18 decimals on contract\n(0, chai_1.expect)(event.paymentValue).to.equal(expectedFeeValueNormalizedB);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f387d2f9-5ca0-41c5-b6ee-0ae3b0170919&quot;,&quot;parentUUID&quot;:&quot;e4fd2791-5b40-4c57-a627-552f6f016db9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should charge correct protocol close fee after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol close fee should charge correct protocol close fee after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:336,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const mintAmount = 10;\nconst wAmount = 1;\nconst burnAmount = 1;\nconst expectedFeeAmount = hardhat_1.default.toBig(burnAmount * this.krAsset.deployArgs.closeFee);\nconst expectedFeeValue = hardhat_1.default.toBig(burnAmount * this.krAsset.deployArgs.price * this.krAsset.deployArgs.closeFee, 8);\nawait (0, krassets_1.mintKrAsset)({ user: users.userThree, asset: this.krAsset, amount: hardhat_1.default.toBig(mintAmount) });\nawait (0, collaterals_1.withdrawCollateral)({ user: users.userThree, asset: this.collateral, amount: wAmount });\nconst event = await (0, lib_1.getInternalEvent)(await (0, krassets_1.burnKrAsset)({ user: users.userThree, asset: this.krAsset, amount: burnAmount }), types_1.MinterEvent__factory.connect(hardhat_1.default.Diamond.address, users.userThree), \&quot;CloseFeePaid\&quot;);\n(0, chai_1.expect)(event.paymentAmount).to.equal(expectedFeeAmount);\n(0, chai_1.expect)(event.paymentValue).to.equal(expectedFeeValue);\n// rebase params\nconst denominator = 4;\nconst positive = true;\nconst priceAfter = hardhat_1.default.fromBig(await this.krAsset.getPrice(), 8) / denominator;\nthis.krAsset.setPrice(priceAfter);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nconst burnAmountRebase = burnAmount * denominator;\nawait (0, collaterals_1.withdrawCollateral)({ user: users.userThree, asset: this.collateral, amount: wAmount });\nconst eventAfterRebase = await (0, lib_1.getInternalEvent)(await (0, krassets_1.burnKrAsset)({ user: users.userThree, asset: this.krAsset, amount: burnAmountRebase }), types_1.MinterEvent__factory.connect(hardhat_1.default.Diamond.address, users.userOne), \&quot;CloseFeePaid\&quot;);\n(0, chai_1.expect)(eventAfterRebase.paymentCollateralAsset).to.equal(event.paymentCollateralAsset);\n(0, chai_1.expect)(eventAfterRebase.paymentAmount).to.equal(expectedFeeAmount);\n(0, chai_1.expect)(eventAfterRebase.paymentValue).to.equal(expectedFeeValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6e28e545-cef6-4fb4-abed-83ce66c5ff81&quot;,&quot;parentUUID&quot;:&quot;e4fd2791-5b40-4c57-a627-552f6f016db9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should charge correct protocol close fee after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn Protocol close fee should charge correct protocol close fee after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:350,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const mintAmount = 10;\nconst wAmount = 1;\nconst burnAmount = 1;\nconst expectedFeeAmount = hardhat_1.default.toBig(burnAmount * this.krAsset.deployArgs.closeFee);\nconst expectedFeeValue = hardhat_1.default.toBig(burnAmount * this.krAsset.deployArgs.price * this.krAsset.deployArgs.closeFee, 8);\nawait (0, krassets_1.mintKrAsset)({ user: users.userThree, asset: this.krAsset, amount: hardhat_1.default.toBig(mintAmount) });\nawait (0, collaterals_1.withdrawCollateral)({ user: users.userThree, asset: this.collateral, amount: wAmount });\nconst event = await (0, lib_1.getInternalEvent)(await (0, krassets_1.burnKrAsset)({ user: users.userThree, asset: this.krAsset, amount: burnAmount }), types_1.MinterEvent__factory.connect(hardhat_1.default.Diamond.address, users.userThree), \&quot;CloseFeePaid\&quot;);\n(0, chai_1.expect)(event.paymentAmount).to.equal(expectedFeeAmount);\n(0, chai_1.expect)(event.paymentValue).to.equal(expectedFeeValue);\n// rebase params\nconst denominator = 4;\nconst positive = false;\nconst priceAfter = hardhat_1.default.fromBig(await this.krAsset.getPrice(), 8) * denominator;\nthis.krAsset.setPrice(priceAfter);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nconst burnAmountRebase = burnAmount / denominator;\nawait (0, collaterals_1.withdrawCollateral)({ user: users.userThree, asset: this.collateral, amount: wAmount });\nconst eventAfterRebase = await (0, lib_1.getInternalEvent)(await (0, krassets_1.burnKrAsset)({ user: users.userThree, asset: this.krAsset, amount: burnAmountRebase }), types_1.MinterEvent__factory.connect(hardhat_1.default.Diamond.address, users.userOne), \&quot;CloseFeePaid\&quot;);\n(0, chai_1.expect)(eventAfterRebase.paymentCollateralAsset).to.equal(event.paymentCollateralAsset);\n(0, chai_1.expect)(eventAfterRebase.paymentAmount).to.equal(expectedFeeAmount);\n(0, chai_1.expect)(eventAfterRebase.paymentValue).to.equal(expectedFeeValue);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a65e06cf-f672-456d-921b-633182241fc9&quot;,&quot;parentUUID&quot;:&quot;e4fd2791-5b40-4c57-a627-552f6f016db9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;f387d2f9-5ca0-41c5-b6ee-0ae3b0170919&quot;,&quot;6e28e545-cef6-4fb4-abed-83ce66c5ff81&quot;,&quot;a65e06cf-f672-456d-921b-633182241fc9&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:773,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[&quot;5d845f3d-2f61-4c32-9c86-86dcc724c759&quot;,&quot;590c5c34-b70f-467f-994c-0275aaf3f435&quot;,&quot;02887954-7f5f-4a0e-b2e5-b4f965d65f08&quot;,&quot;7c4d1ed7-7b0a-413d-8311-d84b5c15fa7a&quot;,&quot;22e82175-4c54-4b86-8d8e-f8942dda2274&quot;,&quot;6f3707d9-7614-4dc6-a5cd-2668233d4439&quot;,&quot;40718cd0-a156-451d-b79e-75f80fbfcc22&quot;,&quot;99edcea9-b4eb-45e7-8c7c-3ee9e0298974&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;6e12e0d2-86e4-46e6-adcb-2a162f7014f5&quot;,&quot;7b7bc21a-2e67-4f11-98ca-cac8cb07d572&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:518,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;68880d87-6ce7-4c1a-8d6a-4b8eb547091b&quot;,&quot;title&quot;:&quot;#burn - rebase events&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#burn - rebase events\&quot;&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events \&quot;before each\&quot; hook in \&quot;#burn - rebase events\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:56,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, krassets_1.mintKrAsset)({ asset: this.krAsset, amount: mintAmountInt, user: users.userOne });&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;09151f65-99b3-4877-a71e-06f8be12b4b5&quot;,&quot;parentUUID&quot;:&quot;68880d87-6ce7-4c1a-8d6a-4b8eb547091b&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;6d56513e-79b5-4124-a695-765b18e18866&quot;,&quot;title&quot;:&quot;debt amounts are calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when repaying all debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt amounts are calculated correctly when repaying all debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:109,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = hardhat_1.default.fromBig(assetPrice.div(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Pay half of debt\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\nconst repayAmount = debt;\nawait userOne.burnKreskoAsset(users.userOne.address, this.krAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\n(0, chai_1.expect)(debtAfter).to.bignumber.equal(0);\nconst expectedBalanceAfterBurn = 0;\nconst balanceAfterBurn = hardhat_1.default.fromBig(await this.krAsset.contract.balanceOf(users.userOne.address));\n(0, chai_1.expect)(balanceAfterBurn).to.equal(expectedBalanceAfterBurn);\n// Anchor krAssets should equal balance * denominator\nconst wkrAssetBalanceKresko = await this.krAsset.anchor.balanceOf(hardhat_1.default.Diamond.address);\n(0, chai_1.expect)(wkrAssetBalanceKresko).to.closeTo(hardhat_1.default.toBig(expectedBalanceAfterBurn / denominator), 100000); // WEI&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d78eb12c-5387-40ad-aa8c-6e5dae39c269&quot;,&quot;parentUUID&quot;:&quot;6d56513e-79b5-4124-a695-765b18e18866&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt amounts are calculated correctly when repaying partial debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:111,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = hardhat_1.default.fromBig(assetPrice.div(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Pay half of debt\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\nconst repayAmount = debt.div(2);\nawait userOne.burnKreskoAsset(users.userOne.address, this.krAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\n// Calc expected value with last update\nconst expectedDebt = mintAmount.div(2).mul(denominator);\n(0, chai_1.expect)(debtAfter).to.bignumber.equal(expectedDebt);\n// Should be all burned\nconst expectedBalanceAfter = mintAmount.mul(denominator).sub(repayAmount);\nconst balanceAfterBurn = await this.krAsset.contract.balanceOf(users.userOne.address);\n(0, chai_1.expect)(balanceAfterBurn).to.bignumber.equal(expectedBalanceAfter);\n// All wkrAssets should be burned\nconst expectedwkrBalance = mintAmount.sub(repayAmount.div(denominator));\nconst wkrAssetBalanceKresko = await this.krAsset.anchor.balanceOf(hardhat_1.default.Diamond.address);\n(0, chai_1.expect)(wkrAssetBalanceKresko).to.equal(expectedwkrBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9b06491b-9442-4bcd-a57d-0b9c5165c663&quot;,&quot;parentUUID&quot;:&quot;6d56513e-79b5-4124-a695-765b18e18866&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying all debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt amounts are calculated correctly when repaying all debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:106,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = hardhat_1.default.fromBig(assetPrice.mul(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Pay half of debt\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\nconst repayAmount = debt;\nawait userOne.burnKreskoAsset(users.userOne.address, this.krAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\n// Calc expected value with last update\nconst expectedDebt = 0;\n(0, chai_1.expect)(debtAfter).to.bignumber.equal(expectedDebt);\nconst expectedBalanceAfterBurn = 0;\nconst balanceAfterBurn = hardhat_1.default.fromBig(await this.krAsset.contract.balanceOf(users.userOne.address));\n(0, chai_1.expect)(balanceAfterBurn).to.equal(expectedBalanceAfterBurn);\n// Anchor krAssets should equal balance * denominator\nconst wkrAssetBalanceKresko = await this.krAsset.anchor.balanceOf(hardhat_1.default.Diamond.address);\n(0, chai_1.expect)(wkrAssetBalanceKresko).to.equal(hardhat_1.default.toBig(expectedBalanceAfterBurn * denominator)); // WEI&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b2f3de7a-4de8-4769-8c90-b1a09daa1ac3&quot;,&quot;parentUUID&quot;:&quot;6d56513e-79b5-4124-a695-765b18e18866&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt amounts are calculated correctly when repaying partial debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:191,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = hardhat_1.default.fromBig(assetPrice.mul(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Pay half of debt\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\nconst repayAmount = debt.div(2);\nawait userOne.burnKreskoAsset(users.userOne.address, this.krAsset.address, repayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\n// Calc expected value with last update\nconst expectedDebt = mintAmount.div(2).div(denominator);\n(0, chai_1.expect)(debtAfter).to.bignumber.equal(expectedDebt);\n// Should be all burned\nconst expectedBalanceAfter = mintAmount.div(denominator).sub(repayAmount);\nconst balanceAfterBurn = await this.krAsset.contract.balanceOf(users.userOne.address);\n(0, chai_1.expect)(balanceAfterBurn).to.bignumber.equal(expectedBalanceAfter);\n// All wkrAssets should be burned\nconst expectedwkrBalance = mintAmount.sub(repayAmount.mul(denominator));\nconst wkrAssetBalanceKresko = await this.krAsset.anchor.balanceOf(hardhat_1.default.Diamond.address);\n(0, chai_1.expect)(wkrAssetBalanceKresko).to.equal(expectedwkrBalance);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;eef132e2-b4b4-4094-bdfc-fa76fec3ab32&quot;,&quot;parentUUID&quot;:&quot;6d56513e-79b5-4124-a695-765b18e18866&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d78eb12c-5387-40ad-aa8c-6e5dae39c269&quot;,&quot;9b06491b-9442-4bcd-a57d-0b9c5165c663&quot;,&quot;b2f3de7a-4de8-4769-8c90-b1a09daa1ac3&quot;,&quot;eef132e2-b4b4-4094-bdfc-fa76fec3ab32&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:517,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;95221bb9-4912-46c2-999b-976ee65180ff&quot;,&quot;title&quot;:&quot;debt value and mintedKreskoAssets book-keeping is calculated correctly&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/minter/04-mint-repay.ts&quot;,&quot;file&quot;:&quot;/src/test/minter/04-mint-repay.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;when repaying all debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying all debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:135,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst fullRepayAmount = mintAmount.mul(denominator);\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = hardhat_1.default.fromBig(assetPrice.div(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nawait userOne.burnKreskoAsset(users.userOne.address, this.krAsset.address, fullRepayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\nconst debtValueAfter = (await hardhat_1.default.Diamond.getKrAssetValue(this.krAsset.address, debtAfter, false))\n    .rawValue;\n(0, chai_1.expect)(debtValueAfter).to.equal(0);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsAfterBurn).to.contain(this.krAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;776e850c-da39-4652-b44b-a4b70c9ab2d1&quot;,&quot;parentUUID&quot;:&quot;95221bb9-4912-46c2-999b-976ee65180ff&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a positive rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying partial debt after a positive rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:143,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = true;\nconst mintValue = (await hardhat_1.default.Diamond.getKrAssetValue(this.krAsset.address, mintAmount, false))\n    .rawValue;\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = hardhat_1.default.fromBig(assetPrice.div(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Should contain minted krAsset\nconst mintedKreskoAssetsBeforeBurn = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsBeforeBurn).to.contain(this.krAsset.address);\n// Burn assets\n// Pay half of debt\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\nawait userOne.burnKreskoAsset(users.userOne.address, this.krAsset.address, debt.div(2), 0);\n// Debt value after half repayment\nconst debtAfter = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\nconst debtValueAfter = (await hardhat_1.default.Diamond.getKrAssetValue(this.krAsset.address, debtAfter, false))\n    .rawValue;\n// Calc expected value with last update\nconst expectedValue = mintValue.div(2);\n(0, chai_1.expect)(debtValueAfter).to.equal(expectedValue);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsAfterBurn).to.contain(this.krAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0d111c00-8fcb-4223-b838-f9b3a030bd3b&quot;,&quot;parentUUID&quot;:&quot;95221bb9-4912-46c2-999b-976ee65180ff&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying all debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying all debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:448,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst fullRepayAmount = mintAmount.div(denominator);\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = hardhat_1.default.fromBig(assetPrice.mul(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\nawait userOne.burnKreskoAsset(users.userOne.address, this.krAsset.address, fullRepayAmount, 0);\n// Debt value after half repayment\nconst debtAfter = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\nconst debtValueAfter = (await hardhat_1.default.Diamond.getKrAssetValue(this.krAsset.address, debtAfter, false))\n    .rawValue;\n(0, chai_1.expect)(debtValueAfter).to.equal(0);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsAfterBurn).to.contain(this.krAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d78c6d17-a873-49af-8175-a2c3fef52dde&quot;,&quot;parentUUID&quot;:&quot;95221bb9-4912-46c2-999b-976ee65180ff&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;when repaying partial debt after a negative rebase&quot;,&quot;fullTitle&quot;:&quot;Minter #mint+burn #burn - rebase events debt value and mintedKreskoAssets book-keeping is calculated correctly when repaying partial debt after a negative rebase&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:118,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const userOne = hardhat_1.default.Diamond.connect(users.userOne);\n// Rebase params\nconst denominator = 4;\nconst positive = false;\nconst mintValue = (await hardhat_1.default.Diamond.getKrAssetValue(this.krAsset.address, mintAmount, false))\n    .rawValue;\n// Adjust price according to rebase params\nconst assetPrice = await this.krAsset.getPrice();\nconst newPrice = hardhat_1.default.fromBig(assetPrice.mul(denominator), 8);\nthis.krAsset.setPrice(newPrice);\nawait this.krAsset.contract.rebase(hardhat_1.default.toBig(denominator), positive);\n// Pay half of debt\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\nawait userOne.burnKreskoAsset(users.userOne.address, this.krAsset.address, debt.div(2), 0);\n// Debt value after half repayment\nconst debtAfter = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(users.userOne.address, this.krAsset.address);\nconst debtValueAfter = (await hardhat_1.default.Diamond.getKrAssetValue(this.krAsset.address, debtAfter, false))\n    .rawValue;\n// Calc expected value with last update\nconst expectedValue = mintValue.div(2);\n(0, chai_1.expect)(debtValueAfter).to.equal(expectedValue);\n// Should still contain minted krAsset\nconst mintedKreskoAssetsAfterBurn = await hardhat_1.default.Diamond.getMintedKreskoAssets(users.userOne.address);\n(0, chai_1.expect)(mintedKreskoAssetsAfterBurn).to.contain(this.krAsset.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;55bf4997-3e32-4215-b5db-09d750ae62a1&quot;,&quot;parentUUID&quot;:&quot;95221bb9-4912-46c2-999b-976ee65180ff&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;776e850c-da39-4652-b44b-a4b70c9ab2d1&quot;,&quot;0d111c00-8fcb-4223-b838-f9b3a030bd3b&quot;,&quot;d78c6d17-a873-49af-8175-a2c3fef52dde&quot;,&quot;55bf4997-3e32-4215-b5db-09d750ae62a1&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:844,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;64f3090b-d49d-43ee-8b17-3c760110f8b6&quot;,&quot;title&quot;:&quot;Flux Pricefeed&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/oracle/00-pricefeed.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/00-pricefeed.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Flux Pricefeed\&quot;&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed \&quot;before all\&quot; hook in \&quot;Flux Pricefeed\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;addr = await hardhat_1.default.getAddresses();\nthis.pricefeed;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1afe8b1a-dc8a-4e9d-84fe-0c6273ffb62a&quot;,&quot;parentUUID&quot;:&quot;64f3090b-d49d-43ee-8b17-3c760110f8b6&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Flux Pricefeed\&quot;&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed \&quot;before all\&quot; hook in \&quot;Flux Pricefeed\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1e8bbe13-dcb3-4685-8a4c-8d927cc076d2&quot;,&quot;parentUUID&quot;:&quot;64f3090b-d49d-43ee-8b17-3c760110f8b6&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Flux Pricefeed\&quot;&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed \&quot;before each\&quot; hook in \&quot;Flux Pricefeed\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:23,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;123ccc61-1544-4c13-89fa-806bbecf0787&quot;,&quot;parentUUID&quot;:&quot;64f3090b-d49d-43ee-8b17-3c760110f8b6&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Flux Pricefeed\&quot;&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed \&quot;before each\&quot; hook in \&quot;Flux Pricefeed\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:68,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Deploy one price feed\nconst name = \&quot;TEST\&quot;;\nconst decimals = 8;\nconst descriptionFeed = \&quot;Test description\&quot;;\nconst feed = await hardhat_1.default.run(\&quot;deployone:fluxpricefeed\&quot;, {\n    name,\n    decimals,\n    description: descriptionFeed,\n    log: false,\n});\nthis.pricefeed = feed;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b837a1a5-534d-4c54-995c-ee2b8bc40afb&quot;,&quot;parentUUID&quot;:&quot;64f3090b-d49d-43ee-8b17-3c760110f8b6&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;fd62dd64-aab5-4537-9c5f-eded1b6c6993&quot;,&quot;title&quot;:&quot;functionality&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/oracle/00-pricefeed.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/00-pricefeed.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should initialize timestamp value once the initial answer is submitted&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed functionality should initialize timestamp value once the initial answer is submitted&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:12,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await this.pricefeed.latestTimestamp()).to.equal(0);\nawait this.pricefeed.transmit(TEST_VALUE, true, { from: addr.deployer });\n(0, chai_1.expect)(Number(await this.pricefeed.latestTimestamp())).to.be.greaterThan(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;192daec5-868d-4155-a52f-161c2b8f0503&quot;,&quot;parentUUID&quot;:&quot;fd62dd64-aab5-4537-9c5f-eded1b6c6993&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return latestAnswer once it&#x27;s changed&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed functionality should return latestAnswer once it&#x27;s changed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await this.pricefeed.latestAnswer()).to.equal(0);\nawait this.pricefeed.transmit(TEST_VALUE, true, { from: addr.deployer });\n(0, chai_1.expect)(await this.pricefeed.latestAnswer()).to.equal(TEST_VALUE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1cf061a4-2f73-4703-9073-dbf5d521f804&quot;,&quot;parentUUID&quot;:&quot;fd62dd64-aab5-4537-9c5f-eded1b6c6993&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return marketOpen once it&#x27;s changed&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed functionality should return marketOpen once it&#x27;s changed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await this.pricefeed.latestMarketOpen()).to.equal(false);\nawait this.pricefeed.transmit(0, true, { from: addr.deployer });\n(0, chai_1.expect)(await this.pricefeed.latestMarketOpen()).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b75321c5-12a4-4e5d-a843-c0e3ab456442&quot;,&quot;parentUUID&quot;:&quot;fd62dd64-aab5-4537-9c5f-eded1b6c6993&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow non-validator to change values&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed functionality should not allow non-validator to change values&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:210,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await this.pricefeed.latestAnswer()).to.equal(0);\ntry {\n    await this.pricefeed.transmit(TEST_VALUE, true, { from: addr.userOne });\n}\ncatch (e) {\n    if (!(e instanceof Error))\n        return;\n    (0, chai_1.expect)(e.message).to.equal(&#x27;Contract with a Signer cannot override from (operation=\&quot;overrides.from\&quot;, code=UNSUPPORTED_OPERATION, version=contracts/5.7.0)&#x27;);\n    (0, chai_1.expect)(await this.pricefeed.latestAnswer()).to.equal(0);\n    (0, chai_1.expect)(await this.pricefeed.latestMarketOpen()).to.equal(false);\n}&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4cd5b9ab-e608-4ad6-972f-54ce7a00c816&quot;,&quot;parentUUID&quot;:&quot;fd62dd64-aab5-4537-9c5f-eded1b6c6993&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return description&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed functionality should return description&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await this.pricefeed.description()).to.equal(\&quot;Test description\&quot;);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ad14a93f-04b8-4ef4-a49e-1727f38b1bc0&quot;,&quot;parentUUID&quot;:&quot;fd62dd64-aab5-4537-9c5f-eded1b6c6993&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return decimals&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed functionality should return decimals&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;(0, chai_1.expect)(await this.pricefeed.decimals()).to.equal(8);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1a079cb6-c0a8-47ab-890a-64a7d70b53b3&quot;,&quot;parentUUID&quot;:&quot;fd62dd64-aab5-4537-9c5f-eded1b6c6993&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return latestRoundData correctly&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed functionality should return latestRoundData correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:13,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.pricefeed.transmit(TEST_VALUE, true, { from: addr.deployer });\nconst roundDataCall = await this.pricefeed.latestRoundData();\nconst roundData = {\n    roundId: roundDataCall[0].toNumber(),\n    answer: roundDataCall[1].toNumber(),\n    marketOpen: roundDataCall[2].valueOf(),\n    startedAt: roundDataCall[3].toNumber(),\n    updatedAt: roundDataCall[4].toNumber(),\n    answeredInRound: roundDataCall[5].toNumber(),\n};\n(0, chai_1.expect)(roundData.roundId).to.gt(0);\n(0, chai_1.expect)(roundData.startedAt).to.gt(0);\n(0, chai_1.expect)(roundData.startedAt).to.equal(roundData.updatedAt);\n(0, chai_1.expect)(roundData.answeredInRound).to.equal(roundData.roundId);\n(0, chai_1.expect)(roundData.answer).to.equal(TEST_VALUE);\n(0, chai_1.expect)(roundData.marketOpen).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c3406dbb-c2d3-4f8c-85da-cc8014321d25&quot;,&quot;parentUUID&quot;:&quot;fd62dd64-aab5-4537-9c5f-eded1b6c6993&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return getRoundData correctly&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed functionality should return getRoundData correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:11,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.pricefeed.transmit(TEST_VALUE, true, { from: addr.deployer });\nconst roundDataCall = await this.pricefeed.getRoundData(1);\nconst roundData = {\n    roundId: roundDataCall[0].toNumber(),\n    answer: roundDataCall[1].toNumber(),\n    marketOpen: roundDataCall[2].valueOf(),\n    startedAt: roundDataCall[3].toNumber(),\n    updatedAt: roundDataCall[4].toNumber(),\n    answeredInRound: roundDataCall[5].toNumber(),\n};\n(0, chai_1.expect)(roundData.roundId).to.gt(0);\n(0, chai_1.expect)(roundData.startedAt).to.gt(0);\n(0, chai_1.expect)(roundData.startedAt).to.equal(roundData.updatedAt);\n(0, chai_1.expect)(roundData.answeredInRound).to.equal(roundData.roundId);\n(0, chai_1.expect)(roundData.answer).to.equal(TEST_VALUE);\n(0, chai_1.expect)(roundData.marketOpen).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;221a0ddd-9505-4945-9c51-82cdc0a3022f&quot;,&quot;parentUUID&quot;:&quot;fd62dd64-aab5-4537-9c5f-eded1b6c6993&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return getAnswer correctly&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed functionality should return getAnswer correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:9,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.pricefeed.transmit(TEST_VALUE, true, { from: addr.deployer });\n(0, chai_1.expect)(await this.pricefeed.getAnswer(1)).to.equal(TEST_VALUE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f878a930-084a-4cc5-8345-36cf78590966&quot;,&quot;parentUUID&quot;:&quot;fd62dd64-aab5-4537-9c5f-eded1b6c6993&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return marketOpen correctly&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed functionality should return marketOpen correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:10,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.pricefeed.transmit(TEST_VALUE, true, { from: addr.deployer });\n(0, chai_1.expect)(await this.pricefeed.getMarketOpen(1)).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;51b1a117-0e00-4456-8734-3baa91e427c1&quot;,&quot;parentUUID&quot;:&quot;fd62dd64-aab5-4537-9c5f-eded1b6c6993&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should return latestRound correctly&quot;,&quot;fullTitle&quot;:&quot;Flux Pricefeed functionality should return latestRound correctly&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:9,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.pricefeed.transmit(TEST_VALUE, true, { from: addr.deployer });\n(0, chai_1.expect)(await this.pricefeed.latestRound()).to.equal(1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;aebdfe66-7ad2-493a-afe4-d54b86749aac&quot;,&quot;parentUUID&quot;:&quot;fd62dd64-aab5-4537-9c5f-eded1b6c6993&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;192daec5-868d-4155-a52f-161c2b8f0503&quot;,&quot;1cf061a4-2f73-4703-9073-dbf5d521f804&quot;,&quot;b75321c5-12a4-4e5d-a843-c0e3ab456442&quot;,&quot;4cd5b9ab-e608-4ad6-972f-54ce7a00c816&quot;,&quot;ad14a93f-04b8-4ef4-a49e-1727f38b1bc0&quot;,&quot;1a079cb6-c0a8-47ab-890a-64a7d70b53b3&quot;,&quot;c3406dbb-c2d3-4f8c-85da-cc8014321d25&quot;,&quot;221a0ddd-9505-4945-9c51-82cdc0a3022f&quot;,&quot;f878a930-084a-4cc5-8345-36cf78590966&quot;,&quot;51b1a117-0e00-4456-8734-3baa91e427c1&quot;,&quot;aebdfe66-7ad2-493a-afe4-d54b86749aac&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:305,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;2043a617-d43e-48dd-a7d5-d5d3bfb225a4&quot;,&quot;title&quot;:&quot;Flux price aggregator&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/oracle/01-priceaggregator.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/01-priceaggregator.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Flux price aggregator\&quot;&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator \&quot;before all\&quot; hook in \&quot;Flux price aggregator\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;addr = await hardhat_1.default.getAddresses();\nthis.aggregator;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3d9e3b85-d044-49fd-84b1-d495ee0d7444&quot;,&quot;parentUUID&quot;:&quot;2043a617-d43e-48dd-a7d5-d5d3bfb225a4&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Flux price aggregator\&quot;&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator \&quot;before all\&quot; hook in \&quot;Flux price aggregator\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2c1da83f-2380-4017-b428-2bbd56ac500c&quot;,&quot;parentUUID&quot;:&quot;2043a617-d43e-48dd-a7d5-d5d3bfb225a4&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Flux price aggregator\&quot;&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator \&quot;before each\&quot; hook in \&quot;Flux price aggregator\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;60700d55-735e-4b31-a790-6232ce28044f&quot;,&quot;parentUUID&quot;:&quot;2043a617-d43e-48dd-a7d5-d5d3bfb225a4&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Flux price aggregator\&quot;&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator \&quot;before each\&quot; hook in \&quot;Flux price aggregator\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:288,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Deploy three price feeds\nfor (let i = 0; i &lt; 3; i++) {\n    const name = \&quot;TEST\&quot; + i;\n    const decimals = 8;\n    const descriptionFeed = \&quot;Test description\&quot;;\n    const feed = await hardhat_1.default.run(\&quot;deployone:fluxpricefeed\&quot;, {\n        name,\n        decimals,\n        description: descriptionFeed,\n        log: false,\n    });\n    oracles.push(feed);\n}\n// Deploy aggregator from the 3 price feeds\nconst decimalsAggregator = 8;\nconst description = \&quot;TEST\&quot;;\nconst pricefeeds = oracles.map(oracle =&gt; oracle.address);\nconst deployedAggregator = await hardhat_1.default.run(\&quot;test:deployone:fluxpriceaggregator\&quot;, {\n    oracles: pricefeeds.toString(),\n    decimals: decimalsAggregator.toString(),\n    description,\n    log: false,\n});\nthis.aggregator = deployedAggregator;\nthis.oracles = oracles;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;72c8c92e-d179-4764-8a6c-036dee1891dd&quot;,&quot;parentUUID&quot;:&quot;2043a617-d43e-48dd-a7d5-d5d3bfb225a4&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;8cf945f9-7d4b-47a3-b738-fb7b381d8d7b&quot;,&quot;title&quot;:&quot;Basic functionality&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/oracle/01-priceaggregator.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/01-priceaggregator.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should update latest timestamp when the updatePrices() method is called&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator Basic functionality should update latest timestamp when the updatePrices() method is called&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:51,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await initializeAllPricefeeds();\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.equal(0);\nawait this.aggregator.updatePrices({ from: addr.deployer });\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.greaterThan(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;60765d17-a70a-4337-8e7e-3c3a04004ff6&quot;,&quot;parentUUID&quot;:&quot;8cf945f9-7d4b-47a3-b738-fb7b381d8d7b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should increment latestRound number when the updatePrices() method is called&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator Basic functionality should increment latestRound number when the updatePrices() method is called&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:74,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await initializeAllPricefeeds();\n(0, chai_1.expect)(Number(await this.aggregator.latestRound())).to.be.equal(0);\nawait this.aggregator.updatePrices({ from: addr.deployer });\n(0, chai_1.expect)(Number(await this.aggregator.latestRound())).to.be.equal(1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f5160bea-9533-42ae-a88c-35de2f80d2aa&quot;,&quot;parentUUID&quot;:&quot;8cf945f9-7d4b-47a3-b738-fb7b381d8d7b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow deployer to change delay&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator Basic functionality should allow deployer to change delay&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:10,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.aggregator.setDelay(12345, { from: addr.deployer });\n(0, chai_1.expect)(await this.aggregator.minDelay()).to.equal(12345);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;520827dd-c7d9-485d-a77c-68e54f7c4e8c&quot;,&quot;parentUUID&quot;:&quot;8cf945f9-7d4b-47a3-b738-fb7b381d8d7b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should allow deployer to change oracles&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator Basic functionality should allow deployer to change oracles&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Check oracle addresses\n(0, chai_1.expect)(await this.aggregator.oracles(0)).to.equal(this.oracles[0].address);\n(0, chai_1.expect)(await this.aggregator.oracles(1)).to.equal(this.oracles[1].address);\n(0, chai_1.expect)(await this.aggregator.oracles(2)).to.equal(this.oracles[2].address);\n// Remove 3rd oracle\nconst newOracles = [this.oracles[0].address, this.oracles[1].address];\nawait this.aggregator.setOracles(newOracles, { from: addr.deployer });\n// Check oracle addresses again\n(0, chai_1.expect)(await this.aggregator.oracles(0)).to.equal(this.oracles[0].address);\n(0, chai_1.expect)(await this.aggregator.oracles(1)).to.equal(this.oracles[1].address);\ntry {\n    // Third oracle should not exist anymore\n    (0, chai_1.expect)(await this.aggregator.oracles(2)).to.equal(this.oracles[2].address);\n}\ncatch (e) {\n    if (e instanceof Error) {\n        (0, chai_1.expect)(e.message).to.contain(`code=CALL_EXCEPTION`);\n    }\n}&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ded4787a-a075-4868-a6e9-9bfa6365afd7&quot;,&quot;parentUUID&quot;:&quot;8cf945f9-7d4b-47a3-b738-fb7b381d8d7b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should not allow updatePrices() to be called unless all oracles are initialized&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator Basic functionality should not allow updatePrices() to be called unless all oracles are initialized&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:166,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Rejected when there are 0 oracles initialized\nawait (0, chai_1.expect)(this.aggregator.updatePrices({ from: addr.deployer })).to.be.revertedWith(\&quot;Error: uninitialized oracle\&quot;);\n(0, chai_1.expect)(Number(await this.aggregator.latestRound())).to.be.equal(0);\n// Rejected when there is 1 oracle initialized\nawait oracles[0].transmit(0, false, {\n    from: addr.deployer,\n});\nawait (0, chai_1.expect)(this.aggregator.updatePrices({ from: addr.deployer })).to.be.revertedWith(\&quot;Error: uninitialized oracle\&quot;);\n(0, chai_1.expect)(Number(await this.aggregator.latestRound())).to.be.equal(0);\n// Rejected when there are 2 oracles initialized\nawait oracles[1].transmit(0, false, {\n    from: addr.deployer,\n});\nawait (0, chai_1.expect)(this.aggregator.updatePrices({ from: addr.deployer })).to.be.revertedWith(\&quot;Error: uninitialized oracle\&quot;);\n(0, chai_1.expect)(Number(await this.aggregator.latestRound())).to.be.equal(0);\n// Accepted when all 3 oracles are initialized\nawait oracles[2].transmit(0, false, {\n    from: addr.deployer,\n});\nawait this.aggregator.updatePrices({ from: addr.deployer });\n(0, chai_1.expect)(Number(await this.aggregator.latestRound())).to.be.equal(1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3f993ff7-9fcd-4cdd-9940-26a14258ae6e&quot;,&quot;parentUUID&quot;:&quot;8cf945f9-7d4b-47a3-b738-fb7b381d8d7b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;60765d17-a70a-4337-8e7e-3c3a04004ff6&quot;,&quot;f5160bea-9533-42ae-a88c-35de2f80d2aa&quot;,&quot;520827dd-c7d9-485d-a77c-68e54f7c4e8c&quot;,&quot;ded4787a-a075-4868-a6e9-9bfa6365afd7&quot;,&quot;3f993ff7-9fcd-4cdd-9940-26a14258ae6e&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:327,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;17c01075-ac84-45cc-a538-1319632a866c&quot;,&quot;title&quot;:&quot;Market open/close determination&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/oracle/01-priceaggregator.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/01-priceaggregator.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should determine market open/closed via majority vote&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator Market open/close determination should determine market open/closed via majority vote&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:149,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.oracles[0].transmit(100, true, {\n    from: addr.deployer,\n});\nawait this.oracles[1].transmit(150, false, {\n    from: addr.deployer,\n});\nawait this.oracles[2].transmit(160, true, {\n    from: addr.deployer,\n});\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.equal(0);\n(0, chai_1.expect)(await this.aggregator.latestMarketOpen()).to.equal(false);\nawait this.aggregator.updatePrices({ from: addr.deployer });\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.greaterThan(0);\n(0, chai_1.expect)(await this.aggregator.latestMarketOpen()).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;63525b4b-9229-4365-93a3-7560d2c1d032&quot;,&quot;parentUUID&quot;:&quot;17c01075-ac84-45cc-a538-1319632a866c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should evaluate split 50-50 decision on market as market closed&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator Market open/close determination should evaluate split 50-50 decision on market as market closed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:57,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Remove 3rd oracle so there are an even number of pricefeeds\nconst newOracles = [this.oracles[0].address, this.oracles[1].address];\nawait this.aggregator.setOracles(newOracles, { from: addr.deployer });\nawait this.oracles[0].transmit(100, true, {\n    from: addr.deployer,\n});\nawait this.oracles[1].transmit(150, false, {\n    from: addr.deployer,\n});\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.equal(0);\n(0, chai_1.expect)(await this.aggregator.latestMarketOpen()).to.equal(false);\nawait this.aggregator.updatePrices({ from: addr.deployer });\n// Timestamp updated but market open evaluates to false\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.greaterThan(0);\n(0, chai_1.expect)(await this.aggregator.latestMarketOpen()).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9793edf6-dec9-419f-9798-d4c668ea157b&quot;,&quot;parentUUID&quot;:&quot;17c01075-ac84-45cc-a538-1319632a866c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should ignore negative prices + not include their market open boolean in market open/closed determination&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator Market open/close determination should ignore negative prices + not include their market open boolean in market open/closed determination&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:158,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await initializeAllPricefeeds();\nawait this.oracles[0].transmit(100, true, {\n    from: addr.deployer,\n});\nawait this.oracles[1].transmit(-20, false, {\n    from: addr.deployer,\n});\nawait this.oracles[2].transmit(-10, false, {\n    from: addr.deployer,\n});\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.equal(0);\nawait this.aggregator.updatePrices({ from: addr.deployer });\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.greaterThan(0);\n(0, chai_1.expect)(await this.aggregator.latestMarketOpen()).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1ff3a70d-a375-4d67-a972-68d6266f1305&quot;,&quot;parentUUID&quot;:&quot;17c01075-ac84-45cc-a538-1319632a866c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;63525b4b-9229-4365-93a3-7560d2c1d032&quot;,&quot;9793edf6-dec9-419f-9798-d4c668ea157b&quot;,&quot;1ff3a70d-a375-4d67-a972-68d6266f1305&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:364,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;d1959d66-5c31-4522-a69d-8bc1dc87f745&quot;,&quot;title&quot;:&quot;Median calculations&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/oracle/01-priceaggregator.ts&quot;,&quot;file&quot;:&quot;/src/test/oracle/01-priceaggregator.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should ignore prices of oracles who report that the market is closed&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator Median calculations should ignore prices of oracles who report that the market is closed&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:212,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;// Median of (10, 500, 600) = 500\n// Median of (500, 600) = 550\nawait this.oracles[0].transmit(10, false, {\n    from: addr.deployer,\n});\nawait this.oracles[1].transmit(500, true, {\n    from: addr.deployer,\n});\nawait this.oracles[2].transmit(600, true, {\n    from: addr.deployer,\n});\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.equal(0);\n(0, chai_1.expect)(await this.aggregator.latestMarketOpen()).to.equal(false);\n(0, chai_1.expect)(Number(await this.aggregator.latestAnswer())).to.be.equal(0);\nawait this.aggregator.updatePrices({ from: addr.deployer });\n// Market is open and price should be 550\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.greaterThan(0);\n(0, chai_1.expect)(await this.aggregator.latestMarketOpen()).to.equal(true);\n(0, chai_1.expect)(Number(await this.aggregator.latestAnswer())).to.be.equal(550);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b82acf67-49c1-499c-ab59-91c37f73e67a&quot;,&quot;parentUUID&quot;:&quot;d1959d66-5c31-4522-a69d-8bc1dc87f745&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should aggregate latest prices from 3+ oracles, correctly selecting the median price&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator Median calculations should aggregate latest prices from 3+ oracles, correctly selecting the median price&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:216,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.oracles[0].transmit(100, true, {\n    from: addr.deployer,\n});\nawait this.oracles[1].transmit(125, true, {\n    from: addr.deployer,\n});\nawait this.oracles[2].transmit(300, true, {\n    from: addr.deployer,\n});\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.equal(0);\nawait this.aggregator.updatePrices({ from: addr.deployer });\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.greaterThan(0);\n(0, chai_1.expect)(await this.aggregator.latestAnswer()).to.equal(125);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;69058811-d48d-40ec-84fb-4a287a7eb47e&quot;,&quot;parentUUID&quot;:&quot;d1959d66-5c31-4522-a69d-8bc1dc87f745&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;should ignore negative prices, not including them in price aggregation&quot;,&quot;fullTitle&quot;:&quot;Flux price aggregator Median calculations should ignore negative prices, not including them in price aggregation&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:203,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.oracles[0].transmit(100, true, {\n    from: addr.deployer,\n});\nawait this.oracles[1].transmit(-20, true, {\n    from: addr.deployer,\n});\nawait this.oracles[2].transmit(-10, true, {\n    from: addr.deployer,\n});\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.equal(0);\nawait this.aggregator.updatePrices({ from: addr.deployer });\n(0, chai_1.expect)(Number(await this.aggregator.latestTimestamp())).to.be.greaterThan(0);\n(0, chai_1.expect)(await this.aggregator.latestAnswer()).to.equal(100);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f6424a66-ae65-481b-9a56-535f45dc266b&quot;,&quot;parentUUID&quot;:&quot;d1959d66-5c31-4522-a69d-8bc1dc87f745&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b82acf67-49c1-499c-ab59-91c37f73e67a&quot;,&quot;69058811-d48d-40ec-84fb-4a287a7eb47e&quot;,&quot;f6424a66-ae65-481b-9a56-535f45dc266b&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:631,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;a4cff4ec-f3b8-48c9-836f-3ee059781e36&quot;,&quot;title&quot;:&quot;Safety Council&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;fullTitle&quot;:&quot;Safety Council \&quot;before all\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d2b0feaa-e645-46c7-bfb3-b2ea73e75619&quot;,&quot;parentUUID&quot;:&quot;a4cff4ec-f3b8-48c9-836f-3ee059781e36&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;fullTitle&quot;:&quot;Safety Council \&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:26,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4152c1a5-9a0e-4d18-a51f-042482c4c3db&quot;,&quot;parentUUID&quot;:&quot;a4cff4ec-f3b8-48c9-836f-3ee059781e36&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;fullTitle&quot;:&quot;Safety Council \&quot;before each\&quot; hook in \&quot;Safety Council\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.collateral = hardhat_1.default.collaterals.find(asset =&gt; asset.deployArgs.name === _test_utils_1.defaultCollateralArgs.name);\nthis.krAsset = hardhat_1.default.krAssets.find(asset =&gt; asset.deployArgs.symbol === _test_utils_1.defaultKrAssetArgs.symbol);\n// These are the 5 signers on the SafetyCouncil multisig\nconst { deployer, devTwo, extOne, extTwo, extThree } = await hardhat_1.default.ethers.getNamedSigners();\nusers = await hardhat_1.default.getUsers();\nthis.deployer = deployer;\nthis.devTwo = devTwo;\nthis.extOne = extOne;\nthis.extTwo = extTwo;\nthis.extThree = extThree;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;32784886-8d83-40db-8f4c-8d00704942d9&quot;,&quot;parentUUID&quot;:&quot;a4cff4ec-f3b8-48c9-836f-3ee059781e36&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;e4517488-1778-4957-b94e-44ecef1ce159&quot;,&quot;title&quot;:&quot;#toggleAssetsPaused&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;42735611-1cf0-4ba7-afb6-8accae2e087a&quot;,&quot;title&quot;:&quot;multisig signature threshold&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;multisig transacts successfully with majority of signers (3/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with majority of signers (3/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:45,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.DEPOSIT, false, 0], [this.deployer, this.devTwo, this.extOne]);\nconst isPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.DEPOSIT.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;599f3cad-e5b7-41f4-9323-2d1be1d3bb1a&quot;,&quot;parentUUID&quot;:&quot;42735611-1cf0-4ba7-afb6-8accae2e087a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig transacts successfully with super-majority of signers (4/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with super-majority of signers (4/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:47,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.DEPOSIT, false, 0], [this.deployer, this.devTwo, this.extOne, this.extTwo]);\nconst isPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.DEPOSIT.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c2306a2a-ef6f-421a-ac23-e456e461a984&quot;,&quot;parentUUID&quot;:&quot;42735611-1cf0-4ba7-afb6-8accae2e087a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig transacts successfully with all signers (5/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig transacts successfully with all signers (5/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:45,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.DEPOSIT, false, 0], [this.deployer, this.devTwo, this.extOne, this.extTwo, this.extThree]);\nconst isPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.DEPOSIT.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;57d88878-c895-4c53-95cd-1e9ae62d26d2&quot;,&quot;parentUUID&quot;:&quot;42735611-1cf0-4ba7-afb6-8accae2e087a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;multisig should reject transactions signed by a minority of signers (2/5)&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused multisig signature threshold multisig should reject transactions signed by a minority of signers (2/5)&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:34,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, chai_1.expect)((0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.DEPOSIT, false, 0], [this.deployer, this.devTwo])).to.be.revertedWith(\&quot;\&quot;);\nconst isPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.DEPOSIT.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;58f47b41-2bac-4fe7-b796-28e65ec6e301&quot;,&quot;parentUUID&quot;:&quot;42735611-1cf0-4ba7-afb6-8accae2e087a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;599f3cad-e5b7-41f4-9323-2d1be1d3bb1a&quot;,&quot;c2306a2a-ef6f-421a-ac23-e456e461a984&quot;,&quot;57d88878-c895-4c53-95cd-1e9ae62d26d2&quot;,&quot;58f47b41-2bac-4fe7-b796-28e65ec6e301&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:171,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;5065814e-e325-4338-8441-23fdfea0e4d8&quot;,&quot;title&quot;:&quot;toggle actions only for listed assets&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can toggle actions for listed collateral assets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets can toggle actions for listed collateral assets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:45,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.DEPOSIT, false, 0], [this.deployer, this.devTwo, this.extOne]);\nconst isPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.DEPOSIT.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1c1bd063-03d4-4593-a693-ae3ba6f00fff&quot;,&quot;parentUUID&quot;:&quot;5065814e-e325-4338-8441-23fdfea0e4d8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle actions for listed krAssets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets can toggle actions for listed krAssets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:46,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.krAsset.address], _test_utils_1.Action.REPAY, false, 0], [this.deployer, this.devTwo, this.extOne]);\nconst isPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.REPAY.toString(), this.krAsset.address);\n(0, chai_1.expect)(isPaused).to.equal(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2604238e-10a7-4a40-9e2a-b9b3b33b40e1&quot;,&quot;parentUUID&quot;:&quot;5065814e-e325-4338-8441-23fdfea0e4d8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cannot toggle actions for addresses that are not listed collateral assets or krAssets&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle actions only for listed assets cannot toggle actions for addresses that are not listed collateral assets or krAssets&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:50,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const randomAddr = hardhat_1.default.ethers.utils.computeAddress(\&quot;0xb976778317b23a1285ec2d483eda6904d9319135b89f1d8eee9f6d2593e2665d\&quot;);\nawait (0, chai_1.expect)((0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[randomAddr], _test_utils_1.Action.DEPOSIT, false, 0], [this.deployer, this.devTwo, this.extOne])).to.be.revertedWith(\&quot;\&quot;);\nconst isPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.DEPOSIT.toString(), randomAddr);\n(0, chai_1.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7893103e-e7c6-42a2-933b-da8e39849ed8&quot;,&quot;parentUUID&quot;:&quot;5065814e-e325-4338-8441-23fdfea0e4d8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;1c1bd063-03d4-4593-a693-ae3ba6f00fff&quot;,&quot;2604238e-10a7-4a40-9e2a-b9b3b33b40e1&quot;,&quot;7893103e-e7c6-42a2-933b-da8e39849ed8&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:141,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;ec0f74f6-92e2-43b7-a4f5-73379832bdc3&quot;,&quot;title&quot;:&quot;duration based pausing&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can optionally set a timeout on a given pause command&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused duration based pausing can optionally set a timeout on a given pause command&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:46,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const duration = 100000000;\nawait (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.DEPOSIT, true, duration], [this.deployer, this.devTwo, this.extOne]);\nconst depositSafetyState = await hardhat_1.default.Diamond.safetyStateFor(this.collateral.address, _test_utils_1.Action.DEPOSIT);\n(0, chai_1.expect)(depositSafetyState.length).to.equal(1);\n// Blocktime timestamp + duration should be equal to final timestamp\n(0, chai_1.expect)(depositSafetyState[0].timestamp0.add(duration)).eq(depositSafetyState[0].timestamp1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;79bded5d-40c0-466b-a35f-4623908ada73&quot;,&quot;parentUUID&quot;:&quot;ec0f74f6-92e2-43b7-a4f5-73379832bdc3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;duration based pause functionality should expire after the duration has passed [PLACEHOLDER]&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused duration based pausing duration based pause functionality should expire after the duration has passed [PLACEHOLDER]&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:47,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const duration = 100000;\nawait (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.DEPOSIT, true, duration], [this.deployer, this.devTwo, this.extOne]);\nconst depositSafetyState = await hardhat_1.default.Diamond.safetyStateFor(this.collateral.address, _test_utils_1.Action.DEPOSIT);\n(0, chai_1.expect)(depositSafetyState.length).to.equal(1);\n// Blocktime timestamp + duration should be equal to final timestamp\n(0, chai_1.expect)(depositSafetyState[0].timestamp0.add(duration)).eq(depositSafetyState[0].timestamp1);\n// Confirm that the current blocktime is within the pause action&#x27;s duration\nconst blockNumBefore = await hardhat_1.default.ethers.provider.getBlockNumber();\nconst blockBefore = await hardhat_1.default.ethers.provider.getBlock(blockNumBefore);\nconst timestampBefore = blockBefore.timestamp;\n(0, chai_1.expect)(Number(depositSafetyState[0].timestamp1)).to.be.greaterThan(timestampBefore);\n// Increase time by seven days\nconst sevenDays = 7 * 24 * 60 * 60;\nawait hardhat_1.default.ethers.provider.send(\&quot;evm_increaseTime\&quot;, [sevenDays]);\nawait hardhat_1.default.ethers.provider.send(\&quot;evm_mine\&quot;, []);\n// Confirm that block time has increased as expected\nconst blockNumAfter = await hardhat_1.default.ethers.provider.getBlockNumber();\nconst blockAfter = await hardhat_1.default.ethers.provider.getBlock(blockNumAfter);\nconst timestampAfter = blockAfter.timestamp;\n(0, chai_1.expect)(blockNumAfter).to.be.equal(blockNumBefore + 1);\n(0, chai_1.expect)(timestampAfter).to.be.equal(timestampBefore + sevenDays);\n// Confirm that the current blocktime is after the pause action&#x27;s duration\n(0, chai_1.expect)(timestampAfter).to.be.greaterThan(Number(depositSafetyState[0].timestamp1));\n// NOTE: now we can test any functionality that should have now expired&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;688ccc53-b56f-4a8f-a874-65ba30a2cb56&quot;,&quot;parentUUID&quot;:&quot;ec0f74f6-92e2-43b7-a4f5-73379832bdc3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;79bded5d-40c0-466b-a35f-4623908ada73&quot;,&quot;688ccc53-b56f-4a8f-a874-65ba30a2cb56&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:93,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;03a009cf-d94b-4598-9612-ae1b86ef3040&quot;,&quot;title&quot;:&quot;toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can toggle action DEPOSIT pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action DEPOSIT pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:91,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.DEPOSIT, false, 0], [this.deployer, this.devTwo, this.extOne]);\nlet isPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.DEPOSIT.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(true);\nawait (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.DEPOSIT, false, 0], [this.deployer, this.devTwo, this.extOne]);\nisPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.DEPOSIT.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;312ce2d7-a899-4704-ab09-d99203167485&quot;,&quot;parentUUID&quot;:&quot;03a009cf-d94b-4598-9612-ae1b86ef3040&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action WITHDRAW pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action WITHDRAW pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:91,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.WITHDRAW, false, 0], [this.deployer, this.devTwo, this.extOne]);\nlet isPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.WITHDRAW.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(true);\nawait (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.WITHDRAW, false, 0], [this.deployer, this.devTwo, this.extOne]);\nisPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.WITHDRAW.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f2fec120-a91e-421e-b6c2-bfd27a86cd02&quot;,&quot;parentUUID&quot;:&quot;03a009cf-d94b-4598-9612-ae1b86ef3040&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action REPAY pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action REPAY pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:85,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.REPAY, false, 0], [this.deployer, this.devTwo, this.extOne]);\nlet isPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.REPAY.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(true);\nawait (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.REPAY, false, 0], [this.deployer, this.devTwo, this.extOne]);\nisPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.REPAY.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;81de0486-be6b-4bcc-80c1-bb5eae12555a&quot;,&quot;parentUUID&quot;:&quot;03a009cf-d94b-4598-9612-ae1b86ef3040&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action BORROW pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action BORROW pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:85,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.BORROW, false, 0], [this.deployer, this.devTwo, this.extOne]);\nlet isPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.BORROW.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(true);\nawait (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.BORROW, false, 0], [this.deployer, this.devTwo, this.extOne]);\nisPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.BORROW.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c1b2117e-0603-4bf6-bde2-3dde56c89ee8&quot;,&quot;parentUUID&quot;:&quot;03a009cf-d94b-4598-9612-ae1b86ef3040&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can toggle action LIQUIDATION pause status on and off&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused toggle all possible actions: DEPOSIT, WITHDRAW, REPAY, BORROW, LIQUIDATION can toggle action LIQUIDATION pause status on and off&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:93,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.LIQUIDATION, false, 0], [this.deployer, this.devTwo, this.extOne]);\nlet isPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.LIQUIDATION.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(true);\nawait (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.LIQUIDATION, false, 0], [this.deployer, this.devTwo, this.extOne]);\nisPaused = await hardhat_1.default.Diamond.assetActionPaused(_test_utils_1.Action.LIQUIDATION.toString(), this.collateral.address);\n(0, chai_1.expect)(isPaused).to.equal(false);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;31ee22c1-e037-4e9a-b1be-fe62e3a8a1a6&quot;,&quot;parentUUID&quot;:&quot;03a009cf-d94b-4598-9612-ae1b86ef3040&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;312ce2d7-a899-4704-ab09-d99203167485&quot;,&quot;f2fec120-a91e-421e-b6c2-bfd27a86cd02&quot;,&quot;81de0486-be6b-4bcc-80c1-bb5eae12555a&quot;,&quot;c1b2117e-0603-4bf6-bde2-3dde56c89ee8&quot;,&quot;31ee22c1-e037-4e9a-b1be-fe62e3a8a1a6&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:445,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;96c9494a-cdef-4d34-a917-76cd8fb46a53&quot;,&quot;title&quot;:&quot;event emission&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/safety/00-council.ts&quot;,&quot;file&quot;:&quot;/src/test/safety/00-council.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should emit event MinterEvent.SafetyStateChange on action changed containing action, asset, and description&quot;,&quot;fullTitle&quot;:&quot;Safety Council #toggleAssetsPaused event emission should emit event MinterEvent.SafetyStateChange on action changed containing action, asset, and description&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:49,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tx = await (0, execution_1.executeContractCallWithSigners)(hardhat_1.default.Multisig, hardhat_1.default.Diamond, \&quot;toggleAssetsPaused\&quot;, [[this.collateral.address], _test_utils_1.Action.DEPOSIT, false, 0], [this.deployer, this.devTwo, this.extOne]);\nconst event = await (0, events_1.getInternalEvent)(tx, types_1.MinterEvent__factory.connect(hardhat_1.default.Diamond.address, users.userOne), \&quot;SafetyStateChange\&quot;);\n(0, chai_1.expect)(event.action).to.equal(_test_utils_1.Action.DEPOSIT);\n(0, chai_1.expect)(event.asset).to.equal(this.collateral.address);\n// @ts-ignore\n(0, chai_1.expect)(event.description.hash).to.equal(hardhat_1.default.ethers.utils.keccak256(hardhat_1.default.ethers.utils.toUtf8Bytes(\&quot;paused\&quot;)));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d735d32d-9f9c-4a12-9add-00ee6da54d8a&quot;,&quot;parentUUID&quot;:&quot;96c9494a-cdef-4d34-a917-76cd8fb46a53&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d735d32d-9f9c-4a12-9add-00ee6da54d8a&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:49,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;acdd0835-70ee-4f4f-addd-c8b2ba182f7f&quot;,&quot;title&quot;:&quot;Interest Rates&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/stability-rate/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/00-init.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Interest Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Interest Rates \&quot;before all\&quot; hook in \&quot;Interest Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fe5e622f-994c-4d08-a3de-a75d9a3121bf&quot;,&quot;parentUUID&quot;:&quot;acdd0835-70ee-4f4f-addd-c8b2ba182f7f&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Interest Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Interest Rates \&quot;before each\&quot; hook in \&quot;Interest Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:22,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6b4ada6e-0079-4047-b4fe-4f5fcc860798&quot;,&quot;parentUUID&quot;:&quot;acdd0835-70ee-4f4f-addd-c8b2ba182f7f&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Interest Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Interest Rates \&quot;before each\&quot; hook in \&quot;Interest Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;this.krAsset = this.krAssets.find(c =&gt; c.deployArgs.name === test_1.defaultKrAssetArgs.name);\nthis.collateral = this.collaterals.find(c =&gt; c.deployArgs.name === test_1.defaultCollateralArgs.name);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ab15c83b-188e-44ac-94c1-c72191d6a99d&quot;,&quot;parentUUID&quot;:&quot;acdd0835-70ee-4f4f-addd-c8b2ba182f7f&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;0cd1c9d7-7829-4152-b81c-c44d8b98b5bf&quot;,&quot;title&quot;:&quot;#init&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/stability-rate/00-init.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/00-init.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;initializes correct stability rates&quot;,&quot;fullTitle&quot;:&quot;Interest Rates #init initializes correct stability rates&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const config = await hardhat_1.default.Diamond.getStabilityRateConfigurationForAsset(this.krAsset.address);\n// default values\n(0, chai_1.expect)(config.debtIndex).to.bignumber.equal(wadray_1.oneRay);\n(0, chai_1.expect)(config.stabilityRate).to.bignumber.equal(wadray_1.oneRay);\n(0, chai_1.expect)(config.asset).to.equal(this.krAsset.address);\n// configured values\n(0, chai_1.expect)(config.rateSlope1).to.bignumber.equal(test_1.defaultKrAssetArgs.stabilityRates.rateSlope1);\n(0, chai_1.expect)(config.rateSlope2).to.bignumber.equal(test_1.defaultKrAssetArgs.stabilityRates.rateSlope2);\n(0, chai_1.expect)(config.stabilityRateBase).to.bignumber.equal(test_1.defaultKrAssetArgs.stabilityRates.stabilityRateBase);\n(0, chai_1.expect)(config.optimalPriceRate).to.bignumber.equal(test_1.defaultKrAssetArgs.stabilityRates.optimalPriceRate);\n(0, chai_1.expect)(config.priceRateDelta).to.bignumber.equal(test_1.defaultKrAssetArgs.stabilityRates.priceRateDelta);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9000a3f2-c958-4ab4-b23b-2f5be1143600&quot;,&quot;parentUUID&quot;:&quot;0cd1c9d7-7829-4152-b81c-c44d8b98b5bf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;configures correct stability rates&quot;,&quot;fullTitle&quot;:&quot;Interest Rates #init configures correct stability rates&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:17,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const configuration = {\n    stabilityRateBase: wadray_1.oneRay,\n    rateSlope1: wadray_1.oneRay.mul(10),\n    rateSlope2: wadray_1.oneRay.mul(50),\n    optimalPriceRate: wadray_1.oneRay.div(2),\n    priceRateDelta: wadray_1.oneRay.div(100).mul(10),\n};\nawait hardhat_1.default.Diamond.updateStabilityRateParams(this.krAsset.address, configuration);\nconst config = await hardhat_1.default.Diamond.getStabilityRateConfigurationForAsset(this.krAsset.address);\n// default values\n(0, chai_1.expect)(config.debtIndex).to.bignumber.equal(wadray_1.oneRay);\n(0, chai_1.expect)(config.stabilityRate).to.bignumber.equal(wadray_1.oneRay);\n(0, chai_1.expect)(config.asset).to.equal(this.krAsset.address);\n// configured values\n(0, chai_1.expect)(config.rateSlope1).to.bignumber.equal(configuration.rateSlope1);\n(0, chai_1.expect)(config.rateSlope2).to.bignumber.equal(configuration.rateSlope2);\n(0, chai_1.expect)(config.stabilityRateBase).to.bignumber.equal(configuration.stabilityRateBase);\n(0, chai_1.expect)(config.optimalPriceRate).to.bignumber.equal(configuration.optimalPriceRate);\n(0, chai_1.expect)(config.priceRateDelta).to.bignumber.equal(configuration.priceRateDelta);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bc189e3a-c140-41ee-b1fa-1cf27d82b00d&quot;,&quot;parentUUID&quot;:&quot;0cd1c9d7-7829-4152-b81c-c44d8b98b5bf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cant set incorrect values&quot;,&quot;fullTitle&quot;:&quot;Interest Rates #init cant set incorrect values&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:29,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const incorrectOptimalRate = {\n    stabilityRateBase: wadray_1.oneRay,\n    rateSlope1: wadray_1.oneRay.mul(10),\n    rateSlope2: wadray_1.oneRay.mul(50),\n    optimalPriceRate: wadray_1.oneRay.add(1),\n    priceRateDelta: wadray_1.oneRay.div(100).mul(10),\n};\nconst incorrectExcessRate = {\n    stabilityRateBase: wadray_1.oneRay,\n    rateSlope1: wadray_1.oneRay.mul(10),\n    rateSlope2: wadray_1.oneRay.mul(50),\n    optimalPriceRate: wadray_1.oneRay,\n    priceRateDelta: wadray_1.oneRay.add(1),\n};\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.setupStabilityRateParams(this.krAsset.address, test_1.defaultKrAssetArgs.stabilityRates))\n    .to.be.reverted;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.updateStabilityRateParams(this.krAsset.address, incorrectOptimalRate)).to.be\n    .reverted;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.updateStabilityRateParams(this.krAsset.address, incorrectExcessRate)).to.be\n    .reverted;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1b600f2e-1fe8-4c38-a853-aea4f89d316b&quot;,&quot;parentUUID&quot;:&quot;0cd1c9d7-7829-4152-b81c-c44d8b98b5bf&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9000a3f2-c958-4ab4-b23b-2f5be1143600&quot;,&quot;bc189e3a-c140-41ee-b1fa-1cf27d82b00d&quot;,&quot;1b600f2e-1fe8-4c38-a853-aea4f89d316b&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:54,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;2c0c5ad0-0585-4c68-865b-e89f02b43afc&quot;,&quot;title&quot;:&quot;Stability Rates&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/stability-rate/01-rates.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/01-rates.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before all\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6e81fa55-fe3a-466e-828c-446e205bc149&quot;,&quot;parentUUID&quot;:&quot;2c0c5ad0-0585-4c68-865b-e89f02b43afc&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;03269728-c764-4d23-a3e5-4fee405d4cda&quot;,&quot;parentUUID&quot;:&quot;2c0c5ad0-0585-4c68-865b-e89f02b43afc&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:278,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;users = await hardhat_1.default.getUsers();\nuserOne = users.deployer;\nthis.krAsset = this.krAssets.find(c =&gt; c.deployArgs.name === test_1.defaultKrAssetArgs.name);\nthis.collateral = this.collaterals.find(c =&gt; c.deployArgs.name === test_1.defaultCollateralArgs.name);\n[UniMath] = await hardhat_1.default.deploy(\&quot;UniswapMath\&quot;, {\n    from: users.deployer.address,\n    args: [hardhat_1.default.UniV2Factory.address, hardhat_1.default.UniV2Router.address],\n});\nconst krAssetOraclePrice = 10;\nthis.krAsset.setPrice(krAssetOraclePrice);\nconst cLiq = (0, numbers_1.toBig)(1000);\nconst kLiq = (0, numbers_1.toBig)(100);\nawait this.collateral.setBalance(userOne, cLiq.mul(2));\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: cLiq,\n    user: userOne,\n});\nawait (0, krassets_1.mintKrAsset)({ user: userOne, asset: this.krAsset, amount: kLiq });\n// 1000/100 = krAsset amm price 10\nconst pair = await (0, amm_1.addLiquidity)({\n    user: userOne,\n    router: hardhat_1.default.UniV2Router,\n    amount0: cLiq,\n    amount1: kLiq,\n    token0: this.collateral,\n    token1: this.krAsset,\n});\nupdateTWAP = (0, amm_1.getTWAPUpdaterFor)(pair.address);\nawait hardhat_1.default.UniV2Oracle.initPair(pair.address, this.krAsset.address, 60 * 60);\nawait updateTWAP();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d08b6a38-904e-4835-b21a-7b9c234f8a3a&quot;,&quot;parentUUID&quot;:&quot;2c0c5ad0-0585-4c68-865b-e89f02b43afc&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;8accf6cb-7e62-419a-a518-85ac3db221da&quot;,&quot;title&quot;:&quot;#no-amm-prices&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/stability-rate/01-rates.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/01-rates.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct price rates when the amm liquidity does not qualify&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #no-amm-prices calculates correct price rates when the amm liquidity does not qualify&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;pending&quot;,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:true,&quot;code&quot;:&quot;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;58fdc3c0-a97f-4dd1-b910-497769d4c04e&quot;,&quot;parentUUID&quot;:&quot;8accf6cb-7e62-419a-a518-85ac3db221da&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct rates and debt when there is no amm price&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #no-amm-prices calculates correct rates and debt when there is no amm price&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5945,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const krAssetAmount = (0, numbers_1.toBig)(1);\nconst krAssetNoBaseRate = await (0, krassets_1.addMockKreskoAsset)({\n    name: \&quot;krasset2\&quot;,\n    symbol: \&quot;krasset2\&quot;,\n    marketOpen: true,\n    factor: 1,\n    closeFee: 0,\n    openFee: 0,\n    stabilityRateBase: ethers_1.BigNumber.from(0),\n    price: 10,\n    supplyLimit: 2000,\n});\nconst krAssetWithBaseRate = await (0, krassets_1.addMockKreskoAsset)({\n    name: \&quot;krasset2\&quot;,\n    symbol: \&quot;krasset2\&quot;,\n    marketOpen: true,\n    factor: 1,\n    closeFee: 0,\n    openFee: 0,\n    stabilityRateBase: test_1.BASIS_POINT.mul(20),\n    price: 10,\n    supplyLimit: 2000,\n});\n// Asset\nawait (0, krassets_1.mintKrAsset)({ user: userOne, asset: krAssetNoBaseRate, amount: krAssetAmount });\nawait (0, krassets_1.mintKrAsset)({ user: userOne, asset: krAssetWithBaseRate, amount: krAssetAmount });\nconst lastUpdateTimestamp = await (0, calculations_1.getBlockTimestamp)();\nconst debtIndexBefore = await hardhat_1.default.Diamond.getDebtIndexForAsset(krAssetWithBaseRate.address);\nawait hardhat_network_helpers_1.time.increase(+wadray_1.ONE_YEAR);\n// asset with no base rate and no amm price\nconst debtIndexNoBaseRate = await hardhat_1.default.Diamond.getDebtIndexForAsset(krAssetNoBaseRate.address);\nconst debtScaledNoBaseRate = await hardhat_1.default.Diamond.kreskoAssetDebt(userOne.address, krAssetNoBaseRate.address);\nconst debtPrincipalNoBaseRate = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(userOne.address, krAssetNoBaseRate.address);\nconst debtInterestNoBaseRate = await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userOne.address, krAssetNoBaseRate.address);\n(0, chai_1.expect)(debtIndexNoBaseRate).to.equal(wadray_1.oneRay);\n(0, chai_1.expect)(debtScaledNoBaseRate).to.equal(debtPrincipalNoBaseRate);\n(0, chai_1.expect)(debtInterestNoBaseRate.kissAmount).to.equal(0);\n(0, chai_1.expect)(debtInterestNoBaseRate.assetAmount).to.equal(0);\n// asset with base rate and no amm price\nconst debtIndexWithBaseRate = await hardhat_1.default.Diamond.getDebtIndexForAsset(krAssetWithBaseRate.address);\nconst debtScaledWithBaseRate = await hardhat_1.default.Diamond.kreskoAssetDebt(userOne.address, krAssetWithBaseRate.address);\nconst debtPrincipalWithBaseRate = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(userOne.address, krAssetWithBaseRate.address);\nconst debtInterestWithBaseRate = await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userOne.address, krAssetWithBaseRate.address);\nconst expectedScaledDebt = await (0, calculations_1.toScaledAmount)(debtPrincipalWithBaseRate, krAssetWithBaseRate);\nconst expectedDebtIndex = await (0, calculations_1.calcDebtIndex)(krAssetWithBaseRate, debtIndexBefore, lastUpdateTimestamp);\nconst expectedAssetInterest = debtScaledWithBaseRate.sub(debtPrincipalWithBaseRate);\nconst expectedKissInterestAmount = await (0, calculations_1.oraclePriceToWad)(hardhat_1.default.Diamond.getKrAssetValue(krAssetWithBaseRate.address, expectedAssetInterest, true));\n(0, chai_1.expect)(debtIndexWithBaseRate).to.equal(expectedDebtIndex);\n(0, chai_1.expect)(debtScaledWithBaseRate).to.equal(expectedScaledDebt);\n(0, chai_1.expect)(debtInterestWithBaseRate.assetAmount).to.equal(expectedAssetInterest);\n(0, chai_1.expect)(debtInterestWithBaseRate.kissAmount).to.equal(expectedKissInterestAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;89bdd66c-37e0-49f5-9c94-f17968a8122f&quot;,&quot;parentUUID&quot;:&quot;8accf6cb-7e62-419a-a518-85ac3db221da&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;89bdd66c-37e0-49f5-9c94-f17968a8122f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[&quot;58fdc3c0-a97f-4dd1-b910-497769d4c04e&quot;],&quot;skipped&quot;:[],&quot;duration&quot;:5945,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;f033bb85-c094-488f-8f2c-4db76437c95a&quot;,&quot;title&quot;:&quot;#price-rate&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/stability-rate/01-rates.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/01-rates.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct price rates when amm == oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #price-rate calculates correct price rates when amm == oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:71,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst ammPricesOptimal = await (0, amm_1.getAMMPrices)(this.collateral, this.krAsset);\n(0, chai_1.expect)(ammPricesOptimal.price0).to.be.closeTo(10, 0.05);\nconst priceRate = await hardhat_1.default.Diamond.getPriceRateForAsset(this.krAsset.address);\n(0, chai_1.expect)(priceRate).to.bignumber.equal(wadray_1.oneRay);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;eb869178-ef10-4302-85d8-b8be7ed63432&quot;,&quot;parentUUID&quot;:&quot;f033bb85-c094-488f-8f2c-4db76437c95a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct price rates when amm &gt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #price-rate calculates correct price rates when amm &gt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:126,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const premiumPercentage = 105; // 105% eg. 5% premium\nconst expectedPriceRate = wadray_1.oneRay.div(100).mul(premiumPercentage);\nconst krAssetAmount = (0, numbers_1.toBig)(1);\nconst collateralAmount = (0, numbers_1.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait this.collateral.setBalance(userOne, amountIn);\nawait (0, amm_1.swap)({\n    amount: amountIn,\n    route: [this.collateral.address, this.krAsset.address],\n    router: hardhat_1.default.UniV2Router,\n    user: userOne,\n});\nconst ammPricesUpPremium = await (0, amm_1.getAMMPrices)(this.collateral, this.krAsset);\n(0, chai_1.expect)(ammPricesUpPremium.price0).to.be.closeTo(10.5, 0.05);\nawait updateTWAP();\nconst priceRate = await hardhat_1.default.Diamond.getPriceRateForAsset(this.krAsset.address);\n(0, chai_1.expect)(priceRate).to.bignumber.closeTo(expectedPriceRate, wadray_1.oneRay.div(100));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0bfaee1a-ad46-4eab-a59d-88b1c742ba26&quot;,&quot;parentUUID&quot;:&quot;f033bb85-c094-488f-8f2c-4db76437c95a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct price rates when amm &lt; oracle &quot;,&quot;fullTitle&quot;:&quot;Stability Rates #price-rate calculates correct price rates when amm &lt; oracle &quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:201,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const premiumPercentage = 95; // 95% eg. 5% below oracle price\nconst expectedPriceRate = wadray_1.oneRay.div(100).mul(premiumPercentage);\nconst krAssetAmount = (0, numbers_1.toBig)(1);\nconst collateralAmount = (0, numbers_1.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, krassets_1.mintKrAsset)({ user: userOne, asset: this.krAsset, amount: amountIn });\nawait (0, amm_1.swap)({\n    amount: amountIn,\n    route: [this.krAsset.address, this.collateral.address],\n    router: hardhat_1.default.UniV2Router,\n    user: userOne,\n});\nconst ammRates = await (0, amm_1.getAMMPrices)(this.collateral, this.krAsset);\n(0, chai_1.expect)(ammRates.price0).to.be.closeTo(9.5, 0.05);\nawait updateTWAP();\nconst priceRate = await hardhat_1.default.Diamond.getPriceRateForAsset(this.krAsset.address);\n(0, chai_1.expect)(priceRate).to.bignumber.closeTo(expectedPriceRate, wadray_1.oneRay.div(100));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3190b1f6-e04b-494d-b9e1-57ebbefcf381&quot;,&quot;parentUUID&quot;:&quot;f033bb85-c094-488f-8f2c-4db76437c95a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;eb869178-ef10-4302-85d8-b8be7ed63432&quot;,&quot;0bfaee1a-ad46-4eab-a59d-88b1c742ba26&quot;,&quot;3190b1f6-e04b-494d-b9e1-57ebbefcf381&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:398,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;469c1b1e-756f-48d6-bcdc-2b00d28646e0&quot;,&quot;title&quot;:&quot;#stability-rate&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/stability-rate/01-rates.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/01-rates.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct stability rates when amm == oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability-rate calculates correct stability rates when amm == oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:96,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nawait updateTWAP();\nawait hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst stabilityRate = await hardhat_1.default.Diamond.getStabilityRateForAsset(this.krAsset.address);\nconst priceRate = await hardhat_1.default.Diamond.getPriceRateForAsset(this.krAsset.address);\n(0, chai_1.expect)(stabilityRate).to.bignumber.equal((0, calculations_1.calcExpectedStabilityRateNoPremium)(priceRate, test_1.defaultKrAssetArgs));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;478ff8a9-f63c-4cf2-ad29-231db8f45438&quot;,&quot;parentUUID&quot;:&quot;469c1b1e-756f-48d6-bcdc-2b00d28646e0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct stability rates when amm &gt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability-rate calculates correct stability rates when amm &gt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:141,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 105; // 105% eg. 5% premium\nconst krAssetAmount = (0, numbers_1.toBig)(1);\nconst collateralAmount = (0, numbers_1.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait this.collateral.setBalance(userOne, amountIn);\nawait (0, amm_1.swap)({\n    amount: amountIn,\n    route: [this.collateral.address, this.krAsset.address],\n    router: hardhat_1.default.UniV2Router,\n    user: userOne,\n});\nawait updateTWAP();\nawait hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst stabilityRate = await hardhat_1.default.Diamond.getStabilityRateForAsset(this.krAsset.address);\nconst priceRate = await hardhat_1.default.Diamond.getPriceRateForAsset(this.krAsset.address);\n(0, chai_1.expect)(stabilityRate).to.bignumber.equal((0, calculations_1.calcExpectedStabilityRateHighPremium)(priceRate, test_1.defaultKrAssetArgs));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e7afe6ae-da6b-4f36-89c0-2b62983013cf&quot;,&quot;parentUUID&quot;:&quot;469c1b1e-756f-48d6-bcdc-2b00d28646e0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct stability rates when amm &lt; oracle &quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability-rate calculates correct stability rates when amm &lt; oracle &quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:247,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 95; // 95% eg. -5% premium\nconst krAssetAmount = (0, numbers_1.toBig)(1);\nconst collateralAmount = (0, numbers_1.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, krassets_1.mintKrAsset)({ user: userOne, asset: this.krAsset, amount: amountIn });\nawait (0, amm_1.swap)({\n    amount: amountIn,\n    route: [this.krAsset.address, this.collateral.address],\n    router: hardhat_1.default.UniV2Router,\n    user: userOne,\n});\nawait updateTWAP();\nawait hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst stabilityRate = await hardhat_1.default.Diamond.getStabilityRateForAsset(this.krAsset.address);\nconst priceRate = await hardhat_1.default.Diamond.getPriceRateForAsset(this.krAsset.address);\n(0, chai_1.expect)(stabilityRate).to.bignumber.equal((0, calculations_1.calcExpectedStabilityRateLowPremium)(priceRate, test_1.defaultKrAssetArgs));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;442a370a-de0d-44e9-a6ea-b58865ed23e7&quot;,&quot;parentUUID&quot;:&quot;469c1b1e-756f-48d6-bcdc-2b00d28646e0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;478ff8a9-f63c-4cf2-ad29-231db8f45438&quot;,&quot;e7afe6ae-da6b-4f36-89c0-2b62983013cf&quot;,&quot;442a370a-de0d-44e9-a6ea-b58865ed23e7&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:484,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;ff9c8f74-9a05-4665-9e33-2c39a44ba662&quot;,&quot;title&quot;:&quot;#debt-index&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/stability-rate/01-rates.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/01-rates.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct debt index after a year when amm price &gt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt-index calculates correct debt index after a year when amm price &gt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:229,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 105; // 105% eg. 5% premium\nconst krAssetAmount = (0, numbers_1.toBig)(1);\nconst collateralAmount = (0, numbers_1.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, krassets_1.mintKrAsset)({ user: userOne, asset: this.krAsset, amount: amountIn });\nawait (0, amm_1.swap)({\n    amount: amountIn,\n    route: [this.krAsset.address, this.collateral.address],\n    router: hardhat_1.default.UniV2Router,\n    user: userOne,\n});\nawait updateTWAP();\nawait hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst debtIndexBefore = await hardhat_1.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\nconst lastUpdateTimestamp = await (0, calculations_1.getBlockTimestamp)();\nawait hardhat_network_helpers_1.time.increase(+wadray_1.ONE_YEAR);\nconst debtIndexAfter = await hardhat_1.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\n(0, chai_1.expect)(debtIndexAfter).to.not.equal(debtIndexBefore);\n(0, chai_1.expect)(debtIndexAfter).to.be.bignumber.equal(await (0, calculations_1.calcDebtIndex)(this.krAsset, debtIndexBefore, lastUpdateTimestamp));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;911cd7d6-62ac-4e93-89a1-7963e3a06470&quot;,&quot;parentUUID&quot;:&quot;ff9c8f74-9a05-4665-9e33-2c39a44ba662&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct debt index after year when amm price &lt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt-index calculates correct debt index after year when amm price &lt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:222,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 90; // 90% eg. -10% premium\nconst krAssetAmount = (0, numbers_1.toBig)(1);\nconst collateralAmount = (0, numbers_1.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, krassets_1.mintKrAsset)({ user: userOne, asset: this.krAsset, amount: amountIn });\nawait (0, amm_1.swap)({\n    amount: amountIn,\n    route: [this.krAsset.address, this.collateral.address],\n    router: hardhat_1.default.UniV2Router,\n    user: userOne,\n});\nawait updateTWAP();\nawait hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst debtIndexBefore = await hardhat_1.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\nconst lastUpdateTimestamp = await (0, calculations_1.getBlockTimestamp)();\nawait hardhat_network_helpers_1.time.increase(+wadray_1.ONE_YEAR);\nconst debtIndexAfter = await hardhat_1.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\n(0, chai_1.expect)(debtIndexAfter).to.not.equal(debtIndexBefore);\n(0, chai_1.expect)(debtIndexAfter).to.be.bignumber.equal(await (0, calculations_1.calcDebtIndex)(this.krAsset, debtIndexBefore, lastUpdateTimestamp));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f5d8ccca-7c2e-470f-bb47-1e1aa5707fb8&quot;,&quot;parentUUID&quot;:&quot;ff9c8f74-9a05-4665-9e33-2c39a44ba662&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct debt index after a year for amm price == oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt-index calculates correct debt index after a year for amm price == oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:77,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await updateTWAP();\nawait hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst debtIndexBefore = await hardhat_1.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\nconst lastUpdateTimestamp = await (0, calculations_1.getBlockTimestamp)();\nawait hardhat_network_helpers_1.time.increase(+wadray_1.ONE_YEAR);\nconst debtIndexAfter = await hardhat_1.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\n(0, chai_1.expect)(debtIndexAfter).to.not.equal(debtIndexBefore);\n(0, chai_1.expect)(debtIndexAfter).to.be.bignumber.equal(await (0, calculations_1.calcDebtIndex)(this.krAsset, debtIndexBefore, lastUpdateTimestamp));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;eb05c784-733a-43b9-8ec2-ccd8bd0d77b9&quot;,&quot;parentUUID&quot;:&quot;ff9c8f74-9a05-4665-9e33-2c39a44ba662&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;911cd7d6-62ac-4e93-89a1-7963e3a06470&quot;,&quot;f5d8ccca-7c2e-470f-bb47-1e1aa5707fb8&quot;,&quot;eb05c784-733a-43b9-8ec2-ccd8bd0d77b9&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:528,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;ed21e07f-f51a-40fa-8bb6-f9dd481152b2&quot;,&quot;title&quot;:&quot;Stability Rates&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/stability-rate/02-debt.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/02-debt.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before all\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;76362237-da8f-40c1-afac-e45140738449&quot;,&quot;parentUUID&quot;:&quot;ed21e07f-f51a-40fa-8bb6-f9dd481152b2&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6ac04ba4-165d-4788-8b1f-699d91b0568d&quot;,&quot;parentUUID&quot;:&quot;ed21e07f-f51a-40fa-8bb6-f9dd481152b2&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:318,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;users = await hardhat_1.default.getUsers();\nuserOne = users.deployer;\nuserTwo = users.userTwo;\nthis.krAsset = hardhat_1.default.krAssets.find(c =&gt; c.deployArgs.name === test_1.defaultKrAssetArgs.name);\nthis.collateral = hardhat_1.default.collaterals.find(c =&gt; c.deployArgs.name === test_1.defaultCollateralArgs.name);\n[UniMath] = await hardhat_1.default.deploy(\&quot;UniswapMath\&quot;, {\n    from: users.deployer.address,\n    args: [hardhat_1.default.UniV2Factory.address, hardhat_1.default.UniV2Router.address],\n});\nconst krAssetOraclePrice = 10;\nthis.krAsset.setPrice(krAssetOraclePrice);\nconst cLiq = (0, numbers_1.toBig)(1000);\nconst kLiq = (0, numbers_1.toBig)(100);\nawait this.collateral.setBalance(userOne, cLiq.mul(2));\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: cLiq,\n    user: userOne,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: kLiq,\n    user: userOne,\n});\nconst anchorBalance = await this.krAsset.anchor.balanceOf(hardhat_1.default.Diamond.address);\n(0, chai_1.expect)(anchorBalance).to.equal(kLiq);\n// 1000/100 = krAsset amm price 10\nconst pair = await (0, amm_1.addLiquidity)({\n    user: userOne,\n    router: hardhat_1.default.UniV2Router,\n    amount0: cLiq,\n    amount1: kLiq,\n    token0: this.collateral,\n    token1: this.krAsset,\n});\nupdateTWAP = (0, amm_1.getTWAPUpdaterFor)(pair.address);\nawait hardhat_1.default.UniV2Oracle.initPair(pair.address, this.krAsset.address, 60 * 60);\nawait updateTWAP();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8c97b81b-89a6-4f9d-a8cd-3d3353245305&quot;,&quot;parentUUID&quot;:&quot;ed21e07f-f51a-40fa-8bb6-f9dd481152b2&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;2933e8cd-cc19-4503-8589-47833e66bc8d&quot;,&quot;title&quot;:&quot;#debt calculation - mint&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/stability-rate/02-debt.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/02-debt.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#debt calculation - mint\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - mint \&quot;before each\&quot; hook in \&quot;#debt calculation - mint\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.collateral.setBalance(userTwo, depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5936c02c-f85d-4f22-904b-de1b1c0dd452&quot;,&quot;parentUUID&quot;:&quot;2933e8cd-cc19-4503-8589-47833e66bc8d&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct debt amount when amm price &gt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - mint calculates correct debt amount when amm price &gt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:390,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 105; // 105% eg. 5% premium\nconst krAssetAmount = (0, numbers_1.toBig)(1);\nconst collateralAmount = (0, numbers_1.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, krassets_1.mintKrAsset)({ user: userOne, asset: this.krAsset, amount: amountIn });\nawait (0, amm_1.swap)({\n    amount: amountIn,\n    route: [this.krAsset.address, this.collateral.address],\n    router: hardhat_1.default.UniV2Router,\n    user: userOne,\n});\nawait updateTWAP();\nawait hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nawait hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(debt).to.bignumber.equal(await (0, calculations_1.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));\nawait hardhat_network_helpers_1.time.increase(+calculations_1.ONE_YEAR);\nconst debtAfterYear = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(debtAfterYear).to.not.bignumber.equal(debt);\n(0, chai_1.expect)(debtAfterYear).to.bignumber.equal(await (0, calculations_1.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;299f92ae-2a1b-4cc9-8753-d50b12ce50bd&quot;,&quot;parentUUID&quot;:&quot;2933e8cd-cc19-4503-8589-47833e66bc8d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct debt amount when amm price &lt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - mint calculates correct debt amount when amm price &lt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:404,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 95; // 95% eg. -5% premium\nconst krAssetAmount = (0, numbers_1.toBig)(1);\nconst collateralAmount = (0, numbers_1.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, krassets_1.mintKrAsset)({ user: userOne, asset: this.krAsset, amount: amountIn });\nawait (0, amm_1.swap)({\n    amount: amountIn,\n    route: [this.krAsset.address, this.collateral.address],\n    router: hardhat_1.default.UniV2Router,\n    user: userOne,\n});\nawait updateTWAP();\nawait hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nawait hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(debt).to.bignumber.equal(await (0, calculations_1.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));\nawait hardhat_network_helpers_1.time.increase(+calculations_1.ONE_YEAR);\nconst debtAfterYear = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(debtAfterYear).to.bignumber.equal(await (0, calculations_1.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4d86a0c3-6c18-4c1f-be48-ac978cde7570&quot;,&quot;parentUUID&quot;:&quot;2933e8cd-cc19-4503-8589-47833e66bc8d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct rate index after a year for amm price == oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - mint calculates correct rate index after a year for amm price == oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:206,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await updateTWAP();\nawait hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(debt).to.bignumber.equal(await (0, calculations_1.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));\nawait hardhat_network_helpers_1.time.increase(+calculations_1.ONE_YEAR);\nconst debtIndex = await hardhat_1.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\n(0, chai_1.expect)(debtIndex.gt(wadray_1.oneRay)).to.be.true;\nconst debtAfterYear = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(debtAfterYear).to.bignumber.equal(await (0, calculations_1.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3a757f84-3404-4775-9896-47b7520593ea&quot;,&quot;parentUUID&quot;:&quot;2933e8cd-cc19-4503-8589-47833e66bc8d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;299f92ae-2a1b-4cc9-8753-d50b12ce50bd&quot;,&quot;4d86a0c3-6c18-4c1f-be48-ac978cde7570&quot;,&quot;3a757f84-3404-4775-9896-47b7520593ea&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1000,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;ec23cb7c-65b7-4ebe-ba42-776c2b7929bc&quot;,&quot;title&quot;:&quot;#debt calculation - repay&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/stability-rate/02-debt.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/02-debt.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#debt calculation - repay\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay \&quot;before each\&quot; hook in \&quot;#debt calculation - repay\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.collateral.setBalance(userTwo, depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3e7528d2-1d21-49e6-a729-0882da6770fe&quot;,&quot;parentUUID&quot;:&quot;ec23cb7c-65b7-4ebe-ba42-776c2b7929bc&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calculates correct repay amount when amm price &gt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay calculates correct repay amount when amm price &gt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:356,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 102; // 102% eg. 2% premium\nconst krAssetAmount = (0, numbers_1.toBig)(1);\nconst collateralAmount = (0, numbers_1.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait this.collateral.setBalance(userOne, amountIn);\n// buy asset, increases price\nawait (0, amm_1.swap)({\n    amount: amountIn,\n    route: [this.collateral.address, this.krAsset.address],\n    router: hardhat_1.default.UniV2Router,\n    user: userOne,\n});\nawait updateTWAP();\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(debt).to.bignumber.equal(await (0, calculations_1.toScaledAmountUser)(userTwo, mintAmount, this.krAsset));\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\nconst debtAfterYear = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst principalBefore = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\nconst burnAmount = mintAmount.div(2);\nawait (0, krassets_1.burnKrAsset)({\n    asset: this.krAsset,\n    amount: burnAmount,\n    user: userTwo,\n});\nconst debtAfterBurn = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst principalAfter = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(principalAfter).to.equal(principalBefore.sub(burnAmount));\n(0, chai_1.expect)(debtAfterBurn).to.bignumber.closeTo(debtAfterYear.sub(burnAmount), hardhat_1.default.ethers.utils.parseUnits(\&quot;10\&quot;, \&quot;gwei\&quot;));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;132eb8d6-f76c-40be-ab5c-c94e89c53d50&quot;,&quot;parentUUID&quot;:&quot;ec23cb7c-65b7-4ebe-ba42-776c2b7929bc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct repay amount when amm price &gt; oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay calculates correct repay amount when amm price &gt; oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:446,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nconst premiumPercentage = 98; // 101% eg. 1% premium\nconst krAssetAmount = (0, numbers_1.toBig)(1);\nconst collateralAmount = (0, numbers_1.toBig)(10).div(100).mul(premiumPercentage);\nconst [amountIn] = await UniMath.profitMaximizingTrade(this.collateral.address, this.krAsset.address, collateralAmount, krAssetAmount);\nawait (0, krassets_1.mintKrAsset)({ user: userOne, asset: this.krAsset, amount: amountIn });\n// dump asset, decreases price\nawait (0, amm_1.swap)({\n    amount: amountIn,\n    route: [this.krAsset.address, this.collateral.address],\n    router: hardhat_1.default.UniV2Router,\n    user: userOne,\n});\nawait updateTWAP();\nawait hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(debt).to.bignumber.closeTo(mintAmount, 10);\nconst year = 60 * 60 * 24 * 365;\nawait hardhat_network_helpers_1.time.increase(year);\nconst debtIndex = await hardhat_1.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\n(0, chai_1.expect)(debtIndex.gt(wadray_1.oneRay)).to.be.true;\nconst debtAfterYear = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst halfBalanceAfterYear = (await this.krAsset.contract.balanceOf(userTwo.address)).div(2);\nawait (0, krassets_1.burnKrAsset)({\n    asset: this.krAsset,\n    amount: halfBalanceAfterYear,\n    user: userTwo,\n});\nconst debtAfterBurn = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(debtAfterBurn).to.bignumber.closeTo(debtAfterYear.sub(halfBalanceAfterYear), wadray_1.oneRay.div(10000));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cddde222-11f3-47d5-9077-ce9687e0b62c&quot;,&quot;parentUUID&quot;:&quot;ec23cb7c-65b7-4ebe-ba42-776c2b7929bc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calculates correct rate index after a year for amm price == oracle&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay calculates correct rate index after a year for amm price == oracle&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:276,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await updateTWAP();\nawait hardhat_1.default.Diamond.updateStabilityRateAndIndexForAsset(this.krAsset.address);\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(debt).to.bignumber.closeTo(mintAmount, 10);\nconst year = 60 * 60 * 24 * 365;\nawait hardhat_network_helpers_1.time.increase(year);\nconst debtIndex = await hardhat_1.default.Diamond.getDebtIndexForAsset(this.krAsset.address);\n(0, chai_1.expect)(debtIndex.gt(wadray_1.oneRay)).to.be.true;\nconst debtAfterYear = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst halfBalanceAfterYear = (await this.krAsset.contract.balanceOf(userTwo.address)).div(2);\nawait (0, krassets_1.burnKrAsset)({\n    asset: this.krAsset,\n    amount: halfBalanceAfterYear,\n    user: userTwo,\n});\nconst debtAfterBurn = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(debtAfterBurn).to.bignumber.closeTo(debtAfterYear.sub(halfBalanceAfterYear), wadray_1.oneRay.div(10000));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b98d3f39-2528-48c7-a43d-27780a0a4299&quot;,&quot;parentUUID&quot;:&quot;ec23cb7c-65b7-4ebe-ba42-776c2b7929bc&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;132eb8d6-f76c-40be-ab5c-c94e89c53d50&quot;,&quot;cddde222-11f3-47d5-9077-ce9687e0b62c&quot;,&quot;b98d3f39-2528-48c7-a43d-27780a0a4299&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1078,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;f1873b18-0ecd-4847-97be-e5c45773fe64&quot;,&quot;title&quot;:&quot;#debt calculation - repay interest&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/stability-rate/02-debt.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/02-debt.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#debt calculation - repay interest\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest \&quot;before each\&quot; hook in \&quot;#debt calculation - repay interest\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.collateral.setBalance(userTwo, depositAmount);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a2495ee4-3b98-4c49-9a37-89a4a0987680&quot;,&quot;parentUUID&quot;:&quot;f1873b18-0ecd-4847-97be-e5c45773fe64&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can view account principal debt for asset&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can view account principal debt for asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:205,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nconst expectedPrincipalDebt = mintAmount.mul(2);\nconst principalDebtAfterOneYear = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(principalDebtAfterOneYear).to.bignumber.equal(expectedPrincipalDebt);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dbead3fd-b5f2-41b4-b59c-355d5d95f83d&quot;,&quot;parentUUID&quot;:&quot;f1873b18-0ecd-4847-97be-e5c45773fe64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can view account scaled debt for asset&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can view account scaled debt for asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:246,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nconst principalDebt = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\nconst accruedInterest = await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\nconst expectedScaledDebt = principalDebt.add(accruedInterest.assetAmount);\nconst scaledDebt = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(scaledDebt).to.bignumber.equal(expectedScaledDebt);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0ff6d4f7-cb00-4309-8e70-a4da81b81cd1&quot;,&quot;parentUUID&quot;:&quot;f1873b18-0ecd-4847-97be-e5c45773fe64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can view accrued interest in KISS&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can view accrued interest in KISS&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:253,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nconst principalDebt = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\nconst scaledDebt = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst expectedValue = (await hardhat_1.default.Diamond.getKrAssetValue(this.krAsset.address, scaledDebt.sub(principalDebt), true)).rawValue;\nconst accruedInterest = await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n// 8 decimals\n(0, chai_1.expect)(accruedInterest.kissAmount).to.bignumber.equal(expectedValue.mul(10 ** 10));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4bc5d68d-ebd1-4f2e-99e8-2c6b0d9a14b6&quot;,&quot;parentUUID&quot;:&quot;f1873b18-0ecd-4847-97be-e5c45773fe64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can repay full interest with KISS&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can repay full interest with KISS&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:302,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await hardhat_1.default.ethers.getContract(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(hardhat_1.default.Diamond.address, hardhat_1.default.ethers.constants.MaxUint256);\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\nconst minDebtAmount = (await hardhat_1.default.Diamond.minimumDebtValue()).rawValue.mul(10 ** 10);\nawait (0, krassets_1.mintKrAsset)({\n    asset: KISS,\n    amount: minDebtAmount,\n    user: userTwo,\n});\n// get the principal before repayment\nconst principalDebt = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\n// repay accrued interest\nawait hardhat_1.default.Diamond.connect(userTwo).repayFullStabilityRateInterest(userTwo.address, this.krAsset.address);\n// get values after repayment\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst accruedInterest = await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(accruedInterest.assetAmount).to.bignumber.eq(0);\n(0, chai_1.expect)(debt).to.bignumber.eq(principalDebt);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ec494ef7-264c-451f-8a75-88cd9f7038f8&quot;,&quot;parentUUID&quot;:&quot;f1873b18-0ecd-4847-97be-e5c45773fe64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can repay partial interest with KISS&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can repay partial interest with KISS&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:317,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await hardhat_1.default.ethers.getContract(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(hardhat_1.default.Diamond.address, hardhat_1.default.ethers.constants.MaxUint256);\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\nconst minDebtAmount = (await hardhat_1.default.Diamond.minimumDebtValue()).rawValue.mul(10 ** 10);\nawait (0, krassets_1.mintKrAsset)({\n    asset: KISS,\n    amount: minDebtAmount,\n    user: userTwo,\n});\nconst accruedInterestBefore = await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n// get the principal before repayment\nconst debtBefore = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst repaymentAmount = accruedInterestBefore.kissAmount.div(5);\nconst repaymentAmountAsset = accruedInterestBefore.assetAmount.div(5);\n// repay accrued interest\nawait hardhat_1.default.Diamond.connect(userTwo).repayStabilityRateInterestPartial(userTwo.address, this.krAsset.address, repaymentAmount);\n// get values after repayment\nconst debtAfter = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\nconst accruedInterestAfter = await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n// TODO: calc exact values instead of closeTo\n(0, chai_1.expect)(accruedInterestAfter.kissAmount).to.be.closeTo(accruedInterestBefore.kissAmount.sub(repaymentAmount), RATE_DELTA);\n(0, chai_1.expect)(debtAfter).to.be.closeTo(debtBefore.sub(repaymentAmountAsset), RATE_DELTA);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1f80e61d-c027-4769-8f77-fc3f75914aec&quot;,&quot;parentUUID&quot;:&quot;f1873b18-0ecd-4847-97be-e5c45773fe64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can repay all interest for multiple assets in batch&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can repay all interest for multiple assets in batch&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8080,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await hardhat_1.default.ethers.getContract(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(hardhat_1.default.Diamond.address, hardhat_1.default.ethers.constants.MaxUint256);\nawait this.collateral.setBalance(userTwo, depositAmountBig);\n// Deposit a bit more to cover the mints\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmountBig,\n    user: userTwo,\n});\n// Create few krAssets\nconst krAssets = await Promise.all([\&quot;krasset2\&quot;, \&quot;krasset3\&quot;, \&quot;krasset4\&quot;].map(async (name) =&gt; await (0, krassets_1.addMockKreskoAsset)({\n    name: name,\n    symbol: name,\n    marketOpen: true,\n    factor: 1,\n    closeFee: 0,\n    openFee: 0,\n    price: 10,\n    supplyLimit: 2000,\n    stabilityRateBase: test_1.BASIS_POINT.mul(1000), // 10%\n})));\n// mint small amount of each krasset\nawait Promise.all(krAssets.map(krAsset =&gt; (0, krassets_1.mintKrAsset)({\n    asset: krAsset,\n    amount: mintAmountSmall,\n    user: userTwo,\n})));\nconst totalInterestInKISSBefore = await hardhat_1.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n// increase time\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\nconst interestAccrued = await Promise.all(krAssets.map(asset =&gt; hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, asset.address)));\nconst expectedKissAmount = interestAccrued.reduce((a, c) =&gt; a.add(c.kissAmount), ethers_1.BigNumber.from(0));\nconst totalInterestInKISSAfter = await hardhat_1.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n(0, chai_1.expect)(totalInterestInKISSBefore.lt(totalInterestInKISSAfter)).to.be.true;\n(0, chai_1.expect)(totalInterestInKISSAfter).to.bignumber.equal(expectedKissAmount);\nconst KISSMinAmount = (0, numbers_1.toBig)(10);\nawait (0, krassets_1.mintKrAsset)({\n    asset: KISS,\n    amount: KISSMinAmount,\n    user: userTwo,\n});\nawait hardhat_1.default.Diamond.connect(userTwo).batchRepayFullStabilityRateInterest(userTwo.address);\nconst totalInterestInKISSAfterRepay = await hardhat_1.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n(0, chai_1.expect)(totalInterestInKISSAfterRepay).to.equal(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9df54065-1d04-42a5-9dd7-65b74d5c0cdf&quot;,&quot;parentUUID&quot;:&quot;f1873b18-0ecd-4847-97be-e5c45773fe64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can repay all interest and principal for a single asset&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can repay all interest and principal for a single asset&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:490,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await hardhat_1.default.ethers.getContract(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(hardhat_1.default.Diamond.address, hardhat_1.default.ethers.constants.MaxUint256);\nconst minDebtAmount = (await hardhat_1.default.Diamond.minimumDebtValue()).rawValue.mul(10 ** 10);\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: KISS,\n    amount: minDebtAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\nconst accruedInterestBeforeBurn = await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n// repay accrued interest\nawait hardhat_1.default.Diamond.connect(userTwo).burnKreskoAsset(userTwo.address, this.krAsset.address, hardhat_1.default.ethers.constants.MaxUint256, 0);\nconst accruedInterestAfterBurn = await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n// Ensure burning does not wipe interest accrued\n(0, chai_1.expect)(accruedInterestAfterBurn.assetAmount.gt(accruedInterestBeforeBurn.assetAmount)).to.be.true;\n(0, chai_1.expect)(accruedInterestAfterBurn.kissAmount.gt(accruedInterestBeforeBurn.kissAmount)).to.be.true;\nconst mintedKreskoAssetsBefore = await hardhat_1.default.Diamond.getMintedKreskoAssets(userTwo.address);\n(0, chai_1.expect)(mintedKreskoAssetsBefore.length).to.equal(2);\nawait hardhat_1.default.Diamond.connect(userTwo).repayFullStabilityRateInterest(userTwo.address, this.krAsset.address);\nconst mintedKreskoAssetsAfter = await hardhat_1.default.Diamond.getMintedKreskoAssets(userTwo.address);\n(0, chai_1.expect)(mintedKreskoAssetsAfter.length).to.equal(1);\nconst accruedInterestAfterRepayment = await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\nconst principalDebt = await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address);\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n// Ensure debt actually gets wiped\n(0, chai_1.expect)(principalDebt).to.equal(0);\n(0, chai_1.expect)(accruedInterestAfterRepayment.assetAmount).to.equal(0);\n(0, chai_1.expect)(accruedInterestAfterRepayment.kissAmount).to.equal(0);\n(0, chai_1.expect)(debt).to.equal(0);\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\nconst accruedInterestYearAfterRepayment = await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n// Sanity check with another year of time that there is no interest accrual\n(0, chai_1.expect)(accruedInterestYearAfterRepayment.assetAmount).to.equal(0);\n(0, chai_1.expect)(accruedInterestYearAfterRepayment.kissAmount).to.equal(0);\n// Get kr asset value, should be only KISS minted that remains\nconst krAssetValue = (await hardhat_1.default.Diamond.getAccountKrAssetValue(userTwo.address)).rawValue;\n(0, chai_1.expect)(krAssetValue).to.equal((0, numbers_1.toBig)(10, 8));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7da1b9eb-812f-4b9b-a4cf-7a62ad774bd9&quot;,&quot;parentUUID&quot;:&quot;f1873b18-0ecd-4847-97be-e5c45773fe64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can batch repay interest and all debt&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can batch repay interest and all debt&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8108,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await hardhat_1.default.ethers.getContract(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(hardhat_1.default.Diamond.address, hardhat_1.default.ethers.constants.MaxUint256);\nconst minDebtAmount = (await hardhat_1.default.Diamond.minimumDebtValue()).rawValue.mul(10 ** 10);\nawait this.collateral.setBalance(userTwo, depositAmountBig);\n// Deposit a bit more to cover the mints\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmountBig,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: KISS,\n    amount: minDebtAmount,\n    user: userTwo,\n});\n// Create few krAssets\nconst krAssets = await Promise.all([\&quot;krasset2\&quot;, \&quot;krasset3\&quot;, \&quot;krasset4\&quot;].map(async (name) =&gt; await (0, krassets_1.addMockKreskoAsset)({\n    name: name,\n    symbol: name,\n    marketOpen: true,\n    factor: 1,\n    closeFee: 0,\n    openFee: 0,\n    price: 10,\n    supplyLimit: 2000,\n    stabilityRateBase: test_1.BASIS_POINT.mul(1000), // 10%\n})));\n// mint small amount of each krasset\nawait Promise.all(krAssets.map(krAsset =&gt; (0, krassets_1.mintKrAsset)({\n    asset: krAsset,\n    amount: mintAmountSmall,\n    user: userTwo,\n})));\nconst totalInterestInKISSBefore = await hardhat_1.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n// increase time\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\nconst interestAccrued = await Promise.all(krAssets.map(asset =&gt; hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, asset.address)));\nconst expectedKissAmount = interestAccrued.reduce((a, c) =&gt; a.add(c.kissAmount), ethers_1.BigNumber.from(0));\nconst totalInterestInKISSAfter = await hardhat_1.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n(0, chai_1.expect)(totalInterestInKISSBefore.lt(totalInterestInKISSAfter)).to.be.true;\n(0, chai_1.expect)(totalInterestInKISSAfter).to.bignumber.equal(expectedKissAmount);\nawait Promise.all(krAssets.map(async (asset) =&gt; hardhat_1.default.Diamond.connect(userTwo).burnKreskoAsset(userTwo.address, asset.address, hardhat_1.default.ethers.constants.MaxUint256, await hardhat_1.default.Diamond.getMintedKreskoAssetsIndex(userTwo.address, asset.address))));\nconst mintedKreskoAssetsBefore = await hardhat_1.default.Diamond.getMintedKreskoAssets(userTwo.address);\n(0, chai_1.expect)(mintedKreskoAssetsBefore.length).to.equal(4);\nawait hardhat_1.default.Diamond.connect(userTwo).batchRepayFullStabilityRateInterest(userTwo.address);\nconst totalInterestInKISSAfterRepay = await hardhat_1.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n(0, chai_1.expect)(totalInterestInKISSAfterRepay).to.equal(0);\nconst mintedKreskoAssetsAfter = await hardhat_1.default.Diamond.getMintedKreskoAssets(userTwo.address);\n(0, chai_1.expect)(mintedKreskoAssetsAfter.length).to.equal(1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;203ca468-7534-4d66-a89d-eaee8abc2ec1&quot;,&quot;parentUUID&quot;:&quot;f1873b18-0ecd-4847-97be-e5c45773fe64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can open up a new debt positions after wiping all debt + interest&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can open up a new debt positions after wiping all debt + interest&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:934,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await hardhat_1.default.ethers.getContract(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(hardhat_1.default.Diamond.address, hardhat_1.default.ethers.constants.MaxUint256);\nconst minDebtAmount = (await hardhat_1.default.Diamond.minimumDebtValue()).rawValue.mul(10 ** 10);\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: KISS,\n    amount: minDebtAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\nconst expectedDebtAfterOneYear = await (0, calculations_1.toScaledAmountUser)(userTwo, mintAmount, this.krAsset);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address)).to.eq(expectedDebtAfterOneYear);\n// Wipe debt\nawait hardhat_1.default.Diamond.connect(userTwo).burnKreskoAsset(userTwo.address, this.krAsset.address, hardhat_1.default.ethers.constants.MaxUint256, 0);\nconst accruedInterest = (await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address))\n    .assetAmount;\n// Mint again, before interest repayment\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\n// Ensure debt is principal + interest\n(0, chai_1.expect)(await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address)).to.closeTo(mintAmount.add(accruedInterest), RATE_DELTA);\n// Burn all assets\nawait hardhat_1.default.Diamond.connect(userTwo).burnKreskoAsset(userTwo.address, this.krAsset.address, hardhat_1.default.ethers.constants.MaxUint256, 0);\n// Ensure debt is equal to interest\nconst accruedInterestAfterBurn = (await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address)).assetAmount;\n(0, chai_1.expect)(await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address)).to.eq(accruedInterestAfterBurn);\n// Repay all interest\nawait hardhat_1.default.Diamond.connect(userTwo).repayFullStabilityRateInterest(userTwo.address, this.krAsset.address);\n// Debt should be wiped\n(0, chai_1.expect)(await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address)).to.eq(0);\n// Mint again\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\n// Scaled should be equal to principal\n(0, chai_1.expect)(await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address)).to.eq(mintAmount);\n// Advance time\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\n// Ensure accrual is the same as the previous year with the same position\nconst debt = await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(debt).to.eq(expectedDebtAfterOneYear);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;475343c6-957f-44f9-8587-bf545d749fe7&quot;,&quot;parentUUID&quot;:&quot;f1873b18-0ecd-4847-97be-e5c45773fe64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can fully close a position in single transaction using the helper function&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can fully close a position in single transaction using the helper function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:478,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await hardhat_1.default.ethers.getContract(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(hardhat_1.default.Diamond.address, hardhat_1.default.ethers.constants.MaxUint256);\nconst minDebtAmount = (await hardhat_1.default.Diamond.minimumDebtValue()).rawValue.mul(10 ** 10);\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: KISS,\n    amount: minDebtAmount,\n    user: userOne,\n});\nawait KISS.connect(userOne).transfer(userTwo.address, minDebtAmount);\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: mintAmount,\n    user: userTwo,\n});\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\nawait hardhat_1.default.Diamond.connect(userTwo).closeKrAssetDebtPosition(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.kreskoAssetDebt(userTwo.address, this.krAsset.address)).to.eq(0);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.kreskoAssetDebtPrincipal(userTwo.address, this.krAsset.address)).to.eq(0);\nconst accruedInterest = await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, this.krAsset.address);\n(0, chai_1.expect)(accruedInterest.assetAmount).to.eq(0);\n(0, chai_1.expect)(accruedInterest.kissAmount).to.eq(0);\n(0, chai_1.expect)((await hardhat_1.default.Diamond.getMintedKreskoAssets(userTwo.address)).length).to.eq(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bef7acdb-07f1-4e99-9cb6-6905b4f592fa&quot;,&quot;parentUUID&quot;:&quot;f1873b18-0ecd-4847-97be-e5c45773fe64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can fully close all positions and interest in single transaction using the helper function&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #debt calculation - repay interest can fully close all positions and interest in single transaction using the helper function&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:8076,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await hardhat_1.default.ethers.getContract(\&quot;KISS\&quot;);\nawait KISS.connect(userTwo).approve(hardhat_1.default.Diamond.address, hardhat_1.default.ethers.constants.MaxUint256);\nconst kissAmount = (await hardhat_1.default.Diamond.minimumDebtValue()).rawValue.mul(10 ** 10).mul(2);\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: KISS,\n    amount: kissAmount,\n    user: userOne,\n});\nawait KISS.connect(userOne).transfer(userTwo.address, kissAmount);\nconst krAssets = await Promise.all([\&quot;krasset2\&quot;, \&quot;krasset3\&quot;, \&quot;krasset4\&quot;].map(async (name) =&gt; await (0, krassets_1.addMockKreskoAsset)({\n    name: name,\n    symbol: name,\n    marketOpen: true,\n    factor: 1,\n    closeFee: 0,\n    openFee: 0,\n    price: 10,\n    supplyLimit: 2000,\n    stabilityRateBase: test_1.BASIS_POINT.mul(1000), // 10%\n})));\n// mint small amount of each krasset\nawait Promise.all(krAssets.map(krAsset =&gt; (0, krassets_1.mintKrAsset)({\n    asset: krAsset,\n    amount: mintAmountSmall,\n    user: userTwo,\n})));\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\n// ~1M gas with 8 krAssets\n// console.log(+(await tx.wait()).gasUsed);\nawait hardhat_1.default.Diamond.connect(userTwo).batchCloseKrAssetDebtPositions(userTwo.address);\nconst accruedInterest = await hardhat_1.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n(0, chai_1.expect)(accruedInterest).to.eq(0);\n(0, chai_1.expect)((await hardhat_1.default.Diamond.getAccountKrAssetValue(userTwo.address)).rawValue).to.eq(0);\n(0, chai_1.expect)((await hardhat_1.default.Diamond.getMintedKreskoAssets(userTwo.address)).length).to.eq(0);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a5ec3e70-ff3e-4adc-9637-ecf7e466246f&quot;,&quot;parentUUID&quot;:&quot;f1873b18-0ecd-4847-97be-e5c45773fe64&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;dbead3fd-b5f2-41b4-b59c-355d5d95f83d&quot;,&quot;0ff6d4f7-cb00-4309-8e70-a4da81b81cd1&quot;,&quot;4bc5d68d-ebd1-4f2e-99e8-2c6b0d9a14b6&quot;,&quot;ec494ef7-264c-451f-8a75-88cd9f7038f8&quot;,&quot;1f80e61d-c027-4769-8f77-fc3f75914aec&quot;,&quot;9df54065-1d04-42a5-9dd7-65b74d5c0cdf&quot;,&quot;7da1b9eb-812f-4b9b-a4cf-7a62ad774bd9&quot;,&quot;203ca468-7534-4d66-a89d-eaee8abc2ec1&quot;,&quot;475343c6-957f-44f9-8587-bf545d749fe7&quot;,&quot;bef7acdb-07f1-4e99-9cb6-6905b4f592fa&quot;,&quot;a5ec3e70-ff3e-4adc-9637-ecf7e466246f&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:27489,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000},{&quot;uuid&quot;:&quot;9cc19cf5-e735-4288-a7a2-ad55c8004741&quot;,&quot;title&quot;:&quot;Stability Rates&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/stability-rate/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before all\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;if (currentFixtureName &amp;&amp; fixtureName.join(\&quot;\&quot;) !== currentFixtureName.join(\&quot;\&quot;)) {\n    hardhat_1.default.collaterals = [];\n    hardhat_1.default.krAssets = [];\n    hardhat_1.default.allAssets = [];\n    hardhat_1.default.Diamond = undefined;\n}\ncurrentFixtureName = fixtureName;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3d950611-3245-4ad9-82a4-85601b38cee5&quot;,&quot;parentUUID&quot;:&quot;9cc19cf5-e735-4288-a7a2-ad55c8004741&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:24,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const fixture = await hardhat_1.deployments.createFixture(async (hre) =&gt; {\n    const result = await hardhat_1.deployments.fixture(fixtureName);\n    if (result.Diamond) {\n        hre.Diamond = await hardhat_1.ethers.getContractAt(\&quot;Kresko\&quot;, result.Diamond.address);\n    }\n    return {\n        facets: result.Diamond ? result.Diamond.facets : [],\n        collaterals: hre.collaterals,\n        krAssets: hre.krAssets,\n    };\n})();\nthis.facets = fixture.facets;\nthis.collaterals = fixture.collaterals;\nthis.krAssets = fixture.krAssets;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;346792d2-9aab-46f2-9282-58169976331c&quot;,&quot;parentUUID&quot;:&quot;9cc19cf5-e735-4288-a7a2-ad55c8004741&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates \&quot;before each\&quot; hook in \&quot;Stability Rates\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:450,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;users = await hardhat_1.default.getUsers();\nliquidator = users.deployer;\nuserTwo = users.userTwo;\nthis.krAsset = hardhat_1.default.krAssets.find(c =&gt; c.deployArgs.name === test_1.defaultKrAssetArgs.name);\nthis.collateral = hardhat_1.default.collaterals.find(c =&gt; c.deployArgs.name === test_1.defaultCollateralArgs.name);\nconst krAssetOraclePrice = 10;\nthis.krAsset.setPrice(krAssetOraclePrice);\nconst cLiq = (0, numbers_1.toBig)(1000);\nconst kLiq = (0, numbers_1.toBig)(100);\nawait this.collateral.setBalance(liquidator, cLiq.mul(2));\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: cLiq,\n    user: liquidator,\n});\nawait (0, krassets_1.mintKrAsset)({\n    asset: this.krAsset,\n    amount: kLiq,\n    user: liquidator,\n});\nconst anchorBalance = await this.krAsset.anchor.balanceOf(hardhat_1.default.Diamond.address);\n(0, chai_1.expect)(anchorBalance).to.equal(kLiq);\n// 1000/100 = krAsset amm price 10\nconst pair = await (0, amm_1.addLiquidity)({\n    user: liquidator,\n    router: hardhat_1.default.UniV2Router,\n    amount0: cLiq,\n    amount1: kLiq,\n    token0: this.collateral,\n    token1: this.krAsset,\n});\nupdateTWAP = (0, amm_1.getTWAPUpdaterFor)(pair.address);\nawait hardhat_1.default.UniV2Oracle.initPair(pair.address, this.krAsset.address, 60 * 60);\nawait updateTWAP();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;748d5756-b6fb-4b0c-b5a6-e4f1b82d4503&quot;,&quot;parentUUID&quot;:&quot;9cc19cf5-e735-4288-a7a2-ad55c8004741&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;c05a09f6-9e6b-4937-b03d-0efd2129384e&quot;,&quot;title&quot;:&quot;#stability rate - liquidation&quot;,&quot;fullFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/src/test/stability-rate/03-liquidation.ts&quot;,&quot;file&quot;:&quot;/src/test/stability-rate/03-liquidation.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook in \&quot;#stability rate - liquidation\&quot;&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability rate - liquidation \&quot;before each\&quot; hook in \&quot;#stability rate - liquidation\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6959,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.collateral.setBalance(userTwo, depositAmount);\n// Create few krAssets\nkrAssets = await Promise.all([\&quot;krasset2\&quot;, \&quot;krasset3\&quot;, \&quot;krasset4\&quot;].map(async (name) =&gt; await (0, krassets_1.addMockKreskoAsset)({\n    name: name,\n    symbol: name,\n    marketOpen: true,\n    factor: 1.1,\n    closeFee: 0,\n    openFee: 0,\n    price: 10,\n    supplyLimit: 2000,\n    stabilityRateBase: test_1.BASIS_POINT.mul(1000), // 10%\n})));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1d7c0ac3-a53b-43ca-a8d8-7cd3a6832f23&quot;,&quot;parentUUID&quot;:&quot;c05a09f6-9e6b-4937-b03d-0efd2129384e&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;cannot liquidate accrued interest of healthy account&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability rate - liquidation cannot liquidate accrued interest of healthy account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:628,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.collateral.setBalance(userTwo, depositAmount);\n// Deposit a bit more to cover the mints\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\n// mint each krasset\nawait Promise.all(krAssets.map(krAsset =&gt; (0, krassets_1.mintKrAsset)({\n    asset: krAsset,\n    amount: mintAmount,\n    user: userTwo,\n})));\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\nconst krAsset = krAssets[0];\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.false;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(liquidator).liquidateInterest(userTwo.address, krAsset.address, this.collateral.address)).to.be.revertedWith(errors_1.Error.NOT_LIQUIDATABLE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b3557f36-530c-4f87-90b7-cf651e7beb40&quot;,&quot;parentUUID&quot;:&quot;c05a09f6-9e6b-4937-b03d-0efd2129384e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;cannot batch liquidate accrued interest of healthy account&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability rate - liquidation cannot batch liquidate accrued interest of healthy account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:731,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;await this.collateral.setBalance(userTwo, depositAmount);\n// Deposit a bit more to cover the mints\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\n// mint each krasset\nawait Promise.all(krAssets.map(krAsset =&gt; (0, krassets_1.mintKrAsset)({\n    asset: krAsset,\n    amount: mintAmount,\n    user: userTwo,\n})));\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR);\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.false;\nawait (0, chai_1.expect)(hardhat_1.default.Diamond.connect(liquidator).batchLiquidateInterest(userTwo.address, this.collateral.address)).to.be.revertedWith(errors_1.Error.NOT_LIQUIDATABLE);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f06c1b4e-58aa-4713-8cfb-0ebad28d7bfb&quot;,&quot;parentUUID&quot;:&quot;c05a09f6-9e6b-4937-b03d-0efd2129384e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can liquidate accrued interest of unhealthy account&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability rate - liquidation can liquidate accrued interest of unhealthy account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1533,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await hardhat_1.default.ethers.getContract(\&quot;KISS\&quot;);\nawait KISS.connect(liquidator).approve(hardhat_1.default.Diamond.address, hardhat_1.default.ethers.constants.MaxUint256);\nawait this.collateral.setBalance(userTwo, depositAmount);\n// Deposit a bit more to cover the mints\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\n// mint each krasset\nawait Promise.all(krAssets.map(krAsset =&gt; (0, krassets_1.mintKrAsset)({\n    asset: krAsset,\n    amount: mintAmount,\n    user: userTwo,\n})));\n// Up the asset prices\nconst newPrice = 15;\nkrAssets.map(asset =&gt; asset.setPrice(newPrice));\n// increase time so account is liquidatable\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.false;\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR * 4);\n// should be liquidatable\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.true;\n// Asset to liquidate\nconst krAsset = krAssets[0];\nconst interestUSDTotal = await hardhat_1.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address);\n// Liquidator mints KISS\nawait (0, krassets_1.mintKrAsset)({\n    asset: KISS,\n    amount: interestUSDTotal.add((0, numbers_1.toBig)(1)),\n    user: liquidator,\n});\n// liquidatable value total before\nconst accruedKissInterest = (0, hardhat_1.fromBig)((await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, krAsset.address)).kissAmount);\nconst accountCollateralBefore = await hardhat_1.default.Diamond.collateralDeposits(userTwo.address, this.collateral.address);\n// Wipe seized collateral balance before liquidation for easy comparison\nawait this.collateral.setBalance(liquidator, (0, numbers_1.toBig)(0));\n// Liquidate\nconst tx = await hardhat_1.default.Diamond.connect(liquidator).liquidateInterest(userTwo.address, krAsset.address, this.collateral.address);\n// Should all be wiped\nconst interestAccruedAfterLiq = await hardhat_1.default.Diamond.kreskoAssetDebtInterest(userTwo.address, krAsset.address);\n(0, chai_1.expect)(interestAccruedAfterLiq.kissAmount).to.eq(0);\n(0, chai_1.expect)(interestAccruedAfterLiq.assetAmount).to.eq(0);\nconst accountCollateralAfter = await hardhat_1.default.Diamond.collateralDeposits(userTwo.address, this.collateral.address);\nconst event = await (0, lib_1.getInternalEvent)(tx, (0, events_1.EventContract)(), \&quot;InterestLiquidationOccurred\&quot;);\n// validate interest accrual changes\n(0, chai_1.expect)(accountCollateralAfter).to.equal(accountCollateralBefore.sub(event.collateralSent));\nconst liquidationIncentive = (0, hardhat_1.fromBig)((await hardhat_1.default.Diamond.liquidationIncentiveMultiplier()).rawValue);\nconst expectedCollateral = (accruedKissInterest / (0, hardhat_1.fromBig)(await this.collateral.getPrice(), 8)) * liquidationIncentive;\n// event validation\n(0, chai_1.expect)(event.account).to.equal(userTwo.address);\n(0, chai_1.expect)(event.liquidator).to.equal(liquidator.address);\n(0, chai_1.expect)(event.repayKreskoAsset).to.equal(krAsset.address);\n(0, chai_1.expect)(event.seizedCollateralAsset).to.equal(this.collateral.address);\n(0, chai_1.expect)((0, hardhat_1.fromBig)(event.collateralSent).toFixed(6)).to.equal(expectedCollateral.toFixed(6));\n(0, chai_1.expect)((0, hardhat_1.fromBig)(event.repayUSD)).to.closeTo(accruedKissInterest, 0.0001);\n// liquidator received collateral\n(0, chai_1.expect)(await this.collateral.contract.balanceOf(liquidator.address)).to.equal(event.collateralSent);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d6b1aeef-44e6-4237-a9b7-9aeaebf893a5&quot;,&quot;parentUUID&quot;:&quot;c05a09f6-9e6b-4937-b03d-0efd2129384e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can batch liquidate accrued interest of unhealthy account&quot;,&quot;fullTitle&quot;:&quot;Stability Rates #stability rate - liquidation can batch liquidate accrued interest of unhealthy account&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2148,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const KISS = await hardhat_1.default.ethers.getContract(\&quot;KISS\&quot;);\nawait KISS.connect(liquidator).approve(hardhat_1.default.Diamond.address, hardhat_1.default.ethers.constants.MaxUint256);\nawait this.collateral.setBalance(userTwo, depositAmount);\n// Deposit a bit more to cover the mints\nawait (0, collaterals_1.depositCollateral)({\n    asset: this.collateral,\n    amount: depositAmount,\n    user: userTwo,\n});\n// mint each krasset\nawait Promise.all(krAssets.map(krAsset =&gt; (0, krassets_1.mintKrAsset)({\n    asset: krAsset,\n    amount: mintAmount,\n    user: userTwo,\n})));\n// Up the asset prices\nconst newPrice = 15;\nkrAssets.map(asset =&gt; asset.setPrice(newPrice));\n// increase time so account is liquidatable\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.false;\nawait hardhat_network_helpers_1.time.increase(calculations_1.ONE_YEAR * 4);\n// should be liquidatable\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.true;\nconst interestKissTotal = (0, hardhat_1.fromBig)(await hardhat_1.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address));\n// Liquidator mints KISS\nawait (0, krassets_1.mintKrAsset)({\n    asset: KISS,\n    amount: interestKissTotal + 1,\n    user: liquidator,\n});\n// Wipe seized collateral balance before liquidation for easy comparison\nawait this.collateral.setBalance(liquidator, (0, numbers_1.toBig)(0));\n// Liquidate\nconst tx = await hardhat_1.default.Diamond.connect(liquidator).batchLiquidateInterest(userTwo.address, this.collateral.address);\nconst interestKissTotalAfter = (0, hardhat_1.fromBig)(await hardhat_1.default.Diamond.kreskoAssetDebtInterestTotal(userTwo.address));\n(0, chai_1.expect)(await hardhat_1.default.Diamond.isAccountLiquidatable(userTwo.address)).to.be.false;\nconst event = await (0, lib_1.getInternalEvent)(tx, (0, events_1.EventContract)(), \&quot;BatchInterestLiquidationOccurred\&quot;);\nconst repayUSD = (0, hardhat_1.fromBig)(event.repayUSD);\n// interest accrued changes\n(0, chai_1.expect)(interestKissTotalAfter).to.closeTo(interestKissTotal - (0, hardhat_1.fromBig)(event.repayUSD), 0.0001);\nconst liquidationIncentive = (0, hardhat_1.fromBig)((await hardhat_1.default.Diamond.liquidationIncentiveMultiplier()).rawValue);\nconst expectedCollateral = (repayUSD / (0, hardhat_1.fromBig)(await this.collateral.getPrice(), 8)) * liquidationIncentive;\n// event validation\n(0, chai_1.expect)(event.account).to.equal(userTwo.address);\n(0, chai_1.expect)(event.liquidator).to.equal(liquidator.address);\n(0, chai_1.expect)(event.seizedCollateralAsset).to.equal(this.collateral.address);\n(0, chai_1.expect)((0, hardhat_1.fromBig)(event.collateralSent)).to.closeTo(expectedCollateral, 0.0001);\n(0, chai_1.expect)(repayUSD).to.closeTo(interestKissTotal - interestKissTotalAfter, 0.0001);\n// liquidator received collateral\n(0, chai_1.expect)(await this.collateral.contract.balanceOf(liquidator.address)).to.equal(event.collateralSent);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;92520726-229a-4589-95c0-044c3c9e7932&quot;,&quot;parentUUID&quot;:&quot;c05a09f6-9e6b-4937-b03d-0efd2129384e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;b3557f36-530c-4f87-90b7-cf651e7beb40&quot;,&quot;f06c1b4e-58aa-4713-8cfb-0ebad28d7bfb&quot;,&quot;d6b1aeef-44e6-4237-a9b7-9aeaebf893a5&quot;,&quot;92520726-229a-4589-95c0-044c3c9e7932&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:5040,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:15000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:true,&quot;rootEmpty&quot;:true,&quot;_timeout&quot;:15000}],&quot;meta&quot;:{&quot;mocha&quot;:{&quot;version&quot;:&quot;10.1.0&quot;},&quot;mochawesome&quot;:{&quot;options&quot;:{&quot;quiet&quot;:false,&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;saveHtml&quot;:true,&quot;saveJson&quot;:true,&quot;consoleReporter&quot;:&quot;spec&quot;,&quot;useInlineDiffs&quot;:false,&quot;code&quot;:true},&quot;version&quot;:&quot;7.1.3&quot;},&quot;marge&quot;:{&quot;version&quot;:&quot;6.2.0&quot;}}}" data-config="{&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;reportDir&quot;:&quot;mochawesome-report&quot;,&quot;reportTitle&quot;:&quot;kresko-protocol&quot;,&quot;reportPageTitle&quot;:&quot;Mochawesome Report&quot;,&quot;inline&quot;:false,&quot;inlineAssets&quot;:false,&quot;cdn&quot;:false,&quot;charts&quot;:false,&quot;enableCharts&quot;:false,&quot;code&quot;:true,&quot;enableCode&quot;:true,&quot;autoOpen&quot;:false,&quot;overwrite&quot;:true,&quot;timestamp&quot;:false,&quot;ts&quot;:false,&quot;showPassed&quot;:true,&quot;showFailed&quot;:true,&quot;showPending&quot;:true,&quot;showSkipped&quot;:false,&quot;showHooks&quot;:&quot;failed&quot;,&quot;saveJson&quot;:true,&quot;saveHtml&quot;:true,&quot;dev&quot;:false,&quot;assetsDir&quot;:&quot;mochawesome-report/assets&quot;,&quot;jsonFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/mochawesome-report/mochawesome.json&quot;,&quot;htmlFile&quot;:&quot;/Users/pk/Projects/kresko-protocol/mochawesome-report/mochawesome.html&quot;}"><div id="report"></div><script src="assets/app.js"></script></body></html>